<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEDæ¼”å‡ºæ­Œè¯æ˜¾ç¤ºå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', Arial, sans-serif;
            background: #000;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* èƒŒæ™¯å®¹å™¨ */
        .background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* èƒŒæ™¯é®ç½©ç¡®ä¿æ­Œè¯å¯è¯»æ€§ */
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.7) 0%,
                rgba(0, 0, 0, 0.4) 30%,
                rgba(0, 0, 0, 0.4) 70%,
                rgba(0, 0, 0, 0.7) 100%
            );
        }

        /* æ­Œæ›²ä¿¡æ¯æ˜¾ç¤º */
        .song-info {
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
        }

        .song-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
            margin-bottom: 0.5rem;
        }

        .song-index {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .lyric-progress {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.5);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            margin-top: 0.3rem;
        }

        /* ä¸»æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ */
        .lyrics-display {
            position: absolute;
            top: 15%;
            left: 5%;
            right: 5%;
            height: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }

        /* CSSå˜é‡å®šä¹‰ */
        :root {
            --font-scale: 1.3;
            --lyric-color-primary: #ffffff;
            --lyric-color-secondary: rgba(255, 255, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        /* ä¸»é¢˜é¢„è®¾ */
        .theme-classic {
            --lyric-color-primary: #ffffff;
            --lyric-color-secondary: rgba(255, 255, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        .theme-gold {
            --lyric-color-primary: #ffd700;
            --lyric-color-secondary: rgba(255, 215, 0, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 215, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        .theme-blue {
            --lyric-color-primary: #00bfff;
            --lyric-color-secondary: rgba(0, 191, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(0, 191, 255, 0.8), 0 0 40px rgba(0, 191, 255, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(0, 191, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        .theme-rainbow {
            --lyric-color-primary: transparent;
            --lyric-color-secondary: rgba(255, 255, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 255, 255, 0.3), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        /* å½“å‰æ­Œè¯ */
        .current-lyric {
            font-size: calc(8rem * var(--font-scale));
            font-weight: 900;
            color: var(--lyric-color-primary);
            text-shadow: var(--lyric-shadow-primary);
            line-height: 1.2;
            margin-bottom: 2rem;
            opacity: 1;
            transform: scale(1);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* å½©è™¹ä¸»é¢˜çš„ç‰¹æ®Šæ•ˆæœ */
        .theme-rainbow .current-lyric {
            background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 3s ease-in-out infinite;
        }
        
        @keyframes rainbow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* ä¸‹ä¸€å¥æ­Œè¯ */
        .next-lyric {
            font-size: calc(4rem * var(--font-scale));
            font-weight: 600;
            color: var(--lyric-color-secondary);
            text-shadow: var(--lyric-shadow-secondary);
            line-height: 1.3;
            opacity: 0.8;
            transition: all 0.6s ease;
            min-height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ­Œè¯åˆ‡æ¢åŠ¨ç”» */
        .current-lyric.entering {
            animation: lyricEnter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes lyricEnter {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* --- ä¿®æ”¹ CSS --- */

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 80vh;
            /* ... èƒŒæ™¯å’Œæ»¤é•œæ ·å¼ä¿æŒä¸å˜ ... */
            
            /* ä¿®æ”¹ transform å’Œ transition */
            transform: translateX(450px);
            /* å…³é”®ä¼˜åŒ–ï¼šéæ¿€æ´»çŠ¶æ€ä¸‹éšè—ï¼Œåœæ­¢ GPU æ¸²æŸ“ */
            visibility: hidden; 
            /* å»¶è¿Ÿ visibility å˜åŒ–ï¼Œè®© transform åŠ¨ç”»å…ˆæ’­å®Œ */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), visibility 0s 0.4s;
            
            z-index: 1000;
            overflow-y: auto;
            
            /* ä¼˜åŒ–ï¼šåªæœ‰åœ¨é¢æ¿æ˜¾ç¤ºæ—¶æ‰è¿è¡Œå‘¼å¸åŠ¨ç”»ï¼Œå‡å°‘åå°æ¶ˆè€— */
            animation: none; 
        }

        /* è§¦å‘åŒºåŸŸæ‚¬åœ æˆ– é¢æ¿æ‚¬åœæ—¶ */
        .trigger-zone:hover + .control-panel,
        .control-panel:hover {
            transform: translateX(0);
            visibility: visible;
            /* æ˜¾ç¤ºæ—¶ç«‹å³å˜ä¸ºå¯è§ */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), visibility 0s;
            
            /* åªæœ‰æ˜¾ç¤ºæ—¶æ‰å¼€å¯åŠ¨ç”» */
            animation: liquidBreathing 8s ease-in-out infinite;
            
            /* ... æ¿€æ´»çŠ¶æ€çš„èƒŒæ™¯æ ·å¼ä¿æŒä¸å˜ ... */
        }

        /* æ­Œè¯æ¸²æŸ“ä¼˜åŒ– */
        .current-lyric {
            /* ... ä¿æŒåŸæœ‰æ ·å¼ ... */
            /* å…³é”®ä¼˜åŒ–ï¼šå‘Šè¯‰æµè§ˆå™¨è¿™äº›å±æ€§ä¼šå˜åŒ–ï¼Œæå‡åˆæˆå±‚æ€§èƒ½ */
            will-change: transform, opacity, text-shadow;
            /* ç¡¬ä»¶åŠ é€Ÿ */
            transform: translateZ(0); 
        }
        
        /* æ¶²æ€å‘¼å¸åŠ¨ç”» */
        @keyframes liquidBreathing {
            0%, 100% {
                box-shadow: 
                    0 0 60px rgba(255, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.2),
                    0 20px 60px rgba(0, 0, 0, 0.4),
                    0 5px 20px rgba(255, 255, 255, 0.05);
            }
            50% {
                box-shadow: 
                    0 0 80px rgba(255, 255, 255, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.15),
                    0 25px 70px rgba(0, 0, 0, 0.3),
                    0 8px 30px rgba(255, 255, 255, 0.08);
            }
        }

        /* è§¦å‘åŒºåŸŸ */
        .trigger-zone {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 999;
            cursor: pointer;
        }

        .trigger-zone:hover + .control-panel,
        .control-panel:hover {
            transform: translateX(0);
            visibility: visible; /* performance: show panel */
            animation: liquidBreathing 8s ease-in-out infinite; /* performance: only animate when visible */
            /* æ¿€æ´»çŠ¶æ€çš„æ¶²æ€ç»ç’ƒæ•ˆæœ */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.08) 25%,
                rgba(255, 255, 255, 0.04) 50%,
                rgba(0, 0, 0, 0.08) 75%,
                rgba(0, 0, 0, 0.15) 100%
            );
            backdrop-filter: blur(50px) saturate(2.0) brightness(1.3);
            -webkit-backdrop-filter: blur(50px) saturate(2.0) brightness(1.3);
            box-shadow: 
                0 0 100px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1),
                0 30px 80px rgba(0, 0, 0, 0.3),
                0 10px 40px rgba(255, 255, 255, 0.1);
        }

        /* æ§åˆ¶é¢æ¿å†…å®¹ */
        .panel-title {
            color: rgba(255, 255, 255, 0.95);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .file-upload-group {
            margin-bottom: 15px;
        }

        .upload-label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .file-input {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
        }

        .file-input::file-selector-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            cursor: pointer;
        }

        .folder-button {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .folder-button:hover {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .folder-button:active {
            transform: scale(0.95);
        }
        
        .compatibility-hint {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
            font-style: italic;
        }
        
        .compatibility-hint.warning {
            color: #ffa500;
        }

        /* å½“å‰æ’­æ”¾ä¿¡æ¯ */
        .current-song-info {
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.12) 0%,
                rgba(255, 255, 255, 0.04) 100%
            );
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 18px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .current-song-name {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .current-song-status {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .play-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.2) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .play-button:hover {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0.1) 100%
            );
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .play-button:disabled {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.02) 100%
            );
            border-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
            transform: none;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .time-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            min-width: 80px;
        }

        .progress-container {
            flex: 1;
            height: 8px;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 
                inset 0 1px 2px rgba(0, 0, 0, 0.1),
                0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 255, 255, 0.7) 50%,
                rgba(255, 255, 255, 0.9) 100%
            );
            border-radius: 6px;
            width: 0%;
            transform-origin: left;
            transition: width 0.2s ease;
            box-shadow: 
                0 0 12px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%
            );
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-container:hover .progress-bar {
            box-shadow: 
                0 0 16px rgba(255, 255, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .speed-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .speed-button, .font-size-button, .theme-button, .search-button, .play-mode-button {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .speed-button:hover, .font-size-button:hover, .theme-button:hover, .search-button:hover, .play-mode-button:hover {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.25) 0%,
                rgba(255, 255, 255, 0.1) 100%
            );
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .speed-button.active, .font-size-button.active, .theme-button.active, .play-mode-button.active {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.4) 0%,
                rgba(255, 255, 255, 0.2) 100%
            );
            border-color: rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 1);
            box-shadow: 
                0 4px 16px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.03) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 11px;
            font-weight: 400;
            outline: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                0 0 0 2px rgba(255, 255, 255, 0.1),
                0 2px 8px rgba(255, 255, 255, 0.05);
        }
        
        .search-results {
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .search-result-item {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }
        
        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 9px;
            margin-right: 8px;
        }
        
        .search-highlight {
            background: rgba(255, 255, 0, 0.3);
            color: #fff;
            font-weight: 600;
        }
        
        /* å†…è”å¿«æ·é”®æç¤ºæ ·å¼ */
        .shortcut-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 8px;
            margin-left: 4px;
            font-weight: 500;
        }
        
        /* é€šçŸ¥ç³»ç»Ÿ */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10001;
            max-width: 300px;
        }
        
        .notification {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 4px solid;
            color: white;
            font-size: 12px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            animation-fill-mode: forwards;
            opacity: 0;
            transform: translateX(100%);
        }
        
        .notification.success {
            border-left-color: #28a745;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        .notification.warning {
            border-left-color: #ffc107;
        }
        
        .notification.info {
            border-left-color: #17a2b8;
        }
        
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* æ’­æ”¾åˆ—è¡¨ */
        .playlist-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .playlist-header {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-count {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
        }

        .playlist {
            max-height: 200px;
            overflow-y: auto;
        }

        .playlist::-webkit-scrollbar {
            width: 4px;
        }

        .playlist::-webkit-scrollbar-track {
            background: transparent;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .song-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }
        
        .song-item[draggable="true"] {
            cursor: grab;
        }
        
        .song-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(5deg);
        }
        
        .song-item.drag-over {
            border-color: rgba(0, 123, 255, 0.8);
            background: rgba(0, 123, 255, 0.1);
        }
        
        .drag-handle {
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
            opacity: 0.6;
            position: relative;
        }
        
        .drag-handle:hover {
            background: rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.9);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .drag-handle:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        /* æ‹–æ‹½æ—¶çš„å…ƒç´ æ ·å¼ */
        .song-item.dragging {
            opacity: 0.7;
            cursor: grabbing;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            background: rgba(0, 123, 255, 0.2);
            border-color: rgba(0, 123, 255, 0.6);
        }
        
        /* æ‹–æ‹½ç›®æ ‡æ ·å¼ */
        .song-item.drag-over {
            border-color: rgba(0, 123, 255, 0.8);
            background: rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        /* æ’å…¥ä½ç½®æŒ‡ç¤ºå™¨ */
        .drop-indicator {
            height: 2px;
            background: #007bff;
            margin: 2px 0;
            border-radius: 1px;
            opacity: 0;
            transition: opacity 0.2s ease;
            position: relative;
        }
        
        .drop-indicator::before {
            content: '';
            position: absolute;
            left: -4px;
            top: -2px;
            width: 6px;
            height: 6px;
            background: #007bff;
            border-radius: 50%;
        }
        
        .drop-indicator::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -2px;
            width: 6px;
            height: 6px;
            background: #007bff;
            border-radius: 50%;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }

        /* æ¨¡å¼é€‰æ‹©å™¨æ ·å¼ */
        .mode-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            width: 65px;
            height: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .mode-selector:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .mode-selector:focus {
            outline: none;
            border-color: rgba(0, 123, 255, 0.8);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .mode-selector option {
            background: #333;
            color: white;
        }

        /* ä¸åŒæ¨¡å¼çš„è§†è§‰æŒ‡ç¤º */
        .song-item[data-user-mode="lyrics"] { border-left: 3px solid #28a745; }
        .song-item[data-user-mode="audio"] { border-left: 3px solid #ffc107; }
        .song-item[data-user-mode="sync"] { border-left: 3px solid #007bff; }
        .song-item[data-user-mode="auto"] { border-left: 3px solid #6c757d; }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .song-item.current {
            background: rgba(0, 123, 255, 0.3);
            border-color: rgba(0, 123, 255, 0.5);
        }

        .song-index-num {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            min-width: 20px;
            text-align: center;
        }

        .song-name {
            flex: 1;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-item.current .song-name {
            color: #fff;
            font-weight: 600;
        }

        .song-duration {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            min-width: 40px;
            text-align: right;
        }

        .song-controls {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .song-item:hover .song-controls {
            opacity: 1;
        }

        .song-control-btn {
            width: 16px;
            height: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .song-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.6);
        }
        
        .playlist-action-btn {
            width: 20px;
            height: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .playlist-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .sync-button {
            padding: 2px 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            transition: all 0.2s ease;
        }
        
        .sync-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ç©ºæ’­æ”¾åˆ—è¡¨ */
        .empty-playlist {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            padding: 20px;
            font-style: italic;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            z-index: 100;
        }

        .status-indicator.ready {
            background: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }

        .status-indicator.playing {
            background: #007bff;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); }
            to { transform: scale(1.3); box-shadow: 0 0 25px rgba(0, 123, 255, 0.8); }
        }


        /* é¼ æ ‡å…‰æ ‡æ§åˆ¶ */
        body.auto-hide-cursor {
            cursor: none;
        }
        
        /* æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 123, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 2rem;
            text-align: center;
        }
        
        .drag-overlay.active {
            display: flex;
        }
        
        .drag-hint {
            padding: 2rem;
            border: 3px dashed rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1920px) {
            .current-lyric {
                font-size: 6rem;
            }
            .next-lyric {
                font-size: 3rem;
            }
            .song-title {
                font-size: 2rem;
            }
        }

        @media (max-width: 1366px) {
            .current-lyric {
                font-size: 4rem;
            }
            .next-lyric {
                font-size: 2.5rem;
            }
            .song-title {
                font-size: 1.5rem;
            }
        }

        @media (max-height: 800px) {
            .lyrics-display {
                top: 12%;
                height: 55%;
            }
            .song-info {
                top: 1%;
            }
        }

        /* å…¨å±æ¨¡å¼ä¼˜åŒ– */
        @media (orientation: landscape) and (min-width: 1920px) {
            .current-lyric {
                font-size: 10rem;
            }
            .next-lyric {
                font-size: 5rem;
            }
            .song-title {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯å®¹å™¨ -->
    <div class="background-container" id="backgroundContainer">
        <div class="background-overlay"></div>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator" id="statusIndicator"></div>

    <!-- æ­Œæ›²ä¿¡æ¯ -->
    <div class="song-info" id="songInfo" style="display: none;">
        <div class="song-title" id="displaySongTitle">æœªé€‰æ‹©æ­Œæ›²</div>
        <div class="song-index" id="displaySongIndex" style="display: none;">0 / 0</div>
        <div class="lyric-progress" id="lyricProgress" style="display: none;">
            <span id="lyricProgressText" style="display: none;">1 / 1</span>
        </div>
    </div>

    <!-- ä¸»æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="lyrics-display">
        <div class="current-lyric" id="currentLyric">è¯·ä¸Šä¼ LRCæ­Œè¯æ–‡ä»¶</div>
        <div class="next-lyric" id="nextLyric">å¼€å§‹ä½ çš„æ¼”å‡º</div>
    </div>

    
    <!-- æ‹–æ‹½ä¸Šä¼ è¦†ç›–å±‚ -->
    <div class="drag-overlay" id="dragOverlay">
        <div class="drag-hint">
            ğŸ¥ æ”¾å¼€æ–‡ä»¶åˆ°è¿™é‡Œ<br>
            <small>æ”¯æŒ LRC æ­Œè¯æ–‡ä»¶å’ŒéŸ³é¢‘æ–‡ä»¶<br>å¯æ‹–æ‹½æ–‡ä»¶æˆ–ä½¿ç”¨ğŸ“æŒ‰é’®é€‰æ‹©æ–‡ä»¶å¤¹</small>
        </div>
    </div>
    
    <!-- é€šçŸ¥å®¹å™¨ -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- è§¦å‘åŒºåŸŸ -->
    <div class="trigger-zone"></div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="panel-title">ğŸµ æ¼”å‡ºæ§åˆ¶å°<span class="shortcut-hint">Esc å…¨å±</span></div>
        
        <div class="file-upload-group">
            <label class="upload-label">æ­Œè¯æ–‡ä»¶ (æ”¯æŒå¤šé€‰LRC)<span class="shortcut-hint">æ‹–æ‹½ä¸Šä¼  | ğŸ“æ–‡ä»¶å¤¹</span></label>
            <div style="display: flex; gap: 5px;">
                <input type="file" id="lrcFile" accept=".lrc,.txt" class="file-input" multiple />
                <button class="folder-button" id="lrcFolderBtn" title="é€‰æ‹©æ–‡ä»¶å¤¹åŠ è½½">ğŸ“</button>
            </div>
            <input type="file" id="lrcFolder" webkitdirectory directory style="display: none;" />
            <div class="compatibility-hint" id="lrcFolderHint" style="display: none;"></div>
        </div>
        
        <div class="file-upload-group">
            <label class="upload-label">éŸ³é¢‘æ–‡ä»¶ (æ”¯æŒå¤šé€‰éŸ³é¢‘)<span class="shortcut-hint">æ‹–æ‹½ä¸Šä¼  | ğŸ“æ–‡ä»¶å¤¹</span></label>
            <div style="display: flex; gap: 5px;">
                <input type="file" id="audioFile" accept="audio/*,video/mp4,.mp4" class="file-input" multiple />
                <button class="folder-button" id="audioFolderBtn" title="é€‰æ‹©æ–‡ä»¶å¤¹åŠ è½½">ğŸ“</button>
            </div>
            <input type="file" id="audioFolder" webkitdirectory directory style="display: none;" />
            <div class="compatibility-hint" id="audioFolderHint" style="display: none;"></div>
        </div>

        <div class="file-upload-group">
            <label class="upload-label">èƒŒæ™¯å›¾ç‰‡<span class="shortcut-hint">æ‹–æ‹½ä¸Šä¼ </span></label>
            <input type="file" id="backgroundFile" accept="image/*" class="file-input" />
        </div>

        <div class="current-song-info" id="currentSongInfo" style="display: none;">
            <div class="current-song-name" id="currentSongName">æœªé€‰æ‹©æ­Œæ›²</div>
            <div class="current-song-status" id="currentSongStatus">å‡†å¤‡æ’­æ”¾</div>
        </div>

        <div class="controls-row">
            <button class="play-button" id="playButton" disabled title="æ’­æ”¾/æš‚åœ (ç©ºæ ¼é”®)">â–¶</button>
            <div class="time-info">
                <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
            </div>
            <div class="progress-container" id="progressContainer" title="ç‚¹å‡»è·³è½¬ | â†â†’ å‰å5ç§’">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="speed-controls">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">é€Ÿåº¦:</span>
            <button class="speed-button" data-speed="0.5">0.5Ã—</button>
            <button class="speed-button active" data-speed="1">1Ã—</button>
            <button class="speed-button" data-speed="1.5">1.5Ã—</button>
            <button class="speed-button" data-speed="2">2Ã—</button>
        </div>
        
        <div class="font-size-controls" style="margin-bottom: 15px;">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">å­—ä½“å¤§å°<span class="shortcut-hint">+/-</span>:</span>
            <button class="font-size-button" data-font-size="0.7">S</button>
            <button class="font-size-button" data-font-size="1">M</button>
            <button class="font-size-button active" data-font-size="1.3">L</button>
            <button class="font-size-button" data-font-size="1.6">XL</button>
            <button class="font-size-button" data-font-size="2">XXL</button>
        </div>
        
        <div class="theme-controls" style="margin-bottom: 15px;">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">æ­Œè¯ä¸»é¢˜<span class="shortcut-hint">T</span>:</span>
            <button class="theme-button active" data-theme="classic">ç»å…¸</button>
            <button class="theme-button" data-theme="gold">é»„é‡‘</button>
            <button class="theme-button" data-theme="blue">è“è‰²</button>
            <button class="theme-button" data-theme="rainbow">å½©è™¹</button>
        </div>
        
        <div class="play-mode-controls" style="margin-bottom: 15px;">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">æ’­æ”¾æ¨¡å¼<span class="shortcut-hint">M</span>:</span>
            <button class="play-mode-button active" data-mode="list" title="åˆ—è¡¨æ’­æ”¾">ğŸ“‹</button>
            <button class="play-mode-button" data-mode="loop" title="åˆ—è¡¨å¾ªç¯">ğŸ”</button>
            <button class="play-mode-button" data-mode="single" title="å•æ›²å¾ªç¯">ğŸ”‚</button>
            <button class="play-mode-button" data-mode="random" title="éšæœºæ’­æ”¾">ğŸ”€</button>
        </div>
        
        <div class="sync-controls" style="margin-bottom: 15px; display: none;" id="syncControls">
            <div style="color: rgba(255,255,255,0.6); font-size: 10px; margin-bottom: 5px;">åŒæ­¥æ ¡å‡†<span class="shortcut-hint">[ ]</span> (ç§’):</div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <button class="sync-button" data-offset="-1">-1s</button>
                <button class="sync-button" data-offset="-0.1">-0.1s</button>
                <span id="offsetDisplay" style="color: #fff; font-size: 11px; min-width: 40px; text-align: center;">0.0s</span>
                <button class="sync-button" data-offset="0.1">+0.1s</button>
                <button class="sync-button" data-offset="1">+1s</button>
                <button class="sync-button" id="resetOffset">é‡ç½®</button>
            </div>
        </div>
        
        <div class="search-controls" style="margin-bottom: 15px;">
            <div style="color: rgba(255,255,255,0.6); font-size: 10px; margin-bottom: 5px;">æœç´¢æ­Œè¯<span class="shortcut-hint">F</span>:</div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="text" id="lyricsSearch" placeholder="æœç´¢å½“å‰æ­Œæ›²æ­Œè¯..." class="search-input" />
                <button class="search-button" id="searchButton">ğŸ”</button>
                <button class="search-button" id="clearSearch">Ã—</button>
            </div>
            <div class="search-results" id="searchResults" style="display: none;"></div>
        </div>


        <div class="playlist-section">
            <div class="playlist-header">
                <span>æ’­æ”¾åˆ—è¡¨<span class="shortcut-hint">â†‘â†“ åˆ‡æ¢ | 1-9 å¿«é€‰</span></span>
                <span class="playlist-count" id="playlistCount">0 é¦–æ­Œæ›²</span>
            </div>
            <div class="playlist-actions" style="margin-bottom: 10px; display: flex; gap: 5px;">
                <button class="playlist-action-btn" id="sortPlaylist" title="æŒ‰åç§°æ’åº">ğŸ”¤</button>
                <button class="playlist-action-btn" id="exportPlaylist" title="å¯¼å‡ºæ’­æ”¾åˆ—è¡¨">ğŸ’¾</button>
                <button class="playlist-action-btn" id="importPlaylist" title="å¯¼å…¥æ’­æ”¾åˆ—è¡¨">ğŸ“‚</button>
                <button class="playlist-action-btn" id="clearPlaylist" title="æ¸…ç©ºæ’­æ”¾åˆ—è¡¨">ğŸ—‘ï¸</button>
                <input type="file" id="playlistFile" accept=".json" style="display: none;" />
            </div>
            <div class="playlist" id="playlist">
                <div class="empty-playlist">è¿˜æ²¡æœ‰æ­Œæ›²ï¼Œè¯·ä¸Šä¼ LRCæ–‡ä»¶</div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨å‘½åç©ºé—´é¿å…å…¨å±€å˜é‡æ±¡æŸ“
        const LyricsPlayerApp = {
            player: null // æ’­æ”¾å™¨å®ä¾‹
        };

        // è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ
        const DEBUG = true; // ç”Ÿäº§ç¯å¢ƒè®¾ç½®ä¸º false
        
        function log(...args) {
            if (DEBUG) {
                console.log(...args);
            }
        }
        
        function warn(...args) {
            if (DEBUG) {
                console.warn(...args);
            }
        }
        
        function error(...args) {
            // é”™è¯¯ä¿¡æ¯æ€»æ˜¯æ˜¾ç¤º
            console.error(...args);
        }

        class LEDLyricsPlayer {
            constructor() {
                this.playButton = document.getElementById('playButton');
                this.progressBar = document.getElementById('progressBar');
                this.progressContainer = document.getElementById('progressContainer');
                this.currentTimeSpan = document.getElementById('currentTime');
                this.totalTimeSpan = document.getElementById('totalTime');
                this.currentLyricEl = document.getElementById('currentLyric');
                this.nextLyricEl = document.getElementById('nextLyric');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.backgroundContainer = document.getElementById('backgroundContainer');
                this.playlist = document.getElementById('playlist');
                this.playlistCount = document.getElementById('playlistCount');
                this.songInfo = document.getElementById('songInfo');
                this.displaySongTitle = document.getElementById('displaySongTitle');
                this.displaySongIndex = document.getElementById('displaySongIndex');
                this.currentSongInfo = document.getElementById('currentSongInfo');
                this.currentSongName = document.getElementById('currentSongName');
                this.currentSongStatus = document.getElementById('currentSongStatus');
                
                this.songs = []; // æ­Œæ›²åˆ—è¡¨
                this.currentSongIndex = -1; // å½“å‰æ’­æ”¾æ­Œæ›²ç´¢å¼•
                this.currentLyricIndex = -1; // å½“å‰æ­Œè¯ç´¢å¼•
                this.isPlaying = false;
                this.currentTime = 0;
                this.playbackSpeed = 1;
                this.animationId = null;
                this.startTime = null;
                this.pausedTime = 0;
                this.lastProgressUpdate = 0;
                this.lastLyricsUpdate = 0;
                this.lastLyricSearchIndex = 0; // æ–°å¢ï¼šè®°å½•ä¸Šæ¬¡æŸ¥æ‰¾åˆ°çš„ç´¢å¼•
                this.lastLyricSearchTime = 0;  // æ–°å¢ï¼šè®°å½•ä¸Šæ¬¡æŸ¥æ‰¾çš„æ—¶é—´
                this.lyricsCache = new Map();
                
                // éŸ³é¢‘æ’­æ”¾æ”¯æŒ
                this.audioElement = null;
                this.audioMode = false; // false: çº¯æ­Œè¯æ¨¡å¼, true: éŸ³é¢‘åŒæ­¥æ¨¡å¼
                this.audioOffset = 0; // éŸ³é¢‘ä¸æ­Œè¯çš„æ—¶é—´åç§»
                this.fontScale = 1.3; // å­—ä½“ç¼©æ”¾æ¯”ä¾‹
                this.currentTheme = 'classic'; // å½“å‰ä¸»é¢˜
                this.searchResults = []; // æœç´¢ç»“æœ
                this.objectUrls = new Set(); // è·Ÿè¸ªåˆ›å»ºçš„URLå¯¹è±¡
                this.eventListeners = new Map(); // è·Ÿè¸ªäº‹ä»¶ç›‘å¬å™¨
                this.eventListenerRegistry = new Map(); // å¢å¼ºçš„äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œè¡¨
                this.timers = new Set(); // è·Ÿè¸ªå®šæ—¶å™¨
                this.cursorTimeout = null; // å…‰æ ‡éšè—å®šæ—¶å™¨
                
                // æ’­æ”¾æ¨¡å¼
                this.playMode = 'loop'; // 'list': åˆ—è¡¨æ’­æ”¾, 'loop': åˆ—è¡¨å¾ªç¯, 'single': å•æ›²å¾ªç¯, 'random': éšæœºæ’­æ”¾
                this.playHistory = []; // éšæœºæ’­æ”¾å†å²è®°å½•
                
                // é˜²æ­¢å±å¹•ç†„å±
                this.wakeLock = null; // Screen Wake Lock API
                this.wakeLockSupported = 'wakeLock' in navigator; // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                
                // æ‹–æ‹½çŠ¶æ€
                this.draggedElement = null; // å½“å‰æ‹–æ‹½çš„å…ƒç´ 
                
                // æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥
                this.checkBrowserCompatibility();
                
                // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
                
                // é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬å™¨
                document.addEventListener('visibilitychange', () => {
                    this.handleVisibilityChange();
                });
                
                this.initEventListeners();
                this.initCursorHiding();
                this.initDragAndDrop();
            }

            // æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥
            checkBrowserCompatibility() {
                // æ£€æŸ¥æ–‡ä»¶å¤¹é€‰æ‹©APIæ”¯æŒ
                const folderSupported = 'webkitdirectory' in document.createElement('input');
                
                const lrcHint = document.getElementById('lrcFolderHint');
                const audioHint = document.getElementById('audioFolderHint');
                
                if (!folderSupported) {
                    // ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©
                    const warningText = 'æ³¨æ„ï¼šå½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨åŸºäºChromiumçš„æµè§ˆå™¨ï¼ˆå¦‚Chromeã€Edgeï¼‰';
                    
                    if (lrcHint) {
                        lrcHint.textContent = warningText;
                        lrcHint.className = 'compatibility-hint warning';
                        lrcHint.style.display = 'block';
                    }
                    
                    if (audioHint) {
                        audioHint.textContent = warningText;
                        audioHint.className = 'compatibility-hint warning';
                        audioHint.style.display = 'block';
                    }
                    
                    // ç¦ç”¨æ–‡ä»¶å¤¹æŒ‰é’®
                    const lrcFolderBtn = document.getElementById('lrcFolderBtn');
                    const audioFolderBtn = document.getElementById('audioFolderBtn');
                    
                    if (lrcFolderBtn) {
                        lrcFolderBtn.disabled = true;
                        lrcFolderBtn.title = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½';
                    }
                    
                    if (audioFolderBtn) {
                        audioFolderBtn.disabled = true;
                        audioFolderBtn.title = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½';
                    }
                } else {
                    // æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œæ˜¾ç¤ºå…¼å®¹æ€§æç¤º
                    const infoText = 'æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹© (Chrome/Edge/Operaç­‰æµè§ˆå™¨)';
                    
                    if (lrcHint) {
                        lrcHint.textContent = infoText;
                        lrcHint.className = 'compatibility-hint';
                        lrcHint.style.display = 'block';
                    }
                    
                    if (audioHint) {
                        audioHint.textContent = infoText;
                        audioHint.className = 'compatibility-hint';
                        audioHint.style.display = 'block';
                    }
                }
            }

            // å¢å¼ºçš„äº‹ä»¶ç›‘å¬å™¨ç®¡ç†æ–¹æ³•
            addEventListenerTracked(element, eventType, handler, options = {}) {
                const key = `${element.constructor.name}_${eventType}_${Date.now()}_${Math.random()}`;
                
                // å­˜å‚¨äº‹ä»¶ç›‘å¬å™¨ä¿¡æ¯
                this.eventListenerRegistry.set(key, {
                    element,
                    eventType,
                    handler,
                    options
                });
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                element.addEventListener(eventType, handler, options);
                
                return key; // è¿”å›keyç”¨äºåç»­ç§»é™¤
            }

            removeEventListenerTracked(key) {
                const listenerInfo = this.eventListenerRegistry.get(key);
                if (listenerInfo) {
                    const { element, eventType, handler, options } = listenerInfo;
                    element.removeEventListener(eventType, handler, options);
                    this.eventListenerRegistry.delete(key);
                    return true;
                }
                return false;
            }

            removeAllEventListeners() {
                for (const [key, listenerInfo] of this.eventListenerRegistry) {
                    const { element, eventType, handler, options } = listenerInfo;
                    try {
                        element.removeEventListener(eventType, handler, options);
                    } catch (error) {
                        warn('ç§»é™¤äº‹ä»¶ç›‘å¬å™¨æ—¶å‡ºé”™:', error);
                    }
                }
                this.eventListenerRegistry.clear();
            }

            initCursorHiding() {
                const showCursor = () => {
                    document.body.classList.remove('auto-hide-cursor');
                    if (this.cursorTimeout) {
                        clearTimeout(this.cursorTimeout);
                    }
                    this.cursorTimeout = setTimeout(() => {
                        document.body.classList.add('auto-hide-cursor');
                    }, 3000);
                    this.timers.add(this.cursorTimeout);
                };

                // ä½¿ç”¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨è·Ÿè¸ªç³»ç»Ÿ
                this.addEventListenerTracked(document, 'mousemove', showCursor);
                this.addEventListenerTracked(document, 'mousedown', showCursor);
                
                // å­˜å‚¨äº‹ä»¶ç›‘å¬å™¨å¼•ç”¨ç”¨äºæ¸…ç†ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
                this.eventListeners.set('mousemove', showCursor);
                this.eventListeners.set('mousedown', showCursor);
                
                // åˆå§‹æ˜¾ç¤ºå…‰æ ‡
                showCursor();
            }


            initDragAndDrop() {
                const dragOverlay = document.getElementById('dragOverlay');
                let dragCounter = 0;
                
                // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
                const preventDefaultHandler = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                };
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    this.addEventListenerTracked(document, eventName, preventDefaultHandler);
                });
                
                // æ‹–æ‹½è¿›å…¥
                const dragEnterHandler = (e) => {
                    dragCounter++;
                    if (e.dataTransfer.types.includes('Files')) {
                        dragOverlay.classList.add('active');
                    }
                };
                this.addEventListenerTracked(document, 'dragenter', dragEnterHandler);
                
                // æ‹–æ‹½ç¦»å¼€
                const dragLeaveHandler = (e) => {
                    dragCounter--;
                    if (dragCounter <= 0) {
                        dragCounter = 0;
                        dragOverlay.classList.remove('active');
                    }
                };
                this.addEventListenerTracked(document, 'dragleave', dragLeaveHandler);
                
                // æ”¾å¼€æ–‡ä»¶
                const dropHandler = (e) => {
                    dragCounter = 0;
                    dragOverlay.classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        this.handleDroppedFiles(files);
                    }
                };
                this.addEventListenerTracked(document, 'drop', dropHandler);
            }
            
            handleDroppedFiles(files) {
                const lrcFiles = [];
                const audioFiles = [];
                const imageFiles = [];
                
                files.forEach(file => {
                    const ext = file.name.toLowerCase().split('.').pop();
                    if (ext === 'lrc' || ext === 'txt') {
                        lrcFiles.push(file);
                    } else if (['mp3', 'wav', 'flac', 'ogg', 'aac', 'm4a', 'mp4'].includes(ext)) {
                        audioFiles.push(file);
                    } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                        imageFiles.push(file);
                    }
                });
                
                // å¤„ç†æ­Œè¯æ–‡ä»¶
                if (lrcFiles.length > 0) {
                    log('æ‹–æ‹½ä¸Šä¼ æ­Œè¯æ–‡ä»¶:', lrcFiles.length, 'ä¸ª');
                    this.loadLrcFiles(lrcFiles);
                }
                
                // å¤„ç†éŸ³é¢‘æ–‡ä»¶
                if (audioFiles.length > 0) {
                    log('æ‹–æ‹½ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶:', audioFiles.length, 'ä¸ª');
                    this.loadAudioFiles(audioFiles);
                }
                
                // å¤„ç†èƒŒæ™¯å›¾ç‰‡
                if (imageFiles.length > 0) {
                    log('æ‹–æ‹½ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡:', imageFiles[0].name);
                    this.loadBackgroundImage(imageFiles[0]);
                }
            }

            initEventListeners() {
                // æ–‡ä»¶ä¸Šä¼ 
                document.getElementById('lrcFile').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    log('é€‰æ‹©äº†', files.length, 'ä¸ªæ–‡ä»¶');
                    this.loadLrcFiles(files);
                });

                document.getElementById('audioFile').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    log('é€‰æ‹©äº†', files.length, 'ä¸ªéŸ³é¢‘æ–‡ä»¶');
                    this.loadAudioFiles(files);
                });
                
                document.getElementById('backgroundFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        log('å¼€å§‹åŠ è½½èƒŒæ™¯å›¾ç‰‡:', file.name);
                        this.loadBackgroundImage(file);
                    }
                });

                // æ–‡ä»¶å¤¹é€‰æ‹©
                document.getElementById('lrcFolderBtn').addEventListener('click', () => {
                    document.getElementById('lrcFolder').click();
                });

                document.getElementById('lrcFolder').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    this.processFolderFiles(files, 'lyrics');
                });

                document.getElementById('audioFolderBtn').addEventListener('click', () => {
                    document.getElementById('audioFolder').click();
                });

                document.getElementById('audioFolder').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    this.processFolderFiles(files, 'audio');
                });

                // æ’­æ”¾æ§åˆ¶
                this.playButton.addEventListener('click', () => {
                    this.togglePlay();
                });

                // è¿›åº¦æ¡æ§åˆ¶
                this.progressContainer.addEventListener('click', (e) => {
                    this.seekTo(e);
                });

                // é€Ÿåº¦æ§åˆ¶
                document.querySelectorAll('.speed-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setPlaybackSpeed(parseFloat(e.target.dataset.speed));
                    });
                });
                
                // å­—ä½“å¤§å°æ§åˆ¶
                document.querySelectorAll('.font-size-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setFontScale(parseFloat(e.target.dataset.fontSize));
                    });
                });
                
                // ä¸»é¢˜æ§åˆ¶
                document.querySelectorAll('.theme-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setTheme(e.target.dataset.theme);
                    });
                });
                
                // æ’­æ”¾æ¨¡å¼æ§åˆ¶
                document.querySelectorAll('.play-mode-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setPlayMode(e.target.dataset.mode);
                    });
                });
                
                
                // æœç´¢åŠŸèƒ½
                const searchInput = document.getElementById('lyricsSearch');
                const searchButton = document.getElementById('searchButton');
                const clearSearch = document.getElementById('clearSearch');
                
                searchInput.addEventListener('input', (e) => {
                    this.searchLyrics(e.target.value);
                });
                
                searchButton.addEventListener('click', () => {
                    this.searchLyrics(searchInput.value);
                });
                
                clearSearch.addEventListener('click', () => {
                    searchInput.value = '';
                    this.clearSearch();
                });
                
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.searchLyrics(searchInput.value);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        searchInput.value = '';
                        this.clearSearch();
                    }
                });
                
                // æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
                document.getElementById('exportPlaylist').addEventListener('click', () => {
                    this.exportPlaylist();
                });
                
                document.getElementById('sortPlaylist').addEventListener('click', () => {
                    this.sortPlaylist();
                });
                
                document.getElementById('importPlaylist').addEventListener('click', () => {
                    document.getElementById('playlistFile').click();
                });
                
                document.getElementById('clearPlaylist').addEventListener('click', () => {
                    this.clearPlaylist();
                });
                
                document.getElementById('playlistFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.importPlaylist(file);
                        e.target.value = ''; // é‡ç½®æ–‡ä»¶é€‰æ‹©
                    }
                });
                
                // åŒæ­¥æ ¡å‡†åŠŸèƒ½
                document.querySelectorAll('.sync-button').forEach(button => {
                    if (button.id === 'resetOffset') {
                        button.addEventListener('click', () => {
                            this.resetOffset();
                        });
                    } else {
                        button.addEventListener('click', (e) => {
                            const offset = parseFloat(e.target.dataset.offset);
                            this.adjustOffset(offset);
                        });
                    }
                });

                // é”®ç›˜æ§åˆ¶
                document.addEventListener('keydown', (e) => {
                    // å¦‚æœæ­£åœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å¤„ç†å¿«æ·é”®
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.togglePlay();
                    } else if (e.code === 'ArrowLeft' && !e.ctrlKey) {
                        e.preventDefault();
                        this.seek(-5);
                    } else if (e.code === 'ArrowRight' && !e.ctrlKey) {
                        e.preventDefault();
                        this.seek(5);
                    } else if (e.code === 'ArrowUp' && !e.ctrlKey) {
                        e.preventDefault();
                        this.switchToPreviousSong();
                    } else if (e.code === 'ArrowDown' && !e.ctrlKey) {
                        e.preventDefault();
                        this.switchToNextSong();
                    } else if (e.code === 'ArrowLeft' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.previousLyric()) {
                            this.showLyricJumpNotification('ä¸Šä¸€å¥');
                        }
                    } else if (e.code === 'ArrowRight' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.nextLyric()) {
                            this.showLyricJumpNotification('ä¸‹ä¸€å¥');
                        }
                    } else if (e.code === 'ArrowUp' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.firstLyric()) {
                            this.showLyricJumpNotification('ç¬¬ä¸€å¥');
                        }
                    } else if (e.code === 'ArrowDown' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.lastLyric()) {
                            this.showLyricJumpNotification('æœ€åä¸€å¥');
                        }
                    } else if (e.code === 'Escape') {
                        this.toggleFullscreen();
                    } else if (e.key === '=' || e.key === '+') {
                        e.preventDefault();
                        this.adjustFontSize(0.1);
                    } else if (e.key === '-' || e.key === '_') {
                        e.preventDefault();
                        this.adjustFontSize(-0.1);
                    } else if (e.key === 't' || e.key === 'T') {
                        e.preventDefault();
                        this.switchTheme();
                    } else if (e.key === 'm' || e.key === 'M') {
                        e.preventDefault();
                        this.switchPlayMode();
                    } else if (e.key === 'f' || e.key === 'F') {
                        e.preventDefault();
                        document.getElementById('lyricsSearch').focus();
                    } else if (e.key === '[') {
                        e.preventDefault();
                        this.adjustOffset(-0.1);
                    } else if (e.key === ']') {
                        e.preventDefault();
                        this.adjustOffset(0.1);
                    } else if (e.code.startsWith('Digit')) {
                        const num = parseInt(e.code.replace('Digit', ''));
                        if (num >= 1 && num <= 9) {
                            e.preventDefault();
                            this.switchToSong(num - 1);
                            // æ•°å­—é”®å¿«é€Ÿé€‰æ­Œåè‡ªåŠ¨æ’­æ”¾
                            const timerId = setTimeout(() => {
                                this.play();
                            }, 100);
                            this.addTimer(timerId);
                        }
                    }
                });
            }

            loadLrcFiles(files) {
                let loadedCount = 0;
                const totalFiles = files.length;

                files.forEach(file => {
                    if (file.name.toLowerCase().endsWith('.lrc') || file.name.toLowerCase().endsWith('.txt')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const lyrics = this.parseLrc(e.target.result);
                                const song = {
                                    name: file.name.replace(/\.[^/.]+$/, ""),
                                    lyrics: lyrics,
                                    duration: lyrics.length > 0 ? lyrics[lyrics.length - 1].time + 5 : 300, // é»˜è®¤5åˆ†é’Ÿ
                                    mode: 'lyrics' // çº¯æ­Œè¯æ¨¡å¼
                                };
                                this.addSong(song);
                                
                                loadedCount++;
                                log(`æ­Œæ›² ${loadedCount}/${totalFiles} åŠ è½½å®Œæˆ:`, song.name);
                                if (this.showNotification) {
                                    this.showNotification(`åŠ è½½æ­Œæ›²: ${song.name}`, 'success');
                                }
                            } catch (error) {
                                console.error('æ­Œè¯è§£æé”™è¯¯:', file.name, error);
                                if (this.showNotification) {
                                    this.showNotification(`æ­Œè¯è§£æå¤±è´¥: ${file.name} - ${error.message}`, 'error');
                                }
                                loadedCount++;
                            }
                        };
                        reader.onerror = (error) => {
                            console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', file.name, error);
                            if (this.showNotification) {
                                this.showNotification(`æ–‡ä»¶è¯»å–å¤±è´¥: ${file.name}`, 'error');
                            }
                            loadedCount++;
                        };
                        reader.readAsText(file, 'UTF-8');
                    } else {
                        warn('è·³è¿‡éLRCæ–‡ä»¶:', file.name);
                        loadedCount++;
                    }
                });
                
                // åŠ è½½å®Œæˆåè‡ªåŠ¨æ’åº
                const timerId = setTimeout(() => {
                    this.sortPlaylist();
                    this.updatePlaylist();
                    this.showNotification('æ­Œæ›²åˆ—è¡¨å·²è‡ªåŠ¨æ’åº', 'success');
                }, files.length * 20); // æ ¹æ®æ–‡ä»¶æ•°é‡è°ƒæ•´å»¶è¿Ÿ
                this.addTimer(timerId);
            }

            loadAudioFiles(files) {
                let loadedCount = 0;
                let matchedCount = 0;

                files.forEach(file => {
                    const ext = file.name.toLowerCase().split('.').pop();
                    if (['mp3', 'wav', 'flac', 'ogg', 'aac', 'm4a', 'mp4'].includes(ext)) {
                        loadedCount++;
                        const fileName = file.name.replace(/\.[^/.]+$/, "");
                        const matchedSong = this.findMatchingSong(fileName);

                        if (matchedSong) {
                            matchedCount++;
                            // å…³è”éŸ³é¢‘æ–‡ä»¶
                            matchedSong.audioFile = file;
                            this.updateSongMode(matchedSong);
                            log(`éŸ³é¢‘æ–‡ä»¶ "${file.name}" æ­£åœ¨å…³è”åˆ°æ­Œæ›² "${matchedSong.name}"`);

                            // --- è½»é‡çº§é¢„åŠ è½½ä»¥è·å–æ—¶é•¿ ---
                            const tempAudio = new Audio();
                            const tempUrl = URL.createObjectURL(file);
                            
                            tempAudio.addEventListener('loadedmetadata', () => {
                                log(`è·å–åˆ° "${file.name}" çš„ç²¾ç¡®æ—¶é•¿: ${tempAudio.duration}`);
                                matchedSong.duration = tempAudio.duration;
                                // é”€æ¯ä¸´æ—¶å¯¹è±¡
                                tempAudio.src = '';
                                URL.revokeObjectURL(tempUrl);
                                // æ—¶é•¿æ›´æ–°åï¼Œåˆ·æ–°æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º
                                this.updatePlaylist();
                            }, { once: true });
                            
                            tempAudio.addEventListener('error', () => {
                                warn(`é¢„åŠ è½½ "${file.name}" æ—¶é•¿å¤±è´¥`);
                                URL.revokeObjectURL(tempUrl);
                            }, { once: true });

                            tempAudio.src = tempUrl;
                            // --- é¢„åŠ è½½ç»“æŸ ---

                        } else {
                            warn(`éŸ³é¢‘æ–‡ä»¶ "${file.name}" æ— æ³•åŒ¹é…åˆ°æ­Œè¯æ–‡ä»¶ï¼Œå·²è·³è¿‡ã€‚`);
                            this.showNotification(`éŸ³é¢‘ "${file.name}" æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œè¯`, 'warning');
                        }
                    }
                });

                if (loadedCount > 0) {
                    this.showNotification(`å¤„ç†äº† ${loadedCount} ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼ŒæˆåŠŸå…³è” ${matchedCount} ä¸ª`, 'info');
                    const timerId = setTimeout(() => {
                        this.sortPlaylist();
                        this.updatePlaylist();
                        this.showMatchingReport();
                    }, 500); // å»¶è¿Ÿä»¥ç­‰å¾…å¯èƒ½çš„å…ƒæ•°æ®åŠ è½½
                    this.addTimer(timerId);
                }
            }

            
            updateAudioMode() {
                const syncControls = document.getElementById('syncControls');
                
                if (this.currentSongIndex >= 0 && this.currentSongIndex < this.songs.length) {
                    const currentSong = this.songs[this.currentSongIndex];
                    const songMode = this.getSongMode(currentSong);
                    
                    switch(songMode) {
                        case 'sync':
                            this.currentSongStatus.textContent = 'åŒæ­¥æ¨¡å¼ (éŸ³é¢‘+æ­Œè¯)';
                            syncControls.style.display = 'block';
                            this.updateOffsetDisplay();
                            break;
                        case 'audio':
                            this.currentSongStatus.textContent = 'çº¯éŸ³é¢‘æ¨¡å¼';
                            syncControls.style.display = 'none';
                            break;
                        case 'lyrics':
                            this.currentSongStatus.textContent = 'çº¯æ­Œè¯æ¨¡å¼ (æ‰‹åŠ¨æ§åˆ¶)';
                            syncControls.style.display = 'none';
                            break;
                        default:
                            this.currentSongStatus.textContent = this.isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ';
                            syncControls.style.display = 'none';
                    }
                } else {
                    this.currentSongStatus.textContent = 'å‡†å¤‡æ’­æ”¾';
                    syncControls.style.display = 'none';
                }
            }
            
            syncWithAudio() {
                if (this.audioElement && this.audioMode) {
                    this.currentTime = this.audioElement.currentTime + this.audioOffset;
                    // å¼ºåˆ¶æ›´æ–°è¿›åº¦æ¡å’Œæ­Œè¯
                    requestAnimationFrame(() => {
                        this.updateProgress();
                        this.updateLyricsDisplay();
                    });
                }
            }

            loadBackgroundImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // é‡Šæ”¾ä¹‹å‰çš„èƒŒæ™¯å›¾ç‰‡URL
                        const currentBg = this.backgroundContainer.style.backgroundImage;
                        if (currentBg && currentBg.includes('blob:')) {
                            const match = currentBg.match(/url\("?([^"\)]+)"?\)/);
                            if (match && match[1]) {
                                this.revokeObjectUrl(match[1]);
                            }
                        }
                        
                        this.backgroundContainer.style.backgroundImage = `url(${e.target.result})`;
                        log('èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ');
                        if (this.showNotification) {
                            this.showNotification(`èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ: ${file.name}`, 'success');
                        }
                    } catch (error) {
                        console.error('èƒŒæ™¯å›¾ç‰‡å¤„ç†é”™è¯¯:', error);
                        if (this.showNotification) {
                            this.showNotification('èƒŒæ™¯å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
                        }
                    }
                };
                reader.onerror = (error) => {
                    console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                    if (this.showNotification) {
                        this.showNotification(`èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.name}`, 'error');
                    }
                };
                reader.readAsDataURL(file);
            }

            parseLrc(lrcContent) {
                const lyrics = [];
                const lines = lrcContent.split('\n');
                
                if (!lrcContent || typeof lrcContent !== 'string') {
                    throw new Error('æ— æ•ˆçš„æ­Œè¯æ–‡ä»¶å†…å®¹');
                }
                
                lines.forEach((line, index) => {
                    try {
                        const match = line.match(/\[(\d+):(\d+)(?:\.(\d+))?\](.*)/);
                        if (match) {
                            const minutes = parseInt(match[1]);
                            const seconds = parseInt(match[2]);
                            const centiseconds = match[3] ? parseInt(match[3].padEnd(2, '0').slice(0, 2)) : 0;
                            const text = match[4].trim();
                            
                            if (isNaN(minutes) || isNaN(seconds) || minutes < 0 || seconds < 0 || seconds >= 60) {
                                throw new Error(`ç¬¬${index + 1}è¡Œæ—¶é—´æ ¼å¼é”™è¯¯: ${line}`);
                            }
                            
                            const time = minutes * 60 + seconds + centiseconds / 100;
                            lyrics.push({ time, text: text || 'â™ª' });
                        }
                    } catch (error) {
                        warn(`è§£ææ­Œè¯ç¬¬${index + 1}è¡Œå¤±è´¥:`, line, error.message);
                    }
                });

                return lyrics.sort((a, b) => a.time - b.time);
            }

            addSong(song) {
                // ç¡®ä¿æ–°æ­Œæ›²æœ‰é»˜è®¤çš„userMode
                if (!song.userMode) {
                    song.userMode = 'auto';
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ­Œæ›²ï¼Œé¿å…é‡å¤æ·»åŠ 
                const existingSong = this.songs.find(s => s.name === song.name);
                if (existingSong) {
                    warn(`æ­Œæ›² "${song.name}" å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤æ·»åŠ `);
                    return;
                }
                
                this.songs.push(song);
                log('æ­Œæ›²æ·»åŠ åˆ°åˆ—è¡¨:', song.name, 'æ€»æ—¶é•¿:', this.formatTime(song.duration));
                this.updatePlaylist();
                this.updateStatusIndicator();
                
                // å¦‚æœè¿™æ˜¯ç¬¬ä¸€é¦–æ­Œï¼Œè‡ªåŠ¨é€‰ä¸­
                if (this.songs.length === 1) {
                    this.switchToSong(0);
                }
            }

            updatePlaylist() {
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–DOMæ“ä½œ
                requestAnimationFrame(() => {
                    const modeIcons = {
                        'list': 'ğŸ“‹',
                        'loop': 'ğŸ”', 
                        'single': 'ğŸ”‚',
                        'random': 'ğŸ”€'
                    };
                    this.playlistCount.textContent = `${this.songs.length} é¦–æ­Œæ›² ${modeIcons[this.playMode]}`;
                    
                    if (this.songs.length === 0) {
                        this.playlist.innerHTML = '<div class="empty-playlist">è¿˜æ²¡æœ‰æ­Œæ›²ï¼Œè¯·ä¸Šä¼ LRCæ–‡ä»¶</div>';
                        return;
                    }

                    // ä½¿ç”¨DocumentFragmentå‡å°‘é‡æ’
                    const fragment = document.createDocumentFragment();
                    
                    this.songs.forEach((song, index) => {
                        const songItem = document.createElement('div');
                        songItem.className = `song-item ${index === this.currentSongIndex ? 'current' : ''}`;
                        songItem.dataset.index = index;
                        
                        // è·å–æ­Œæ›²æ¨¡å¼å¹¶æ˜¾ç¤ºç›¸åº”å›¾æ ‡
                        const songMode = this.getSongMode(song);
                        let modeIcon = '';
                        let modeTitle = '';
                        switch(songMode) {
                            case 'sync':
                                modeIcon = 'ğŸµ';
                                modeTitle = 'åŒæ­¥æ¨¡å¼ (éŸ³é¢‘+æ­Œè¯)';
                                break;
                            case 'audio':
                                modeIcon = 'ğŸ¶';
                                modeTitle = 'çº¯éŸ³é¢‘æ¨¡å¼';
                                break;
                            case 'lyrics':
                                modeIcon = 'ğŸ“';
                                modeTitle = 'çº¯æ­Œè¯æ¨¡å¼';
                                break;
                        }
                        
                        songItem.innerHTML = `
                            <div class="drag-handle" title="æ‹–æ‹½æ’åº">â‹®â‹®</div>
                            <div class="song-index-num">${index + 1}</div>
                            <div class="song-mode-icon" title="${modeTitle}" style="font-size: 10px; margin-right: 4px;">${modeIcon}</div>
                            ${this.createModeSelector(song, index)}
                            <div class="song-name" title="${song.name}">${song.name}</div>
                            <div class="song-duration">${this.formatTime(song.duration)}</div>
                            <div class="song-controls">
                                <button class="song-control-btn delete-btn" data-action="delete" data-index="${index}" title="åˆ é™¤">Ã—</button>
                            </div>
                        `;
                        
                        // è®¾ç½®æ¨¡å¼å±æ€§ï¼Œä½†ä¸è®¾ç½®draggableï¼Œç”±æ‹–æ‹½æ‰‹æŸ„æ§åˆ¶
                        songItem.setAttribute('data-user-mode', song.userMode || 'auto');
                        
                        fragment.appendChild(songItem);
                    });

                    this.playlist.innerHTML = '';
                    this.playlist.appendChild(fragment);

                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    this.playlist.querySelectorAll('.song-item').forEach(item => {
                        // å•å‡»äº‹ä»¶
                        item.addEventListener('click', (e) => {
                            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ­Œæ›²
                            if (e.target.dataset.action === 'delete') {
                                e.stopPropagation();
                                const index = parseInt(e.target.dataset.index);
                                this.removeSong(index);
                                return;
                            }
                            
                            // å¦‚æœç‚¹å‡»çš„æ˜¯æ‹–æ‹½æ‰‹æŸ„æˆ–æ¨¡å¼é€‰æ‹©å™¨ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ­Œæ›²
                            if (e.target.classList.contains('drag-handle') || 
                                e.target.classList.contains('mode-selector')) {
                                e.stopPropagation();
                                return;
                            }
                            
                            const index = parseInt(item.dataset.index);
                            this.switchToSong(index);
                        });
                        
                        // åŒå‡»äº‹ä»¶
                        item.addEventListener('dblclick', (e) => {
                            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ã€æ‹–æ‹½æ‰‹æŸ„æˆ–æ¨¡å¼é€‰æ‹©å™¨ï¼Œä¸æ‰§è¡Œæ’­æ”¾
                            if (e.target.dataset.action === 'delete' || 
                                e.target.classList.contains('drag-handle') ||
                                e.target.classList.contains('mode-selector')) {
                                return;
                            }
                            
                            const index = parseInt(item.dataset.index);
                            this.switchToSong(index);
                            const timerId = setTimeout(() => this.play(), 100);
                            this.addTimer(timerId);
                        });
                        
                        // æ¨¡å¼é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
                        const modeSelector = item.querySelector('.mode-selector');
                        if (modeSelector) {
                            modeSelector.addEventListener('change', (e) => {
                                e.stopPropagation();
                                const songIndex = parseInt(e.target.dataset.songIndex);
                                const newMode = e.target.value;
                                this.changeSongMode(songIndex, newMode);
                            });
                        }
                        
                        // æ‹–æ‹½äº‹ä»¶ - åˆå§‹åŒ–æ‹–æ‹½æ‰‹æŸ„
                        const dragHandle = item.querySelector('.drag-handle');
                        if (dragHandle) {
                            this.initSongItemDragEvents(item, dragHandle);
                        }
                    });

                    log('æ’­æ”¾åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œå…±', this.songs.length, 'é¦–æ­Œæ›²');
                });
            }

            initSongItemDragEvents(item, dragHandle) {
                // è®¾ç½®æ‹–æ‹½æ‰‹æŸ„ä¸ºå¯æ‹–æ‹½
                dragHandle.draggable = true;
                
                // æ‹–æ‹½å¼€å§‹äº‹ä»¶ - ç»‘å®šåˆ°æ‹–æ‹½æ‰‹æŸ„
                dragHandle.addEventListener('dragstart', (e) => {
                    this.draggedElement = item;
                    item.classList.add('dragging');
                    
                    // è®¾ç½®æ‹–æ‹½æ•°æ®
                    const dragIndex = parseInt(item.dataset.index);
                    e.dataTransfer.setData('text/plain', dragIndex.toString());
                    e.dataTransfer.effectAllowed = 'move';
                    
                    // åˆ›å»ºè‡ªå®šä¹‰æ‹–æ‹½å›¾åƒ
                    const dragImage = item.cloneNode(true);
                    dragImage.style.opacity = '0.8';
                    dragImage.style.transform = 'rotate(2deg)';
                    dragImage.style.width = item.offsetWidth + 'px';
                    dragImage.style.position = 'absolute';
                    dragImage.style.top = '-1000px';
                    document.body.appendChild(dragImage);
                    e.dataTransfer.setDragImage(dragImage, item.offsetWidth / 2, 20);
                    
                    // æ¸…ç†ä¸´æ—¶å…ƒç´ 
                    const timerId = setTimeout(() => {
                        if (document.body.contains(dragImage)) {
                            document.body.removeChild(dragImage);
                        }
                    }, 0);
                    this.addTimer(timerId);
                    
                    log('å¼€å§‹æ‹–æ‹½æ­Œæ›²:', this.songs[dragIndex].name);
                });
                
                // æ‹–æ‹½ç»“æŸäº‹ä»¶ - ç»‘å®šåˆ°æ‹–æ‹½æ‰‹æŸ„
                dragHandle.addEventListener('dragend', (e) => {
                    if (this.draggedElement) {
                        this.draggedElement.classList.remove('dragging');
                        this.draggedElement = null;
                    }
                    
                    // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½ç›¸å…³æ ·å¼
                    this.playlist.querySelectorAll('.song-item').forEach(songItem => {
                        songItem.classList.remove('drag-over');
                        songItem.style.borderTop = '';
                        songItem.style.borderBottom = '';
                    });
                    
                    log('æ‹–æ‹½ç»“æŸ');
                });
                
                // æ‹–æ‹½è¦†ç›–äº‹ä»¶ - ç»‘å®šåˆ°æ­Œæ›²é¡¹
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (item !== this.draggedElement) {
                        // æ¸…é™¤å…¶ä»–é¡¹çš„æ ·å¼
                        this.playlist.querySelectorAll('.song-item').forEach(songItem => {
                            if (songItem !== item) {
                                songItem.classList.remove('drag-over');
                                songItem.style.borderTop = '';
                                songItem.style.borderBottom = '';
                            }
                        });
                        
                        // è®¡ç®—é¼ æ ‡åœ¨å…ƒç´ ä¸­çš„ä½ç½®ï¼Œå†³å®šæ’å…¥ä½ç½®
                        const rect = item.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        const isTop = e.clientY < midpoint;
                        
                        // æ›´æ–°è§†è§‰åé¦ˆ
                        item.classList.add('drag-over');
                        if (isTop) {
                            item.style.borderTop = '2px solid #007bff';
                            item.style.borderBottom = '';
                        } else {
                            item.style.borderTop = '';
                            item.style.borderBottom = '2px solid #007bff';
                        }
                    }
                });
                
                // æ‹–æ‹½è¿›å…¥äº‹ä»¶ - ç»‘å®šåˆ°æ­Œæ›²é¡¹
                item.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                });
                
                // æ‹–æ‹½ç¦»å¼€äº‹ä»¶ - ç»‘å®šåˆ°æ­Œæ›²é¡¹
                item.addEventListener('dragleave', (e) => {
                    // åªæœ‰å½“å®Œå…¨ç¦»å¼€å…ƒç´ æ—¶æ‰æ¸…é™¤æ ·å¼
                    if (!item.contains(e.relatedTarget)) {
                        item.classList.remove('drag-over');
                        item.style.borderTop = '';
                        item.style.borderBottom = '';
                    }
                });
                
                // æ”¾ç½®äº‹ä»¶ - ç»‘å®šåˆ°æ­Œæ›²é¡¹
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    item.style.borderTop = '';
                    item.style.borderBottom = '';
                    
                    if (item === this.draggedElement) return;
                    
                    const dragIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const dropIndex = parseInt(item.dataset.index);
                    
                    // è®¡ç®—å®é™…æ’å…¥ä½ç½®
                    const rect = item.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    const isTop = e.clientY < midpoint;
                    const finalIndex = isTop ? dropIndex : dropIndex + 1;
                    
                    log(`æ‹–æ‹½: ä»ä½ç½® ${dragIndex} ç§»åŠ¨åˆ°ä½ç½® ${finalIndex}`);
                    
                    if (dragIndex !== finalIndex && finalIndex <= this.songs.length) {
                        this.reorderSongs(dragIndex, Math.min(finalIndex, this.songs.length - 1));
                    }
                });
            }

            reorderSongs(fromIndex, toIndex) {
                if (fromIndex === toIndex) return;
                
                // ç§»åŠ¨æ­Œæ›²
                const movedSong = this.songs.splice(fromIndex, 1)[0];
                this.songs.splice(toIndex, 0, movedSong);
                
                // æ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•
                if (this.currentSongIndex === fromIndex) {
                    // å½“å‰æ’­æ”¾çš„æ­Œæ›²è¢«ç§»åŠ¨äº†
                    this.currentSongIndex = toIndex;
                } else if (this.currentSongIndex > fromIndex && this.currentSongIndex <= toIndex) {
                    // å½“å‰æ’­æ”¾çš„æ­Œæ›²ç´¢å¼•éœ€è¦å‡1
                    this.currentSongIndex--;
                } else if (this.currentSongIndex < fromIndex && this.currentSongIndex >= toIndex) {
                    // å½“å‰æ’­æ”¾çš„æ­Œæ›²ç´¢å¼•éœ€è¦åŠ 1
                    this.currentSongIndex++;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                this.updatePlaylist();
                this.updateSongDisplay();
                
                log(`æ­Œæ›²ä»ä½ç½® ${fromIndex + 1} ç§»åŠ¨åˆ°ä½ç½® ${toIndex + 1}`);
                this.showNotification(`æ­Œæ›²å·²ç§»åŠ¨åˆ°ç¬¬ ${toIndex + 1} ä½`, 'success');
            }

            switchToSong(index) {
                if (index < 0 || index >= this.songs.length) return;
                
                // 1. é”€æ¯ä¸Šä¸€é¦–æ­Œæ›²çš„éŸ³é¢‘èµ„æº
                const oldSong = this.songs[this.currentSongIndex];
                if (oldSong && oldSong.audioElement) {
                    log('æ¸…ç†æ—§æ­Œæ›²çš„éŸ³é¢‘èµ„æº:', oldSong.name);
                    oldSong.audioElement.pause();
                    oldSong.audioElement.src = ''; // æ–­å¼€è¿æ¥
                    if (oldSong.audioElement._blobUrl) {
                        this.revokeObjectUrl(oldSong.audioElement._blobUrl);
                    }
                    oldSong.audioElement = null; // è§£é™¤å¼•ç”¨
                }

                this.pause(); // ç¡®ä¿æ’­æ”¾çŠ¶æ€å’Œå…¨å±€audioElementè¢«é‡ç½®
                
                // 2. åˆ‡æ¢åˆ°æ–°æ­Œæ›²
                this.currentSongIndex = index;
                const newSong = this.songs[this.currentSongIndex];
                
                this.currentLyricIndex = -1;
                this.currentTime = 0;
                this.pausedTime = 0;
                this.lyricsCache.clear();
                
                if (this.playMode === 'random' && !this.playHistory.includes(index)) {
                    this.playHistory.push(index);
                }
                this.clearSearch();

                const songMode = this.getSongMode(newSong);
                this.audioMode = (songMode === 'sync' || songMode === 'audio');

                // 3. æŒ‰éœ€åˆ›å»ºæ–°æ­Œæ›²çš„éŸ³é¢‘èµ„æº
                if (this.audioMode && newSong.audioFile && !newSong.audioElement) {
                    log(`æŒ‰éœ€åˆ›å»º "${newSong.name}" çš„éŸ³é¢‘å…ƒç´ `);
                    const audio = new Audio();
                    const url = URL.createObjectURL(newSong.audioFile);
                    this.objectUrls.add(url);
                    audio._blobUrl = url; // å­˜å‚¨urlä»¥ä¾¿åç»­é”€æ¯
                    audio.src = url;

                    newSong.audioElement = audio;
                    this.audioElement = audio; // æ›´æ–°å…¨å±€éŸ³é¢‘å…ƒç´ å¼•ç”¨

                    audio.addEventListener('loadedmetadata', () => {
                        log(`éŸ³é¢‘ "${newSong.name}" å…ƒæ•°æ®åŠ è½½å®Œæˆ, æ—¶é•¿:`, this.formatTime(audio.duration));
                        newSong.duration = audio.duration;
                        this.totalTimeSpan.textContent = this.formatTime(newSong.duration);
                        this.updatePlaylist(); // æ—¶é•¿å˜åŒ–ï¼Œæ›´æ–°æ’­æ”¾åˆ—è¡¨
                        if (this.isPlaying) {
                            audio.play().catch(e => console.error("Play interrupted by metadata load:", e));
                        }
                    });

                    audio.addEventListener('error', (e) => {
                        console.error('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥:', e);
                        this.showNotification(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${newSong.name}`, 'error');
                        newSong.mode = 'lyrics'; // é™çº§ä¸ºçº¯æ­Œè¯æ¨¡å¼
                        this.updatePlaylist();
                    });

                    audio.addEventListener('timeupdate', () => {
                        if (this.audioMode && this.isPlaying && this.audioElement === audio) {
                            this.syncWithAudio();
                        }
                    });

                    audio.addEventListener('ended', () => {
                        if (this.audioElement === audio) {
                            this.onSongEnded();
                        }
                    });
                } else if (this.audioMode) {
                    this.audioElement = newSong.audioElement; // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥å¼•ç”¨
                } else {
                    this.audioElement = null;
                }
                
                // 4. æ›´æ–°UI
                this.updateSongDisplay();
                this.updatePlaylist();
                this.updateLyricsDisplay();
                this.progressBar.style.width = '0%';
                this.updateProgress();
                this.updateAudioMode();
                
                if (songMode === 'audio') {
                    this.showLyrics('â™ª éŸ³é¢‘å‡†å¤‡æ’­æ”¾ â™ª', '');
                } else if (newSong.lyrics && newSong.lyrics.length > 0) {
                    this.showLyrics(newSong.lyrics[0].text, 
                                  newSong.lyrics.length > 1 ? newSong.lyrics[1].text : '');
                } else {
                    this.showLyrics('â™ª', '');
                }
                
                this.playButton.disabled = false;
                this.totalTimeSpan.textContent = this.formatTime(newSong.duration);
                log('åˆ‡æ¢åˆ°æ­Œæ›²:', newSong.name, `(${songMode}æ¨¡å¼)`);
            }

            switchToNextSong() {
                if (this.currentSongIndex < this.songs.length - 1) {
                    this.switchToSong(this.currentSongIndex + 1);
                    // åˆ‡æ¢æ­Œæ›²åè‡ªåŠ¨æ’­æ”¾
                    const timerId = setTimeout(() => {
                        this.play();
                    }, 100);
                    this.addTimer(timerId);
                }
            }

            onSongEnded() {
                this.pause();
                log('æ­Œæ›²æ’­æ”¾å®Œæˆ:', this.songs[this.currentSongIndex].name);
                
                // æ ¹æ®æ’­æ”¾æ¨¡å¼å†³å®šä¸‹ä¸€æ­¥åŠ¨ä½œ
                const nextIndex = this.getNextSongIndex();
                
                if (nextIndex >= 0) {
                    log(`æ’­æ”¾æ¨¡å¼: ${this.playMode}, å‡†å¤‡æ’­æ”¾ä¸‹ä¸€é¦–`);
                    const timerId = setTimeout(() => {
                        if (nextIndex === this.currentSongIndex && this.playMode === 'single') {
                            // å•æ›²å¾ªç¯ï¼šé‡ç½®åˆ°å¼€å¤´ç»§ç»­æ’­æ”¾
                            this.setCurrentTime(0);
                            this.play();
                        } else {
                            // åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–æ­Œæ›²
                            this.switchToSong(nextIndex);
                            const playTimerId = setTimeout(() => {
                                this.play();
                            }, 100);
                            this.addTimer(playTimerId);
                        }
                    }, 500); // å»¶è¿Ÿ500msï¼Œè®©ç”¨æˆ·çœ‹åˆ°å½“å‰æ­Œæ›²å·²å®Œæˆ
                    this.addTimer(timerId);
                } else {
                    log('æ’­æ”¾åˆ—è¡¨å·²ç»“æŸ');
                    this.showNotification('æ’­æ”¾åˆ—è¡¨å·²ç»“æŸ', 'info');
                }
            }

            switchToPreviousSong() {
                if (this.currentSongIndex > 0) {
                    this.switchToSong(this.currentSongIndex - 1);
                    // åˆ‡æ¢æ­Œæ›²åè‡ªåŠ¨æ’­æ”¾
                    const timerId = setTimeout(() => {
                        this.play();
                    }, 100);
                    this.addTimer(timerId);
                }
            }

            removeSong(index) {
                if (index < 0 || index >= this.songs.length) return;
                
                const songToRemove = this.songs[index];
                log('åˆ é™¤æ­Œæ›²:', songToRemove.name);

                // å¦‚æœåˆ é™¤çš„æ­Œæ›²æœ‰å…³è”çš„éŸ³é¢‘å…ƒç´ ï¼Œæ¸…ç†å®ƒ
                if (songToRemove.audioElement) {
                    log('æ¸…ç†è¢«åˆ é™¤æ­Œæ›²çš„éŸ³é¢‘èµ„æº:', songToRemove.name);
                    songToRemove.audioElement.pause();
                    songToRemove.audioElement.src = '';
                    if (songToRemove.audioElement._blobUrl) {
                        this.revokeObjectUrl(songToRemove.audioElement._blobUrl);
                    }
                    songToRemove.audioElement = null;
                }
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²
                if (index === this.currentSongIndex) {
                    this.pause();
                    this.currentSongIndex = -1;
                    this.showLyrics('â™ª', '');
                    this.updateSongDisplay();
                    this.playButton.disabled = true;
                } else if (index < this.currentSongIndex) {
                    // å¦‚æœåˆ é™¤çš„æ­Œæ›²åœ¨å½“å‰æ­Œæ›²ä¹‹å‰ï¼Œè°ƒæ•´ç´¢å¼•
                    this.currentSongIndex--;
                }
                
                // ä»æ•°ç»„ä¸­åˆ é™¤æ­Œæ›²
                this.songs.splice(index, 1);
                
                // æ›´æ–°æ’­æ”¾åˆ—è¡¨
                this.updatePlaylist();
                this.updateStatusIndicator();
                
                // å¦‚æœæ²¡æœ‰æ­Œæ›²äº†
                if (this.songs.length === 0) {
                    this.currentSongIndex = -1;
                    this.showLyrics('è¯·ä¸Šä¼ LRCæ­Œè¯æ–‡ä»¶', 'å¼€å§‹ä½ çš„æ¼”å‡º');
                    this.songInfo.style.display = 'none';
                    this.currentSongInfo.style.display = 'none';
                    this.playButton.disabled = true;
                }
            }

            updateSongDisplay() {
                if (this.currentSongIndex >= 0 && this.currentSongIndex < this.songs.length) {
                    const currentSong = this.songs[this.currentSongIndex];
                    
                    // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤ºï¼ˆéšè—æ•°å­—å‰ç¼€ï¼‰
                    this.displaySongTitle.textContent = this.formatSongNameForDisplay(currentSong.name);
                    this.displaySongIndex.textContent = `${this.currentSongIndex + 1} / ${this.songs.length}`;
                    this.songInfo.style.display = 'block';
                    
                    // æ›´æ–°æ§åˆ¶é¢æ¿æ˜¾ç¤ºï¼ˆéšè—æ•°å­—å‰ç¼€ï¼‰
                    this.currentSongName.textContent = this.formatSongNameForDisplay(currentSong.name);
                    this.currentSongStatus.textContent = this.isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ';
                    this.currentSongInfo.style.display = 'block';
                } else {
                    this.songInfo.style.display = 'none';
                    this.currentSongInfo.style.display = 'none';
                }
            }

            updateStatusIndicator() {
                if (this.songs.length === 0) {
                    this.statusIndicator.className = 'status-indicator';
                } else if (this.isPlaying) {
                    this.statusIndicator.className = 'status-indicator playing';
                } else {
                    this.statusIndicator.className = 'status-indicator ready';
                }
            }

            showLyrics(current, next = '') {
                // é¿å…ä¸å¿…è¦çš„DOMæ›´æ–°
                if (this.currentLyricEl.textContent !== current) {
                    // ä½¿ç”¨documentFragmentå‡å°‘é‡æ’
                    const fragment = document.createDocumentFragment();
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = current;
                    fragment.appendChild(tempDiv);
                    
                    // æ‰¹é‡æ›´æ–°DOM
                    requestAnimationFrame(() => {
                        this.currentLyricEl.textContent = current;
                        this.nextLyricEl.textContent = next;
                        
                        // æ·»åŠ å…¥åœºåŠ¨ç”»
                        this.currentLyricEl.classList.remove('entering');
                        // ä½¿ç”¨requestAnimationFrameç¡®ä¿åŠ¨ç”»æ­£å¸¸æ‰§è¡Œ
                        requestAnimationFrame(() => {
                            this.currentLyricEl.classList.add('entering');
                        });
                    });
                }
            }

            togglePlay() {
                if (this.currentSongIndex < 0 || this.currentSongIndex >= this.songs.length) {
                    log('æ²¡æœ‰é€‰æ‹©æœ‰æ•ˆæ­Œæ›²');
                    return;
                }
                
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            play() {
                if (this.currentSongIndex < 0) {
                    this.showNotification('è¯·å…ˆé€‰æ‹©ä¸€é¦–æ­Œæ›²', 'warning');
                    return;
                }
                
                const currentSong = this.songs[this.currentSongIndex];
                const songMode = this.getSongMode(currentSong);
                
                const startPlayback = () => {
                    // å¦‚æœæ’­æ”¾å®Œæˆï¼Œé‡ç½®åˆ°å¼€å¤´
                    const maxDuration = this.audioElement ? this.audioElement.duration : currentSong.duration;
                    if (this.currentTime >= maxDuration) {
                        this.currentTime = 0;
                        this.pausedTime = 0;
                    }
                    
                    this.isPlaying = true;
                    this.playButton.textContent = 'â¸';
                    
                    if (this.audioMode && this.audioElement) {
                        this.audioElement.currentTime = Math.max(0, this.currentTime - this.audioOffset);
                        this.audioElement.playbackRate = this.playbackSpeed;
                        this.audioElement.play().catch(e => {
                            console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                            this.showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æˆ–æµè§ˆå™¨æƒé™', 'error');
                            this.pause(); // æ’­æ”¾å¤±è´¥åˆ™å›åˆ°æš‚åœçŠ¶æ€
                        });
                        if(songMode === 'audio') {
                           this.showLyrics('â™ª éŸ³ä¹æ’­æ”¾ä¸­ â™ª', '');
                        }
                    } else { // çº¯æ­Œè¯æ¨¡å¼
                        this.startTime = performance.now() - (this.pausedTime * 1000);
                        this.animate();
                    }
                    
                    this.updateStatusIndicator();
                    this.updateSongDisplay();
                    this.requestWakeLock();
                    log('å¼€å§‹æ’­æ”¾:', currentSong.name, `(${songMode}æ¨¡å¼)`);
                };

                if (this.audioMode && this.audioElement && this.audioElement.readyState < 2) {
                    log('éŸ³é¢‘ä»åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾… "canplay" äº‹ä»¶...');
                    this.audioElement.addEventListener('canplay', startPlayback, { once: true });
                } else {
                    startPlayback();
                }
            }

            pause() {
                if (!this.isPlaying) return; // é¿å…é‡å¤æš‚åœ

                this.isPlaying = false;
                this.playButton.textContent = 'â–¶';
                
                if (this.audioElement) {
                    this.pausedTime = this.audioElement.currentTime;
                    this.audioElement.pause();
                } else {
                    this.pausedTime = this.currentTime;
                }
                
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                this.updateStatusIndicator();
                this.updateSongDisplay();
                this.releaseWakeLock();
                log('æš‚åœæ’­æ”¾');
            }

            animate() {
                if (!this.isPlaying) return;
                
                // éŸ³é¢‘æ¨¡å¼ç”± 'timeupdate' äº‹ä»¶é©±åŠ¨ï¼Œè¿™é‡Œåªå¤„ç†çº¯æ­Œè¯æ¨¡å¼
                if (this.audioMode) {
                    this.animationId = requestAnimationFrame(() => this.animate());
                    return;
                }

                const now = performance.now();
                this.currentTime = this.pausedTime + ((now - this.startTime) / 1000) * this.playbackSpeed;

                const currentSong = this.songs[this.currentSongIndex];
                if (this.currentTime >= currentSong.duration) {
                    this.currentTime = currentSong.duration;
                    this.onSongEnded();
                    return;
                }

                if (now - this.lastProgressUpdate > 200) { 
                    this.updateProgress();
                    this.lastProgressUpdate = now;
                }
                
                if (now - this.lastLyricsUpdate > 50) {
                    this.updateLyricsDisplay();
                    this.lastLyricsUpdate = now;
                }

                this.animationId = requestAnimationFrame(() => this.animate());
            }

            setCurrentTime(time) {
                if (this.currentSongIndex < 0) return;
                
                const currentSong = this.songs[this.currentSongIndex];
                const maxDuration = this.audioElement ? this.audioElement.duration : currentSong.duration;
                this.currentTime = Math.max(0, Math.min(time, maxDuration || 0));
                
                if (this.audioElement) {
                    this.audioElement.currentTime = Math.max(0, this.currentTime - this.audioOffset);
                }

                this.pausedTime = this.currentTime;
                if (this.isPlaying && !this.audioElement) {
                    this.startTime = performance.now() - (this.pausedTime * 1000 / this.playbackSpeed);
                }
                
                requestAnimationFrame(() => {
                    this.updateProgress();
                    this.updateLyricsDisplay();
                });
            }

            seek(seconds) {
                this.setCurrentTime(this.currentTime + seconds);
            }

            seekTo(e) {
                if (this.currentSongIndex < 0) return;
                
                const rect = this.progressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                const currentSong = this.songs[this.currentSongIndex];
                const duration = this.audioElement ? this.audioElement.duration : currentSong.duration;
                const newTime = (clickX / width) * duration;
                this.setCurrentTime(newTime);
            }

            setPlaybackSpeed(speed) {
                document.querySelectorAll('.speed-button').forEach(btn => {
                    btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
                });

                this.playbackSpeed = speed;

                if (this.isPlaying && !this.audioElement) {
                    const elapsed = this.currentTime;
                    this.startTime = performance.now() - (elapsed * 1000 / speed);
                }
                
                if (this.audioElement) {
                    this.audioElement.playbackRate = speed;
                }
                
                log('æ’­æ”¾é€Ÿåº¦è®¾ç½®ä¸º:', speed + 'x');
            }
            
            setFontScale(scale) {
                this.fontScale = Math.max(0.5, Math.min(3, scale));
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.font-size-button').forEach(btn => {
                    btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.fontSize) - this.fontScale) < 0.01);
                });
                
                this.updateLyricsFontSize();
                log('å­—ä½“å¤§å°è®¾ç½®ä¸º:', this.fontScale + 'x');
            }
            
            adjustFontSize(delta) {
                this.setFontScale(this.fontScale + delta);
            }
            
            updateLyricsFontSize() {
                // ä½¿ç”¨CSSå˜é‡æ¥åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                document.documentElement.style.setProperty('--font-scale', this.fontScale);
                
                // ç›´æ¥è®¾ç½®å­—ä½“å¤§å°ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                const currentLyric = document.querySelector('.current-lyric');
                const nextLyric = document.querySelector('.next-lyric');
                
                if (currentLyric) {
                    currentLyric.style.fontSize = `${8 * this.fontScale}rem`;
                }
                if (nextLyric) {
                    nextLyric.style.fontSize = `${4 * this.fontScale}rem`;
                }
            }
            
            setTheme(theme) {
                this.currentTheme = theme;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.theme-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
                
                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                document.body.classList.remove('theme-classic', 'theme-gold', 'theme-blue', 'theme-rainbow');
                // æ·»åŠ æ–°ä¸»é¢˜ç±»
                document.body.classList.add(`theme-${theme}`);
                
                log('ä¸»é¢˜è®¾ç½®ä¸º:', theme);
            }
            
            switchTheme() {
                const themes = ['classic', 'gold', 'blue', 'rainbow'];
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextIndex = (currentIndex + 1) % themes.length;
                this.setTheme(themes[nextIndex]);
            }
            
            setPlayMode(mode) {
                this.playMode = mode;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.play-mode-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // æ¸…ç©ºéšæœºæ’­æ”¾å†å²
                if (mode === 'random') {
                    this.playHistory = [];
                }
                
                let modeNames = {
                    'list': 'åˆ—è¡¨æ’­æ”¾',
                    'loop': 'åˆ—è¡¨å¾ªç¯',
                    'single': 'å•æ›²å¾ªç¯',
                    'random': 'éšæœºæ’­æ”¾'
                };
                
                log('æ’­æ”¾æ¨¡å¼è®¾ç½®ä¸º:', modeNames[mode]);
                this.showNotification(`æ’­æ”¾æ¨¡å¼: ${modeNames[mode]}`, 'info');
            }
            
            switchPlayMode() {
                const modes = ['list', 'loop', 'single', 'random'];
                const currentIndex = modes.indexOf(this.playMode);
                const nextIndex = (currentIndex + 1) % modes.length;
                this.setPlayMode(modes[nextIndex]);
            }
            
            
            getNextSongIndex() {
                if (this.songs.length === 0) return -1;
                
                switch (this.playMode) {
                    case 'single':
                        // å•æ›²å¾ªç¯ï¼šè¿”å›å½“å‰æ­Œæ›²ç´¢å¼•
                        return this.currentSongIndex;
                    
                    case 'loop':
                        // åˆ—è¡¨å¾ªç¯ï¼šåˆ°æœ€åä¸€é¦–åå›åˆ°ç¬¬ä¸€é¦–
                        return this.currentSongIndex >= this.songs.length - 1 ? 0 : this.currentSongIndex + 1;
                    
                    case 'random':
                        // éšæœºæ’­æ”¾ï¼šéšæœºé€‰æ‹©ä¸€é¦–æœªæ’­æ”¾çš„æ­Œæ›²
                        return this.getRandomSongIndex();
                    
                    case 'list':
                    default:
                        // åˆ—è¡¨æ’­æ”¾ï¼šé¡ºåºæ’­æ”¾ï¼Œæœ€åä¸€é¦–ç»“æŸ
                        return this.currentSongIndex >= this.songs.length - 1 ? -1 : this.currentSongIndex + 1;
                }
            }
            
            getRandomSongIndex() {
                if (this.songs.length === 0) return -1;
                if (this.songs.length === 1) return 0;
                
                // å¦‚æœæ‰€æœ‰æ­Œæ›²éƒ½æ’­æ”¾è¿‡äº†ï¼Œæ¸…ç©ºå†å²è®°å½•é‡æ–°å¼€å§‹
                if (this.playHistory.length >= this.songs.length) {
                    this.playHistory = [];
                }
                
                // è·å–æœªæ’­æ”¾è¿‡çš„æ­Œæ›²ç´¢å¼•
                const unplayedIndexes = [];
                for (let i = 0; i < this.songs.length; i++) {
                    if (!this.playHistory.includes(i)) {
                        unplayedIndexes.push(i);
                    }
                }
                
                if (unplayedIndexes.length === 0) {
                    // æ‰€æœ‰æ­Œæ›²éƒ½æ’­æ”¾è¿‡ï¼Œé‡æ–°å¼€å§‹
                    this.playHistory = [];
                    return Math.floor(Math.random() * this.songs.length);
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªæœªæ’­æ”¾çš„æ­Œæ›²
                const randomIndex = Math.floor(Math.random() * unplayedIndexes.length);
                const selectedIndex = unplayedIndexes[randomIndex];
                
                // è®°å½•åˆ°æ’­æ”¾å†å²
                this.playHistory.push(selectedIndex);
                
                return selectedIndex;
            }
            
            searchLyrics(query) {
                const searchResults = document.getElementById('searchResults');
                
                if (!query.trim()) {
                    this.clearSearch();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰é€‰ä¸­çš„æ­Œæ›²
                if (this.currentSongIndex < 0 || this.currentSongIndex >= this.songs.length) {
                    searchResults.innerHTML = '<div class="search-result-item">è¯·å…ˆé€‰æ‹©ä¸€é¦–æ­Œæ›²</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                this.searchResults = [];
                const currentSong = this.songs[this.currentSongIndex];
                
                // åªåœ¨å½“å‰æ­Œæ›²ä¸­æœç´¢
                if (currentSong.lyrics && currentSong.lyrics.length > 0) {
                    currentSong.lyrics.forEach((lyric, lyricIndex) => {
                        if (lyric.text.toLowerCase().includes(query.toLowerCase())) {
                            this.searchResults.push({
                                songIndex: this.currentSongIndex,
                                lyricIndex,
                                songName: currentSong.name,
                                time: lyric.time,
                                text: lyric.text
                            });
                        }
                    });
                }
                
                this.displaySearchResults(query);
            }
            
            displaySearchResults(query) {
                const searchResults = document.getElementById('searchResults');
                
                if (this.searchResults.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">åœ¨å½“å‰æ­Œæ›²ä¸­æœªæ‰¾åˆ°ç›¸å…³æ­Œè¯</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                const resultsHtml = this.searchResults.map(result => {
                    // é«˜äº®æœç´¢å…³é”®è¯
                    const highlightedText = result.text.replace(
                        new RegExp(query, 'gi'),
                        match => `<span class="search-highlight">${match}</span>`
                    );
                    
                    return `
                        <div class="search-result-item" 
                             data-song-index="${result.songIndex}" 
                             data-lyric-index="${result.lyricIndex}"
                             data-time="${result.time}">
                            <span class="search-result-time">${this.formatTime(result.time)}</span>
                            <span class="search-result-text">${highlightedText}</span>
                        </div>
                    `;
                }).join('');
                
                searchResults.innerHTML = resultsHtml;
                searchResults.style.display = 'block';
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const time = parseFloat(item.dataset.time);
                        
                        // è·³è½¬åˆ°æŒ‡å®šæ—¶é—´å¹¶å¼€å§‹æ’­æ”¾
                        this.setCurrentTime(time);
                        
                        // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œåˆ™å¼€å§‹æ’­æ”¾
                        if (!this.isPlaying) {
                            const timerId = setTimeout(() => {
                                this.play();
                            }, 100);
                            this.addTimer(timerId);
                        }
                        
                        this.clearSearch();
                        this.showNotification(`è·³è½¬åˆ°: ${this.formatTime(time)}`, 'success');
                    });
                });
                
                log(`åœ¨å½“å‰æ­Œæ›²ä¸­æœç´¢åˆ° ${this.searchResults.length} æ¡ç»“æœ`);
            }
            
            clearSearch() {
                const searchResults = document.getElementById('searchResults');
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
                this.searchResults = [];
            }
            
            // å†…å­˜ç®¡ç†æ–¹æ³•
            cleanupAudio() {
                if (this.audioElement) {
                    this.audioElement.pause();
                    this.audioElement.removeEventListener('loadedmetadata', () => {});
                    this.audioElement.removeEventListener('error', () => {});
                    this.audioElement.removeEventListener('timeupdate', () => {});
                    this.audioElement.removeEventListener('ended', () => {});
                    
                    // é‡Šæ”¾URLå¯¹è±¡
                    if (this.audioElement.src && this.audioElement.src.startsWith('blob:')) {
                        this.revokeObjectUrl(this.audioElement.src);
                    }
                    
                    this.audioElement.src = '';
                    this.audioElement.load();
                    this.audioElement = null;
                }
            }
            
            revokeObjectUrl(url) {
                if (this.objectUrls.has(url)) {
                    URL.revokeObjectURL(url);
                    this.objectUrls.delete(url);
                    log('é‡Šæ”¾å¯¹è±¡URL:', url);
                } else {
                    warn('å°è¯•é‡Šæ”¾æœªè·Ÿè¸ªçš„å¯¹è±¡URL:', url);
                }
            }
            
            addTimer(timerId) {
                this.timers.add(timerId);
            }
            
            setTimer(callback, delay) {
                const timerId = setTimeout(() => {
                    // æ‰§è¡Œå›è°ƒ
                    callback();
                    // æ‰§è¡Œå®Œåä»é›†åˆä¸­ç§»é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
                    this.timers.delete(timerId);
                }, delay);
                this.timers.add(timerId);
                return timerId;
            }

            clearTimer(timerId) {
                if (this.timers.has(timerId)) {
                    clearTimeout(timerId);
                    this.timers.delete(timerId);
                }
            }
            
            cleanup() {
                log('æ¸…ç†èµ„æº...');
                
                // æ¸…ç†åŠ¨ç”»å¸§
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                // æ¸…ç†éŸ³é¢‘èµ„æº
                this.cleanupAudio();
                
                // æ¸…ç†æ‰€æœ‰URLå¯¹è±¡
                this.objectUrls.forEach(url => {
                    try {
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        warn('é‡Šæ”¾å¯¹è±¡URLæ—¶å‡ºé”™:', url, error);
                    }
                });
                this.objectUrls.clear();
                
                // æ¸…ç†å®šæ—¶å™¨ï¼ˆåŒ…æ‹¬å…‰æ ‡å®šæ—¶å™¨ï¼‰
                if (this.cursorTimeout) {
                    clearTimeout(this.cursorTimeout);
                    this.cursorTimeout = null;
                }
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                });
                this.timers.clear();
                
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                this.eventListeners.forEach((handler, eventType) => {
                    try {
                        document.removeEventListener(eventType, handler);
                    } catch (error) {
                        warn('ç§»é™¤äº‹ä»¶ç›‘å¬å™¨æ—¶å‡ºé”™:', eventType, error);
                    }
                });
                this.eventListeners.clear();
                
                // æ¸…ç†å¢å¼ºçš„äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œè¡¨
                this.removeAllEventListeners();
                
                // æ¸…ç†ç¼“å­˜
                this.lyricsCache.clear();
                this.searchResults = [];
                
                // é‡Šæ”¾å±å¹•å”¤é†’é”
                this.releaseWakeLock();
                
                log('èµ„æºæ¸…ç†å®Œæˆ');
            }
            
            // é€šçŸ¥ç³»ç»Ÿ
            showNotification(message, type = 'info', duration = 3000) {
                try {
                    const container = document.getElementById('notificationContainer');
                    if (!container) {
                        console.error('é€šçŸ¥å®¹å™¨ä¸å­˜åœ¨');
                        return;
                    }
                    
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.textContent = message;
                    
                    container.appendChild(notification);
                
                    // è‡ªåŠ¨ç§»é™¤
                    const timerId = setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, duration);
                    this.addTimer(timerId);
                    
                    // ç‚¹å‡»å…³é—­
                    notification.addEventListener('click', () => {
                        this.clearTimer(timerId);
                        if (notification.parentNode) {
                            notification.style.animation = 'fadeOut 0.2s ease forwards';
                            const fadeTimerId = setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 200);
                            this.addTimer(fadeTimerId);
                        }
                    });
                } catch (error) {
                    console.error('æ˜¾ç¤ºé€šçŸ¥æ—¶å‡ºé”™:', error);
                    // é™çº§å¤„ç†ï¼šç›´æ¥åœ¨æ§åˆ¶å°è¾“å‡º
                    log(`[${type.toUpperCase()}] ${message}`);
                }
            }

            updateProgress() {
                if (this.currentSongIndex < 0) return;
                
                const currentSong = this.songs[this.currentSongIndex];
                const maxDuration = this.audioMode && this.audioElement ? this.audioElement.duration : currentSong.duration;
                
                // å¤„ç†æ— æ•ˆæ—¶é•¿çš„æƒ…å†µ
                if (!maxDuration || maxDuration <= 0 || isNaN(maxDuration)) {
                    this.progressBar.style.width = '0%';
                    this.currentTimeSpan.textContent = this.formatTime(this.currentTime);
                    this.totalTimeSpan.textContent = '0:00';
                    return;
                }
                
                const progress = (this.currentTime / maxDuration) * 100;
                const progressPercent = Math.max(0, Math.min(progress, 100));
                
                // ç›´æ¥è®¾ç½®widthè€Œä¸æ˜¯ä½¿ç”¨transform
                this.progressBar.style.width = `${progressPercent}%`;
                this.currentTimeSpan.textContent = this.formatTime(this.currentTime);
                this.totalTimeSpan.textContent = this.formatTime(maxDuration);
            }

            updateLyricsDisplay() {
                if (this.currentSongIndex < 0) return;
                
                const currentSong = this.songs[this.currentSongIndex];
                const lyrics = currentSong.lyrics;
                
                if (!lyrics || lyrics.length === 0) {
                    this.showLyrics('æ— æ­Œè¯', '');
                    return;
                }

                // ä¼˜åŒ–ï¼šå¦‚æœæ—¶é—´å€’é€€ï¼ˆç”¨æˆ·æ‹–åŠ¨è¿›åº¦æ¡å›é€€ï¼‰ï¼Œé‡ç½®æœç´¢èµ·å§‹ç‚¹
                if (this.currentTime < this.lastLyricSearchTime) {
                    this.lastLyricSearchIndex = 0;
                }
                this.lastLyricSearchTime = this.currentTime;

                // ä¼˜åŒ–ï¼šä»ä¸Šæ¬¡çš„ä½ç½®å¼€å§‹å‘åæŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä»å¤´éå† (O(1) vs O(N))
                let activeIndex = -1;
                // åªæœ‰å½“å½“å‰æ—¶é—´å¤§äºç¬¬ä¸€å¥æ­Œè¯æ—¶é—´æ‰å¼€å§‹æŸ¥æ‰¾
                if (this.currentTime >= lyrics[0].time) {
                    // ä»ä¸Šæ¬¡ç´¢å¼•å¼€å§‹ï¼Œå¿«é€Ÿæ‰¾åˆ°å½“å‰åº”è¯¥æ˜¾ç¤ºçš„æ­Œè¯
                    for (let i = this.lastLyricSearchIndex; i < lyrics.length; i++) {
                        if (this.currentTime >= lyrics[i].time) {
                            // è¿™æ˜¯ä¸€ä¸ªå€™é€‰ï¼Œä½†æˆ‘ä»¬è¦çœ‹ä¸‹ä¸€å¥æ˜¯å¦ä¹Ÿå·²ç»åˆ°äº†
                            if (i === lyrics.length - 1 || this.currentTime < lyrics[i + 1].time) {
                                activeIndex = i;
                                this.lastLyricSearchIndex = i; // æ›´æ–°æœç´¢èµ·ç‚¹
                                break;
                            }
                        } else {
                            // å¦‚æœå½“å‰å¥çš„æ—¶é—´éƒ½å·²ç»å¤§äºå½“å‰æ—¶é—´ï¼Œé‚£åé¢çš„è‚¯å®šä¹Ÿå¤§äºï¼Œç›´æ¥è·³å‡º
                            break;
                        }
                    }
                }

                // åªæœ‰å½“æ­Œè¯ç´¢å¼•å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–° DOM
                if (activeIndex !== this.currentLyricIndex) {
                    this.currentLyricIndex = activeIndex;
                    
                    const currentLyric = activeIndex >= 0 ? lyrics[activeIndex].text : '...';
                    const nextLyric = activeIndex >= 0 && activeIndex < lyrics.length - 1 
                        ? lyrics[activeIndex + 1].text 
                        : '';
                    
                    this.showLyrics(currentLyric, nextLyric);
                    // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
                    this.updateLyricProgress();
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        log('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                    });
                } else {
                    document.exitFullscreen().catch(err => {
                        log('æ— æ³•é€€å‡ºå…¨å±æ¨¡å¼:', err);
                    });
                }
            }

            formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            // æ’­æ”¾åˆ—è¡¨ç®¡ç†
            sortPlaylist() {
                if (this.songs.length <= 1) {
                    this.showNotification('æ­Œæ›²æ•°é‡ä¸è¶³ï¼Œæ— éœ€æ’åº', 'info');
                    return;
                }
                
                // è®°å½•å½“å‰æ’­æ”¾æ­Œæ›²çš„åç§°
                const currentSongName = this.currentSongIndex >= 0 ? this.songs[this.currentSongIndex].name : null;
                
                // æ™ºèƒ½æ’åºï¼šæ•°å­—å‰ç¼€ä¼˜å…ˆï¼Œç„¶åæŒ‰åç§°
                this.songs.sort((a, b) => {
                    const nameA = a.name;
                    const nameB = b.name;
                    
                    // æå–æ•°å­—å‰ç¼€
                    const extractNumber = (name) => {
                        const match = name.match(/^(\d+)/);
                        return match ? parseInt(match[1]) : Infinity;
                    };
                    
                    const numA = extractNumber(nameA);
                    const numB = extractNumber(nameB);
                    
                    // å¦‚æœéƒ½æœ‰æ•°å­—å‰ç¼€ï¼ŒæŒ‰æ•°å­—æ’åº
                    if (numA !== Infinity && numB !== Infinity) {
                        if (numA !== numB) return numA - numB;
                        // æ•°å­—ç›¸åŒæ—¶æŒ‰åç§°æ’åº
                        return nameA.localeCompare(nameB, 'zh-CN');
                    }
                    
                    // å¦‚æœåªæœ‰ä¸€ä¸ªæœ‰æ•°å­—å‰ç¼€ï¼Œæœ‰æ•°å­—çš„æ’åœ¨å‰é¢
                    if (numA !== Infinity) return -1;
                    if (numB !== Infinity) return 1;
                    
                    // éƒ½æ²¡æœ‰æ•°å­—å‰ç¼€ï¼ŒæŒ‰åç§°æ’åº
                    return nameA.localeCompare(nameB, 'zh-CN');
                });
                
                // é‡æ–°æ‰¾åˆ°å½“å‰æ’­æ”¾æ­Œæ›²çš„ç´¢å¼•
                if (currentSongName) {
                    this.currentSongIndex = this.songs.findIndex(song => song.name === currentSongName);
                }
                
                // æ›´æ–°æ˜¾ç¤º
                this.updatePlaylist();
                this.updateSongDisplay();
                
                this.showNotification(`æ­Œæ›²åˆ—è¡¨å·²æŒ‰åç§°æ’åº (${this.songs.length} é¦–)`, 'success');
                log('æ’­æ”¾åˆ—è¡¨å·²æ’åº');
            }
            
            exportPlaylist() {
                if (this.songs.length === 0) {
                    this.showNotification('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'warning');
                    return;
                }
                
                const playlistData = {
                    version: '1.0',
                    exportTime: new Date().toISOString(),
                    songs: this.songs.map(song => ({
                        name: song.name,
                        lyrics: song.lyrics,
                        duration: song.duration
                    }))
                };
                
                const dataStr = JSON.stringify(playlistData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                this.objectUrls.add(url);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `æ­Œè¯æ’­æ”¾åˆ—è¡¨_${new Date().toLocaleDateString()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification(`å·²å¯¼å‡º ${this.songs.length} é¦–æ­Œæ›²çš„æ’­æ”¾åˆ—è¡¨`, 'success');
            }
            
            importPlaylist(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const playlistData = JSON.parse(e.target.result);
                        
                        if (!playlistData.songs || !Array.isArray(playlistData.songs)) {
                            throw new Error('æ— æ•ˆçš„æ’­æ”¾åˆ—è¡¨æ ¼å¼');
                        }
                        
                        // éªŒè¯æ­Œæ›²æ•°æ®
                        const validSongs = playlistData.songs.filter(song => {
                            return song.name && song.lyrics && Array.isArray(song.lyrics);
                        });
                        
                        if (validSongs.length === 0) {
                            throw new Error('æ’­æ”¾åˆ—è¡¨ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ­Œæ›²æ•°æ®');
                        }
                        
                        // æ¸…ç©ºå½“å‰æ’­æ”¾åˆ—è¡¨
                        this.clearPlaylist(true); // ä½¿ç”¨force=trueæ¥é¿å…ç¡®è®¤æç¤º
                        
                        // æ·»åŠ å¯¼å…¥çš„æ­Œæ›²
                        validSongs.forEach(songData => {
                            this.addSong({
                                name: songData.name,
                                lyrics: songData.lyrics,
                                duration: songData.duration || 0
                            });
                        });
                        
                        this.showNotification(`æˆåŠŸå¯¼å…¥ ${validSongs.length} é¦–æ­Œæ›²`, 'success');
                        
                    } catch (error) {
                        console.error('å¯¼å…¥æ’­æ”¾åˆ—è¡¨å¤±è´¥:', error);
                        this.showNotification(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = () => {
                    this.showNotification('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                };
                
                reader.readAsText(file, 'UTF-8');
            }
            
            clearPlaylist(force = false) {
                if (this.songs.length === 0) {
                    if (!force) this.showNotification('æ’­æ”¾åˆ—è¡¨å·²ç»ä¸ºç©º', 'info');
                    return;
                }
                
                if (force || confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${this.songs.length} é¦–æ­Œæ›²å—ï¼Ÿ`)) {
                    this.pause();
                    // æ¸…ç†æ‰€æœ‰æ­Œæ›²çš„éŸ³é¢‘èµ„æº
                    this.songs.forEach(song => {
                        if (song.audioElement) {
                            song.audioElement.pause();
                            song.audioElement.src = '';
                            if (song.audioElement._blobUrl) {
                                this.revokeObjectUrl(song.audioElement._blobUrl);
                            }
                        }
                    });

                    this.songs = [];
                    this.currentSongIndex = -1;
                    this.updatePlaylist();
                    this.updateStatusIndicator();
                    this.showLyrics('è¯·ä¸Šä¼ LRCæ­Œè¯æ–‡ä»¶', 'å¼€å§‹ä½ çš„æ¼”å‡º');
                    this.songInfo.style.display = 'none';
                    this.currentSongInfo.style.display = 'none';
                    this.playButton.disabled = true;
                    if (!force) this.showNotification('æ’­æ”¾åˆ—è¡¨å·²æ¸…ç©º', 'success');
                }
            }
            
            // åŒæ­¥æ ¡å‡†åŠŸèƒ½
            adjustOffset(delta) {
                if (!this.audioMode) {
                    this.showNotification('ä»…åœ¨éŸ³é¢‘åŒæ­¥æ¨¡å¼ä¸‹å¯ç”¨', 'warning');
                    return;
                }
                
                this.audioOffset += delta;
                this.audioOffset = Math.round(this.audioOffset * 10) / 10; // ä¿ç•™ä¸€ä½å°æ•°
                this.updateOffsetDisplay();
                
                log('éŸ³é¢‘åç§»è°ƒæ•´ä¸º:', this.audioOffset, 'ç§’');
            }
            
            resetOffset() {
                if (!this.audioMode) {
                    this.showNotification('ä»…åœ¨éŸ³é¢‘åŒæ­¥æ¨¡å¼ä¸‹å¯ç”¨', 'warning');
                    return;
                }
                
                this.audioOffset = 0;
                this.updateOffsetDisplay();
                this.showNotification('åŒæ­¥åç§»å·²é‡ç½®', 'success');
            }
            
            updateOffsetDisplay() {
                const offsetDisplay = document.getElementById('offsetDisplay');
                if (offsetDisplay) {
                    const sign = this.audioOffset >= 0 ? '+' : '';
                    offsetDisplay.textContent = `${sign}${this.audioOffset.toFixed(1)}s`;
                }
            }
            
            // æ–‡ä»¶åŒ¹é…å’Œæ’­æ”¾æ¨¡å¼ç®¡ç†
            findMatchingSong(fileName) {
                // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
                let matchedSong = this.songs.find(song => song.name === fileName);
                if (matchedSong) {
                    log(`ç²¾ç¡®åŒ¹é…æˆåŠŸ: "${fileName}" â† "${matchedSong.name}"`);
                    return matchedSong;
                }
                
                // æ™ºèƒ½æ¨¡ç³ŠåŒ¹é… - å¯»æ‰¾æœ€ä½³åŒ¹é…è€Œä¸æ˜¯ç¬¬ä¸€ä¸ªåŒ¹é…
                return this.findBestMatch(fileName);
            }
            
            // å¯»æ‰¾æœ€ä½³åŒ¹é…çš„æ­Œæ›²
            findBestMatch(fileName) {
                const candidates = [];
                
                // ä¸ºæ¯é¦–æ­Œæ›²è®¡ç®—åŒ¹é…åˆ†æ•°
                this.songs.forEach(song => {
                    const score = this.calculateMatchScore(song.name, fileName);
                    if (score > 0) {
                        candidates.push({
                            song: song,
                            score: score,
                            details: this.getMatchDetails(song.name, fileName)
                        });
                    }
                });
                
                // æŒ‰åˆ†æ•°æ’åºï¼Œé€‰æ‹©æœ€é«˜åˆ†
                candidates.sort((a, b) => b.score - a.score);
                
                if (candidates.length > 0) {
                    const bestMatch = candidates[0];
                    
                    // åªæœ‰åˆ†æ•°è¶³å¤Ÿé«˜æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆåŒ¹é…
                    if (bestMatch.score >= 0.7) { // é™ä½åŒ¹é…é˜ˆå€¼åˆ°70%ä»¥æé«˜åŒ¹é…æˆåŠŸç‡
                        log(`æ™ºèƒ½åŒ¹é…æˆåŠŸ: "${fileName}" â† "${bestMatch.song.name}" (åˆ†æ•°: ${bestMatch.score.toFixed(3)}, ${bestMatch.details})`);
                        
                        // æ˜¾ç¤ºå…¶ä»–å€™é€‰é¡¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                        if (candidates.length > 1) {
                            log('å…¶ä»–å€™é€‰åŒ¹é…:', candidates.slice(1, 3).map(c => 
                                `"${c.song.name}" (${c.score.toFixed(3)})`
                            ).join(', '));
                        }
                        
                        return bestMatch.song;
                    } else {
                        log(`åŒ¹é…åˆ†æ•°è¿‡ä½: "${fileName}", æœ€ä½³å€™é€‰ "${bestMatch.song.name}" (åˆ†æ•°: ${bestMatch.score.toFixed(3)})`);
                    }
                }
                
                log(`æœªæ‰¾åˆ°åŒ¹é…: "${fileName}"`);
                return null;
            }
            
            // è®¡ç®—åŒ¹é…åˆ†æ•° (0-1ä¹‹é—´)
            calculateMatchScore(songName, targetName) {
                // å¤šé‡åŒ¹é…ç­–ç•¥ï¼Œå–æœ€é«˜åˆ†
                const scores = [];
                
                // 1. ç²¾ç¡®åŒ¹é…ï¼ˆå»é™¤æ‰©å±•åï¼‰
                const songBase = songName.replace(/\.[^/.]+$/, '');
                const targetBase = targetName.replace(/\.[^/.]+$/, '');
                if (songBase === targetBase) {
                    return 1.0; // å®Œç¾åŒ¹é…
                }
                
                // 2. æ ‡å‡†åŒ–åçš„ç²¾ç¡®åŒ¹é…
                const normalizedSong = this.normalizeForMatching(songName);
                const normalizedTarget = this.normalizeForMatching(targetName);
                if (normalizedSong === normalizedTarget && normalizedSong.length > 2) {
                    scores.push(0.95);
                }
                
                // 3. ç¼–è¾‘è·ç¦»ç›¸ä¼¼åº¦
                const similarity = this.calculateSimilarity(normalizedSong, normalizedTarget);
                scores.push(similarity);
                
                // 4. æ•°å­—å‰ç¼€åŒ¹é…ï¼ˆå¦‚æœéƒ½æœ‰æ•°å­—å‰ç¼€ï¼‰
                const songPrefix = songName.match(/^(\d+)/);
                const targetPrefix = targetName.match(/^(\d+)/);
                if (songPrefix && targetPrefix && songPrefix[1] === targetPrefix[1]) {
                    // ç›¸åŒæ•°å­—å‰ç¼€ï¼Œå¢åŠ æƒé‡
                    const nameWithoutPrefix1 = songName.replace(/^\d+[-_\s]*/, '');
                    const nameWithoutPrefix2 = targetName.replace(/^\d+[-_\s]*/, '');
                    const prefixSimilarity = this.calculateSimilarity(
                        this.normalizeForMatching(nameWithoutPrefix1),
                        this.normalizeForMatching(nameWithoutPrefix2)
                    );
                    scores.push(prefixSimilarity * 0.98); // ç•¥ä½äºå®Œç¾åŒ¹é…
                }
                
                // 5. é•¿åº¦æƒ©ç½šï¼šé•¿åº¦å·®å¼‚å¾ˆå¤§çš„åŒ¹é…é™ä½åˆ†æ•°
                const lengthRatio = Math.min(normalizedSong.length, normalizedTarget.length) / 
                                   Math.max(normalizedSong.length, normalizedTarget.length);
                const lengthPenalty = lengthRatio < 0.5 ? 0.8 : 1.0; // é•¿åº¦å·®å¼‚å¤§äº2å€æ—¶æƒ©ç½š
                
                // è¾¹ç•Œæ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æœ‰æ•ˆåˆ†æ•°ï¼Œè¿”å›0
                if (scores.length === 0) {
                    return 0;
                }
                
                const maxScore = Math.max(...scores);
                return maxScore * lengthPenalty;
            }
            
            // è·å–åŒ¹é…è¯¦æƒ…ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            getMatchDetails(songName, targetName) {
                const details = [];
                
                if (songName.replace(/\.[^/.]+$/, '') === targetName.replace(/\.[^/.]+$/, '')) {
                    details.push('ç²¾ç¡®åŒ¹é…');
                } else {
                    const normalizedSong = this.normalizeForMatching(songName);
                    const normalizedTarget = this.normalizeForMatching(targetName);
                    
                    if (normalizedSong === normalizedTarget) {
                        details.push('æ ‡å‡†åŒ–ååŒ¹é…');
                    } else {
                        const similarity = this.calculateSimilarity(normalizedSong, normalizedTarget);
                        details.push(`ç›¸ä¼¼åº¦${Math.round(similarity * 100)}%`);
                    }
                    
                    const songPrefix = songName.match(/^(\d+)/);
                    const targetPrefix = targetName.match(/^(\d+)/);
                    if (songPrefix && targetPrefix && songPrefix[1] === targetPrefix[1]) {
                        details.push(`æ•°å­—å‰ç¼€${songPrefix[1]}`);
                    }
                }
                
                return details.join(', ');
            }
            
            // æ ‡å‡†åŒ–æ–‡ä»¶åç”¨äºåŒ¹é…
            normalizeForMatching(name) {
                return name
                    .replace(/\.[^.]*$/, '') // å»é™¤æ‰©å±•å
                    .replace(/^\d+[-_\s]*/, '') // å»é™¤æ•°å­—å‰ç¼€ (å¦‚ "01_", "1-", "001 ")
                    .replace(/[-_\s]+/g, '') // å»é™¤è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ã€ç©ºæ ¼
                    .toLowerCase() // è½¬å°å†™
                    .trim();
            }
            
            // æ ¼å¼åŒ–æ­Œæ›²åç§°ç”¨äºä¸»é¡µé¢æ˜¾ç¤ºï¼ˆå»é™¤æ•°å­—å‰ç¼€å’Œä¸‹åˆ’çº¿ï¼‰
            formatSongNameForDisplay(name) {
                return name
                    .replace(/\.[^.]*$/, '') // å»é™¤æ‰©å±•å
                    .replace(/^\d+[-_\s]*/, '') // å»é™¤æ•°å­—å‰ç¼€ (å¦‚ "01_", "1-", "001 ")
                    .trim();
            }
            
            fuzzyMatch(songName, targetName) {
                // ä½¿ç”¨æ–°çš„åŒ¹é…åˆ†æ•°ç³»ç»Ÿ
                const score = this.calculateMatchScore(songName, targetName);
                return score >= 0.85; // 85%ä»¥ä¸Šç›¸ä¼¼åº¦è®¤ä¸ºåŒ¹é…
            }
            
            calculateSimilarity(str1, str2) {
                if (str1 === str2) return 1;
                if (str1.length === 0 || str2.length === 0) return 0;
                
                const maxLength = Math.max(str1.length, str2.length);
                const editDistance = this.levenshteinDistance(str1, str2);
                return (maxLength - editDistance) / maxLength;
            }
            
            levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // substitution
                                matrix[i][j - 1] + 1,     // insertion
                                matrix[i - 1][j] + 1      // deletion
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }
            
            // è·å–æ­Œæ›²å¯ç”¨çš„æ’­æ”¾æ¨¡å¼
            getAvailableModes(song) {
                const modes = [];
                
                if (song.lyrics && song.lyrics.length > 0) {
                    modes.push('lyrics');
                }
                
                if (song.audioFile && song.audioElement) {
                    modes.push('audio');
                    
                    // åªæœ‰åŒæ—¶æœ‰æ­Œè¯å’ŒéŸ³é¢‘æ‰èƒ½åŒæ­¥
                    if (song.lyrics && song.lyrics.length > 0) {
                        modes.push('sync');
                    }
                }
                
                return modes;
            }
            
            // è·å–æ­Œæ›²çš„å®é™…æ’­æ”¾æ¨¡å¼ï¼ˆç”¨æˆ·é€‰æ‹© + æ™ºèƒ½å›é€€ï¼‰
            getEffectiveMode(song) {
                const userMode = song.userMode || 'auto';
                const availableModes = this.getAvailableModes(song);
                
                if (userMode === 'auto') {
                    return this.getAutoDetectedMode(song);
                }
                
                // æ£€æŸ¥ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼æ˜¯å¦å¯ç”¨
                if (availableModes.includes(userMode)) {
                    return userMode;
                }
                
                // å›é€€åˆ°è‡ªåŠ¨æ¨¡å¼
                return this.getAutoDetectedMode(song);
            }
            
            // è‡ªåŠ¨æ£€æµ‹æ¨¡å¼ï¼ˆåŸgetSongModeé€»è¾‘ï¼‰
            getAutoDetectedMode(song) {
                if (song.audioFile && song.lyrics && song.lyrics.length > 0) return 'sync';
                if (song.audioFile) return 'audio';
                return 'lyrics';
            }
            
            getSongMode(song) {
                // ä¿æŒå‘åå…¼å®¹ï¼Œä½¿ç”¨æ–°çš„getEffectiveMode
                return this.getEffectiveMode(song);
            }
            
            updateSongMode(song) {
                song.mode = this.getSongMode(song);
                return song.mode;
            }
            
            // åˆ›å»ºæ¨¡å¼é€‰æ‹©å™¨HTML
            createModeSelector(song, index) {
                const availableModes = this.getAvailableModes(song);
                const currentUserMode = song.userMode || 'auto';
                
                const modeOptions = {
                    'auto': { icon: 'ğŸ”„', label: 'è‡ªåŠ¨', available: true },
                    'lyrics': { icon: 'ğŸ“', label: 'æ­Œè¯', available: availableModes.includes('lyrics') },
                    'audio': { icon: 'ğŸµ', label: 'éŸ³é¢‘', available: availableModes.includes('audio') },
                    'sync': { icon: 'ğŸ¶', label: 'åŒæ­¥', available: availableModes.includes('sync') }
                };
                
                let selectorHTML = `<select class="mode-selector" data-song-index="${index}">`;
                
                for (const [mode, config] of Object.entries(modeOptions)) {
                    if (config.available) {
                        const selected = mode === currentUserMode ? 'selected' : '';
                        selectorHTML += `<option value="${mode}" ${selected}>${config.icon}</option>`;
                    }
                }
                
                selectorHTML += `</select>`;
                return selectorHTML;
            }
            
            // è·å–æ¨¡å¼æ˜¾ç¤ºåç§°
            getModeDisplayName(mode) {
                const modeNames = {
                    'auto': 'è‡ªåŠ¨',
                    'lyrics': 'æ­Œè¯',
                    'audio': 'éŸ³é¢‘',
                    'sync': 'åŒæ­¥'
                };
                return modeNames[mode] || mode;
            }
            
            // åˆ‡æ¢æ­Œæ›²æ’­æ”¾æ¨¡å¼
            changeSongMode(songIndex, newMode) {
                if (songIndex < 0 || songIndex >= this.songs.length) return;
                
                const song = this.songs[songIndex];
                const oldMode = song.userMode || 'auto';
                song.userMode = newMode;
                
                // å¦‚æœæ­£åœ¨æ’­æ”¾è¿™é¦–æ­Œï¼Œç«‹å³åº”ç”¨æ¨¡å¼åˆ‡æ¢
                if (this.currentSongIndex === songIndex && this.isPlaying) {
                    this.applyModeChange(song);
                }
                
                // æ›´æ–°UIæ˜¾ç¤º
                this.updatePlaylist();
                this.showNotification(
                    `"${song.name}" å·²åˆ‡æ¢åˆ°${this.getModeDisplayName(newMode)}æ¨¡å¼`, 
                    'success'
                );
                
                log(`æ­Œæ›² "${song.name}" æ¨¡å¼ä» ${oldMode} åˆ‡æ¢åˆ° ${newMode}`);
            }
            
            // åº”ç”¨æ¨¡å¼åˆ‡æ¢åˆ°å½“å‰æ’­æ”¾çš„æ­Œæ›²
            applyModeChange(song) {
                const effectiveMode = this.getEffectiveMode(song);
                const wasPlaying = this.isPlaying;
                const currentTime = this.currentTime;
                
                log('åº”ç”¨æ¨¡å¼åˆ‡æ¢:', effectiveMode);
                
                // æš‚åœå½“å‰æ’­æ”¾
                this.pause();
                
                // é‡æ–°è®¾ç½®æ’­æ”¾æ¨¡å¼
                this.setupPlaybackMode(song, effectiveMode);
                
                // æ¢å¤æ’­æ”¾çŠ¶æ€
                if (wasPlaying) {
                    const timerId = setTimeout(() => {
                        this.setCurrentTime(currentTime);
                        this.play();
                    }, 100);
                    this.addTimer(timerId);
                }
            }
            
            // è®¾ç½®æ’­æ”¾æ¨¡å¼ï¼ˆé‡æ–°ç»„ç»‡æ’­æ”¾é€»è¾‘ï¼‰
            setupPlaybackMode(song, mode) {
                // æ¸…ç†ä¹‹å‰çš„éŸ³é¢‘
                if (this.audioElement) {
                    this.audioElement.pause();
                }
                
                // æ ¹æ®æ¨¡å¼è®¾ç½®æ’­æ”¾ç¯å¢ƒ
                switch (mode) {
                    case 'sync':
                        if (song.audioElement) {
                            this.audioElement = song.audioElement;
                            this.audioMode = true;
                        }
                        break;
                    case 'audio':
                        if (song.audioElement) {
                            this.audioElement = song.audioElement;
                            this.audioMode = true;
                        }
                        break;
                    case 'lyrics':
                    default:
                        this.audioMode = false;
                        this.audioElement = null;
                        break;
                }
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                this.updateSongDisplay();
                this.updateAudioMode();
            }
            
            // æ­Œè¯æ‰‹åŠ¨è·³è½¬åŠŸèƒ½
            jumpToLyric(lyricIndex) {
                const song = this.songs[this.currentSongIndex];
                if (!song || !song.lyrics || lyricIndex < 0 || lyricIndex >= song.lyrics.length) {
                    return false;
                }
                
                // è·å–ç›®æ ‡æ—¶é—´
                const targetTime = song.lyrics[lyricIndex].time;
                
                // è·³è½¬åˆ°æŒ‡å®šæ—¶é—´
                this.setCurrentTime(targetTime);
                
                // æ¸…é™¤æ­Œè¯ç¼“å­˜ä»¥ç¡®ä¿ç«‹å³æ›´æ–°
                this.lyricsCache.clear();
                
                // å¼ºåˆ¶æ›´æ–°æ­Œè¯ç´¢å¼•å’Œæ˜¾ç¤º
                this.currentLyricIndex = lyricIndex;
                
                // å¼ºåˆ¶æ›´æ–°æ˜¾ç¤º
                const currentLyric = song.lyrics[lyricIndex].text;
                const nextLyric = lyricIndex < song.lyrics.length - 1 ? song.lyrics[lyricIndex + 1].text : '';
                this.showLyrics(currentLyric, nextLyric);
                
                // æ›´æ–°è¿›åº¦æ¡
                this.updateProgress();
                
                // æ›´æ–°æ­Œè¯è¿›åº¦æŒ‡ç¤ºå™¨
                this.updateLyricProgress();
                
                log(`è·³è½¬åˆ°ç¬¬ ${lyricIndex + 1} å¥: "${currentLyric}"`);
                return true;
            }
            
            // ä¸‹ä¸€å¥æ­Œè¯
            nextLyric() {
                const song = this.songs[this.currentSongIndex];
                if (!song || !song.lyrics) return false;
                
                if (this.currentLyricIndex < song.lyrics.length - 1) {
                    return this.jumpToLyric(this.currentLyricIndex + 1);
                }
                return false;
            }
            
            // ä¸Šä¸€å¥æ­Œè¯
            previousLyric() {
                if (this.currentLyricIndex > 0) {
                    return this.jumpToLyric(this.currentLyricIndex - 1);
                }
                return false;
            }
            
            // è·³è½¬åˆ°ç¬¬ä¸€å¥
            firstLyric() {
                return this.jumpToLyric(0);
            }
            
            // è·³è½¬åˆ°æœ€åä¸€å¥
            lastLyric() {
                const song = this.songs[this.currentSongIndex];
                if (!song || !song.lyrics) return false;
                
                return this.jumpToLyric(song.lyrics.length - 1);
            }
            
            // è·å–å½“å‰æ­Œè¯è¿›åº¦ä¿¡æ¯
            getLyricProgress() {
                const song = this.songs[this.currentSongIndex];
                if (!song || !song.lyrics) return null;
                
                return {
                    current: this.currentLyricIndex + 1,
                    total: song.lyrics.length,
                    progress: (this.currentLyricIndex + 1) / song.lyrics.length
                };
            }
            
            // æ˜¾ç¤ºæ­Œè¯è·³è½¬é€šçŸ¥
            showLyricJumpNotification(action) {
                const progress = this.getLyricProgress();
                if (!progress) return;
                
                const song = this.songs[this.currentSongIndex];
                const currentLyric = song.lyrics[this.currentLyricIndex];
                
                const message = `${action} (${progress.current}/${progress.total}): ${currentLyric.text}`;
                this.showNotification(message, 'info');
            }
            
            // æ›´æ–°æ­Œè¯è¿›åº¦æŒ‡ç¤ºå™¨
            updateLyricProgress() {
                const progress = this.getLyricProgress();
                const lyricProgressEl = document.getElementById('lyricProgress');
                const lyricProgressText = document.getElementById('lyricProgressText');
                
                if (!progress || !lyricProgressEl || !lyricProgressText) {
                    if (lyricProgressEl) lyricProgressEl.style.display = 'none';
                    return;
                }
                
                const song = this.songs[this.currentSongIndex];
                const songMode = this.getEffectiveMode(song);
                
                // åªåœ¨æœ‰æ­Œè¯çš„æ¨¡å¼ä¸‹æ˜¾ç¤ºè¿›åº¦
                if (songMode === 'lyrics' || songMode === 'sync') {
                    lyricProgressEl.style.display = 'block';
                    lyricProgressText.textContent = `æ­Œè¯ ${progress.current} / ${progress.total}`;
                } else {
                    lyricProgressEl.style.display = 'none';
                }
            }
            
            // é˜²æ­¢å±å¹•ç†„å±åŠŸèƒ½
            async requestWakeLock() {
                if (!this.wakeLockSupported) {
                    log('æµè§ˆå™¨ä¸æ”¯æŒScreen Wake Lock API');
                    return;
                }
                
                try {
                    if (this.wakeLock) {
                        await this.wakeLock.release();
                    }
                    
                    this.wakeLock = await navigator.wakeLock.request('screen');
                    log('å·²å¯ç”¨å±å¹•ä¿æŒå”¤é†’');
                    
                    // ç›‘å¬å”¤é†’é”é‡Šæ”¾äº‹ä»¶
                    this.wakeLock.addEventListener('release', () => {
                        log('å±å¹•å”¤é†’é”å·²é‡Šæ”¾');
                        this.wakeLock = null;
                    });
                    
                    this.showNotification('å·²å¯ç”¨å±å¹•ä¿æŒå”¤é†’', 'success');
                } catch (err) {
                    console.error('æ— æ³•å¯ç”¨å±å¹•ä¿æŒå”¤é†’:', err);
                    this.showNotification('æ— æ³•å¯ç”¨å±å¹•ä¿æŒå”¤é†’', 'warning');
                }
            }
            
            async releaseWakeLock() {
                if (this.wakeLock) {
                    try {
                        await this.wakeLock.release();
                        this.wakeLock = null;
                        log('å·²é‡Šæ”¾å±å¹•å”¤é†’é”');
                        this.showNotification('å·²å…è®¸å±å¹•ç†„å±', 'info');
                    } catch (err) {
                        console.error('é‡Šæ”¾å±å¹•å”¤é†’é”å¤±è´¥:', err);
                    }
                }
            }
            
            // æ£€æŸ¥å¹¶å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
            handleVisibilityChange() {
                if (document.hidden) {
                    // é¡µé¢éšè—æ—¶ä¸éœ€è¦ç‰¹åˆ«å¤„ç†ï¼ŒwakeLockä¼šè‡ªåŠ¨é‡Šæ”¾
                } else {
                    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°è¯·æ±‚å”¤é†’é”
                    if (this.isPlaying) {
                        this.requestWakeLock();
                    }
                }
            }
            
            // å¤„ç†æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
            processFolderFiles(files, type) {
                if (files.length === 0) {
                    this.showNotification('æ–‡ä»¶å¤¹ä¸ºç©º', 'warning');
                    return;
                }
                
                let validFiles = [];
                let totalFiles = files.length;
                let processedFiles = 0;
                
                // æ ¹æ®ç±»å‹è¿‡æ»¤æ–‡ä»¶
                if (type === 'lyrics') {
                    validFiles = files.filter(file => 
                        file.name.toLowerCase().endsWith('.lrc') || 
                        file.name.toLowerCase().endsWith('.txt')
                    );
                } else if (type === 'audio') {
                    validFiles = files.filter(file => {
                        const ext = file.name.toLowerCase().split('.').pop();
                        return ['mp3', 'wav', 'flac', 'ogg', 'aac', 'm4a', 'mp4'].includes(ext);
                    });
                }
                
                log(`æ–‡ä»¶å¤¹æ‰«æå®Œæˆ: æ€»æ–‡ä»¶ ${totalFiles} ä¸ª, æœ‰æ•ˆ${type === 'lyrics' ? 'æ­Œè¯' : 'éŸ³é¢‘'}æ–‡ä»¶ ${validFiles.length} ä¸ª`);
                
                if (validFiles.length === 0) {
                    const fileTypeName = type === 'lyrics' ? 'æ­Œè¯æ–‡ä»¶ (.lrc/.txt)' : 'éŸ³é¢‘æ–‡ä»¶';
                    this.showNotification(`æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°${fileTypeName}`, 'warning');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½è¿›åº¦
                this.showNotification(`æ­£åœ¨åŠ è½½ ${validFiles.length} ä¸ª${type === 'lyrics' ? 'æ­Œè¯' : 'éŸ³é¢‘'}æ–‡ä»¶...`, 'info');
                
                // æŒ‰æ–‡ä»¶å¤¹è·¯å¾„åˆ†ç»„æ˜¾ç¤º
                const folderGroups = {};
                validFiles.forEach(file => {
                    const folderPath = file.webkitRelativePath ? file.webkitRelativePath.split('/').slice(0, -1).join('/') : 'æ ¹ç›®å½•';
                    if (!folderGroups[folderPath]) {
                        folderGroups[folderPath] = [];
                    }
                    folderGroups[folderPath].push(file);
                });
                
                // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„ä¿¡æ¯
                log('æ–‡ä»¶å¤¹ç»“æ„:');
                Object.keys(folderGroups).forEach(folder => {
                    log(`  ğŸ“ ${folder}: ${folderGroups[folder].length} ä¸ªæ–‡ä»¶`);
                });
                
                // åŠ è½½æ–‡ä»¶
                if (type === 'lyrics') {
                    this.loadLrcFiles(validFiles);
                } else if (type === 'audio') {
                    this.loadAudioFiles(validFiles);
                }
                
                // æˆåŠŸæç¤º
                const folderCount = Object.keys(folderGroups).length;
                const folderText = folderCount > 1 ? ` (æ¥è‡ª ${folderCount} ä¸ªæ–‡ä»¶å¤¹)` : '';
                this.showNotification(
                    `æˆåŠŸåŠ è½½ ${validFiles.length} ä¸ª${type === 'lyrics' ? 'æ­Œè¯' : 'éŸ³é¢‘'}æ–‡ä»¶${folderText}`, 
                    'success'
                );
                
                // å¦‚æœæ˜¯éŸ³é¢‘æ–‡ä»¶ï¼Œæ˜¾ç¤ºåŒ¹é…æŠ¥å‘Šå¹¶è‡ªåŠ¨æ’åº
                if (type === 'audio') {
                    const timerId = setTimeout(() => {
                        this.showMatchingReport();
                        // è‡ªåŠ¨æ’åºæ­Œæ›²åˆ—è¡¨
                        this.sortPlaylist();
                        this.updatePlaylist();
                        this.showNotification('æ­Œæ›²åˆ—è¡¨å·²è‡ªåŠ¨æ’åº', 'success');
                    }, 1000);
                    this.addTimer(timerId);
                } else if (type === 'lyrics') {
                    // å¦‚æœåªæ˜¯åŠ è½½æ­Œè¯æ–‡ä»¶ï¼Œä¹Ÿè¿›è¡Œæ’åº
                    const timerId = setTimeout(() => {
                        this.sortPlaylist();
                        this.updatePlaylist();
                        this.showNotification('æ­Œæ›²åˆ—è¡¨å·²è‡ªåŠ¨æ’åº', 'success');
                    }, 500);
                    this.addTimer(timerId);
                }
            }
            
            // æ˜¾ç¤ºåŒ¹é…æŠ¥å‘Š
            showMatchingReport() {
                const syncSongs = this.songs.filter(song => song.mode === 'sync');
                const audioOnlySongs = this.songs.filter(song => song.mode === 'audio');
                const lyricsOnlySongs = this.songs.filter(song => song.mode === 'lyrics');
                
                log('ğŸµ æ–‡ä»¶åŒ¹é…æŠ¥å‘Š:');
                log(`- åŒæ­¥æ¨¡å¼ (æœ‰æ­Œè¯+éŸ³é¢‘): ${syncSongs.length} é¦–`);
                log(`- çº¯éŸ³é¢‘æ¨¡å¼: ${audioOnlySongs.length} é¦–`);
                log(`- çº¯æ­Œè¯æ¨¡å¼: ${lyricsOnlySongs.length} é¦–`);
                log(`- æ€»è®¡: ${this.songs.length} é¦–æ­Œæ›²`);
                
                if (syncSongs.length > 0) {
                    log('\nâœ… æˆåŠŸåŒ¹é…çš„æ­Œæ›²:');
                    syncSongs.forEach((song, index) => {
                        log(`  ${index + 1}. "${song.name}" (åŒæ­¥æ¨¡å¼)`);
                    });
                }
                
                if (audioOnlySongs.length > 0) {
                    log('\nğŸ¶ æœªåŒ¹é…çš„éŸ³é¢‘æ–‡ä»¶:');
                    audioOnlySongs.forEach((song, index) => {
                        log(`  ${index + 1}. "${song.name}" (çº¯éŸ³é¢‘)`);
                    });
                }
                
                if (lyricsOnlySongs.length > 0) {
                    log('\nğŸ“ æœªåŒ¹é…çš„æ­Œè¯æ–‡ä»¶:');
                    lyricsOnlySongs.forEach((song, index) => {
                        log(`  ${index + 1}. "${song.name}" (çº¯æ­Œè¯)`);
                    });
                }
                
                // æ˜¾ç¤ºåŒ¹é…ç»Ÿè®¡é€šçŸ¥
                const matchRate = syncSongs.length / Math.max(this.songs.length, 1);
                let message = `åŒ¹é…å®Œæˆ: ${syncSongs.length}/${this.songs.length} é¦–æ­Œæ›²æˆåŠŸé…å¯¹`;
                
                if (matchRate >= 0.8) {
                    this.showNotification(`${message} âœ¨`, 'success');
                } else if (matchRate >= 0.5) {
                    this.showNotification(`${message} âš ï¸`, 'warning');
                } else {
                    this.showNotification(`${message} - è¯·æ£€æŸ¥æ–‡ä»¶å`, 'info');
                }
            }
        }

        // åˆå§‹åŒ–æ’­æ”¾å™¨
        document.addEventListener('DOMContentLoaded', () => {
            LyricsPlayerApp.player = new LEDLyricsPlayer();
            log('LEDæ­Œè¯æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>