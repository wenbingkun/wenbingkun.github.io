<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEDæ¼”å‡ºæ­Œè¯æ˜¾ç¤ºå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', Arial, sans-serif;
            background: #000;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* èƒŒæ™¯å®¹å™¨ */
        .background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* èƒŒæ™¯é®ç½©ç¡®ä¿æ­Œè¯å¯è¯»æ€§ */
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.7) 0%,
                rgba(0, 0, 0, 0.4) 30%,
                rgba(0, 0, 0, 0.4) 70%,
                rgba(0, 0, 0, 0.7) 100%
            );
        }

        /* æ­Œæ›²ä¿¡æ¯æ˜¾ç¤º */
        .song-info {
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
        }

        .song-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
            margin-bottom: 0.5rem;
        }

        .song-index {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* ä¸»æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ */
        .lyrics-display {
            position: absolute;
            top: 15%;
            left: 5%;
            right: 5%;
            height: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }

        /* CSSå˜é‡å®šä¹‰ */
        :root {
            --font-scale: 1.3;
            --lyric-color-primary: #ffffff;
            --lyric-color-secondary: rgba(255, 255, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        /* ä¸»é¢˜é¢„è®¾ */
        .theme-classic {
            --lyric-color-primary: #ffffff;
            --lyric-color-secondary: rgba(255, 255, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        .theme-gold {
            --lyric-color-primary: #ffd700;
            --lyric-color-secondary: rgba(255, 215, 0, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 215, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        .theme-blue {
            --lyric-color-primary: #00bfff;
            --lyric-color-secondary: rgba(0, 191, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(0, 191, 255, 0.8), 0 0 40px rgba(0, 191, 255, 0.6), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(0, 191, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        .theme-rainbow {
            --lyric-color-primary: transparent;
            --lyric-color-secondary: rgba(255, 255, 255, 0.7);
            --lyric-shadow-primary: 0 0 20px rgba(255, 255, 255, 0.3), 0 8px 16px rgba(0, 0, 0, 0.8);
            --lyric-shadow-secondary: 0 0 10px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        
        /* å½“å‰æ­Œè¯ */
        .current-lyric {
            font-size: calc(8rem * var(--font-scale));
            font-weight: 900;
            color: var(--lyric-color-primary);
            text-shadow: var(--lyric-shadow-primary);
            line-height: 1.2;
            margin-bottom: 2rem;
            opacity: 1;
            transform: scale(1);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* å½©è™¹ä¸»é¢˜çš„ç‰¹æ®Šæ•ˆæœ */
        .theme-rainbow .current-lyric {
            background: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 3s ease-in-out infinite;
        }
        
        @keyframes rainbow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* ä¸‹ä¸€å¥æ­Œè¯ */
        .next-lyric {
            font-size: calc(4rem * var(--font-scale));
            font-weight: 600;
            color: var(--lyric-color-secondary);
            text-shadow: var(--lyric-shadow-secondary);
            line-height: 1.3;
            opacity: 0.8;
            transition: all 0.6s ease;
            min-height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ­Œè¯åˆ‡æ¢åŠ¨ç”» */
        .current-lyric.entering {
            animation: lyricEnter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes lyricEnter {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* æ§åˆ¶é¢æ¿ - Liquid Glass æ•ˆæœ */
        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 80vh;
            /* Liquid Glass èƒŒæ™¯ */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 255, 255, 0.02) 50%,
                rgba(0, 0, 0, 0.1) 75%,
                rgba(0, 0, 0, 0.2) 100%
            );
            /* å¤šå±‚æ¯›ç»ç’ƒæ•ˆæœ */
            backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
            -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
            /* åœ†è§’å’Œè¾¹æ¡† */
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* æ¶²æ€ç»ç’ƒè¾¹æ¡†æ•ˆæœ */
            box-shadow: 
                /* å¤–å‘å…‰ */
                0 0 60px rgba(255, 255, 255, 0.1),
                /* å†…é˜´å½±æ¨¡æ‹Ÿæ·±åº¦ */
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2),
                /* ä¸»é˜´å½± */
                0 20px 60px rgba(0, 0, 0, 0.4),
                /* ç¯å¢ƒå…‰åå°„ */
                0 5px 20px rgba(255, 255, 255, 0.05);
            
            padding: 24px;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            overflow-y: auto;
            
            /* æ¶²æ€åŠ¨ç”»æ•ˆæœ */
            animation: liquidBreathing 8s ease-in-out infinite;
        }
        
        /* æ¶²æ€å‘¼å¸åŠ¨ç”» */
        @keyframes liquidBreathing {
            0%, 100% {
                box-shadow: 
                    0 0 60px rgba(255, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.2),
                    0 20px 60px rgba(0, 0, 0, 0.4),
                    0 5px 20px rgba(255, 255, 255, 0.05);
            }
            50% {
                box-shadow: 
                    0 0 80px rgba(255, 255, 255, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.15),
                    0 25px 70px rgba(0, 0, 0, 0.3),
                    0 8px 30px rgba(255, 255, 255, 0.08);
            }
        }

        /* è§¦å‘åŒºåŸŸ */
        .trigger-zone {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 999;
            cursor: pointer;
        }

        .trigger-zone:hover + .control-panel,
        .control-panel:hover {
            transform: translateX(0);
            /* æ¿€æ´»çŠ¶æ€çš„æ¶²æ€ç»ç’ƒæ•ˆæœ */
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.08) 25%,
                rgba(255, 255, 255, 0.04) 50%,
                rgba(0, 0, 0, 0.08) 75%,
                rgba(0, 0, 0, 0.15) 100%
            );
            backdrop-filter: blur(50px) saturate(2.0) brightness(1.3);
            -webkit-backdrop-filter: blur(50px) saturate(2.0) brightness(1.3);
            box-shadow: 
                0 0 100px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1),
                0 30px 80px rgba(0, 0, 0, 0.3),
                0 10px 40px rgba(255, 255, 255, 0.1);
        }

        /* æ§åˆ¶é¢æ¿å†…å®¹ */
        .panel-title {
            color: rgba(255, 255, 255, 0.95);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .file-upload-group {
            margin-bottom: 15px;
        }

        .upload-label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
        }

        .file-input::file-selector-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            cursor: pointer;
        }

        /* å½“å‰æ’­æ”¾ä¿¡æ¯ */
        .current-song-info {
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.12) 0%,
                rgba(255, 255, 255, 0.04) 100%
            );
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 18px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .current-song-name {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .current-song-status {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .play-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.2) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .play-button:hover {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0.1) 100%
            );
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .play-button:disabled {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.02) 100%
            );
            border-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
            transform: none;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .time-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            min-width: 80px;
        }

        .progress-container {
            flex: 1;
            height: 8px;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 
                inset 0 1px 2px rgba(0, 0, 0, 0.1),
                0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 255, 255, 0.7) 50%,
                rgba(255, 255, 255, 0.9) 100%
            );
            border-radius: 6px;
            width: 0%;
            transform-origin: left;
            transition: width 0.2s ease;
            box-shadow: 
                0 0 12px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%
            );
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-container:hover .progress-bar {
            box-shadow: 
                0 0 16px rgba(255, 255, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .speed-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .speed-button, .font-size-button, .theme-button, .search-button, .play-mode-button {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .speed-button:hover, .font-size-button:hover, .theme-button:hover, .search-button:hover, .play-mode-button:hover {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.25) 0%,
                rgba(255, 255, 255, 0.1) 100%
            );
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .speed-button.active, .font-size-button.active, .theme-button.active, .play-mode-button.active {
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.4) 0%,
                rgba(255, 255, 255, 0.2) 100%
            );
            border-color: rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 1);
            box-shadow: 
                0 4px 16px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.03) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 11px;
            font-weight: 400;
            outline: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.1),
                0 0 0 2px rgba(255, 255, 255, 0.1),
                0 2px 8px rgba(255, 255, 255, 0.05);
        }
        
        .search-results {
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .search-result-item {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }
        
        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 9px;
            margin-right: 8px;
        }
        
        .search-highlight {
            background: rgba(255, 255, 0, 0.3);
            color: #fff;
            font-weight: 600;
        }
        
        /* å†…è”å¿«æ·é”®æç¤ºæ ·å¼ */
        .shortcut-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 8px;
            margin-left: 4px;
            font-weight: 500;
        }
        
        /* é€šçŸ¥ç³»ç»Ÿ */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10001;
            max-width: 300px;
        }
        
        .notification {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 4px solid;
            color: white;
            font-size: 12px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            animation-fill-mode: forwards;
            opacity: 0;
            transform: translateX(100%);
        }
        
        .notification.success {
            border-left-color: #28a745;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        .notification.warning {
            border-left-color: #ffc107;
        }
        
        .notification.info {
            border-left-color: #17a2b8;
        }
        
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* æ’­æ”¾åˆ—è¡¨ */
        .playlist-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .playlist-header {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-count {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
        }

        .playlist {
            max-height: 200px;
            overflow-y: auto;
        }

        .playlist::-webkit-scrollbar {
            width: 4px;
        }

        .playlist::-webkit-scrollbar-track {
            background: transparent;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .song-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }
        
        .song-item[draggable="true"] {
            cursor: grab;
        }
        
        .song-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(5deg);
        }
        
        .song-item.drag-over {
            border-color: rgba(0, 123, 255, 0.8);
            background: rgba(0, 123, 255, 0.1);
        }
        
        .drag-handle {
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
        }
        
        .drag-handle:hover {
            background: rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .song-item.current {
            background: rgba(0, 123, 255, 0.3);
            border-color: rgba(0, 123, 255, 0.5);
        }

        .song-index-num {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            min-width: 20px;
            text-align: center;
        }

        .song-name {
            flex: 1;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-item.current .song-name {
            color: #fff;
            font-weight: 600;
        }

        .song-duration {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            min-width: 40px;
            text-align: right;
        }

        .song-controls {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .song-item:hover .song-controls {
            opacity: 1;
        }

        .song-control-btn {
            width: 16px;
            height: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .song-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.6);
        }
        
        .playlist-action-btn {
            width: 20px;
            height: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .playlist-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .sync-button {
            padding: 2px 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            transition: all 0.2s ease;
        }
        
        .sync-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ç©ºæ’­æ”¾åˆ—è¡¨ */
        .empty-playlist {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            padding: 20px;
            font-style: italic;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            z-index: 100;
        }

        .status-indicator.ready {
            background: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }

        .status-indicator.playing {
            background: #007bff;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); }
            to { transform: scale(1.3); box-shadow: 0 0 25px rgba(0, 123, 255, 0.8); }
        }


        /* é¼ æ ‡å…‰æ ‡æ§åˆ¶ */
        body.auto-hide-cursor {
            cursor: none;
        }
        
        /* æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 123, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 2rem;
            text-align: center;
        }
        
        .drag-overlay.active {
            display: flex;
        }
        
        .drag-hint {
            padding: 2rem;
            border: 3px dashed rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1920px) {
            .current-lyric {
                font-size: 6rem;
            }
            .next-lyric {
                font-size: 3rem;
            }
            .song-title {
                font-size: 2rem;
            }
        }

        @media (max-width: 1366px) {
            .current-lyric {
                font-size: 4rem;
            }
            .next-lyric {
                font-size: 2.5rem;
            }
            .song-title {
                font-size: 1.5rem;
            }
        }

        @media (max-height: 800px) {
            .lyrics-display {
                top: 12%;
                height: 55%;
            }
            .song-info {
                top: 1%;
            }
        }

        /* å…¨å±æ¨¡å¼ä¼˜åŒ– */
        @media (orientation: landscape) and (min-width: 1920px) {
            .current-lyric {
                font-size: 10rem;
            }
            .next-lyric {
                font-size: 5rem;
            }
            .song-title {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯å®¹å™¨ -->
    <div class="background-container" id="backgroundContainer">
        <div class="background-overlay"></div>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator" id="statusIndicator"></div>

    <!-- æ­Œæ›²ä¿¡æ¯ -->
    <div class="song-info" id="songInfo" style="display: none;">
        <div class="song-title" id="displaySongTitle">æœªé€‰æ‹©æ­Œæ›²</div>
        <div class="song-index" id="displaySongIndex">0 / 0</div>
    </div>

    <!-- ä¸»æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="lyrics-display">
        <div class="current-lyric" id="currentLyric">è¯·ä¸Šä¼ LRCæ­Œè¯æ–‡ä»¶</div>
        <div class="next-lyric" id="nextLyric">å¼€å§‹ä½ çš„æ¼”å‡º</div>
    </div>

    
    <!-- æ‹–æ‹½ä¸Šä¼ è¦†ç›–å±‚ -->
    <div class="drag-overlay" id="dragOverlay">
        <div class="drag-hint">
            ğŸ¥ æ”¾å¼€æ–‡ä»¶åˆ°è¿™é‡Œ<br>
            <small>æ”¯æŒ LRC æ­Œè¯æ–‡ä»¶å’Œ MP3/WAV éŸ³é¢‘æ–‡ä»¶</small>
        </div>
    </div>
    
    <!-- é€šçŸ¥å®¹å™¨ -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- è§¦å‘åŒºåŸŸ -->
    <div class="trigger-zone"></div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="panel-title">ğŸµ æ¼”å‡ºæ§åˆ¶å°<span class="shortcut-hint">Esc å…¨å±</span></div>
        
        <div class="file-upload-group">
            <label class="upload-label">æ­Œè¯æ–‡ä»¶ (æ”¯æŒå¤šé€‰LRC)<span class="shortcut-hint">æ‹–æ‹½ä¸Šä¼ </span></label>
            <input type="file" id="lrcFile" accept=".lrc,.txt" class="file-input" multiple />
        </div>
        
        <div class="file-upload-group">
            <label class="upload-label">éŸ³é¢‘æ–‡ä»¶ (æ”¯æŒå¤šé€‰éŸ³é¢‘)<span class="shortcut-hint">æ‹–æ‹½ä¸Šä¼ </span></label>
            <input type="file" id="audioFile" accept="audio/*,video/mp4,.mp4" class="file-input" multiple />
        </div>

        <div class="file-upload-group">
            <label class="upload-label">èƒŒæ™¯å›¾ç‰‡<span class="shortcut-hint">æ‹–æ‹½ä¸Šä¼ </span></label>
            <input type="file" id="backgroundFile" accept="image/*" class="file-input" />
        </div>

        <div class="current-song-info" id="currentSongInfo" style="display: none;">
            <div class="current-song-name" id="currentSongName">æœªé€‰æ‹©æ­Œæ›²</div>
            <div class="current-song-status" id="currentSongStatus">å‡†å¤‡æ’­æ”¾</div>
        </div>

        <div class="controls-row">
            <button class="play-button" id="playButton" disabled title="æ’­æ”¾/æš‚åœ (ç©ºæ ¼é”®)">â–¶</button>
            <div class="time-info">
                <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
            </div>
            <div class="progress-container" id="progressContainer" title="ç‚¹å‡»è·³è½¬ | â†â†’ å‰å5ç§’">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="speed-controls">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">é€Ÿåº¦:</span>
            <button class="speed-button" data-speed="0.5">0.5Ã—</button>
            <button class="speed-button active" data-speed="1">1Ã—</button>
            <button class="speed-button" data-speed="1.5">1.5Ã—</button>
            <button class="speed-button" data-speed="2">2Ã—</button>
        </div>
        
        <div class="font-size-controls" style="margin-bottom: 15px;">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">å­—ä½“å¤§å°<span class="shortcut-hint">+/-</span>:</span>
            <button class="font-size-button" data-font-size="0.7">S</button>
            <button class="font-size-button" data-font-size="1">M</button>
            <button class="font-size-button active" data-font-size="1.3">L</button>
            <button class="font-size-button" data-font-size="1.6">XL</button>
            <button class="font-size-button" data-font-size="2">XXL</button>
        </div>
        
        <div class="theme-controls" style="margin-bottom: 15px;">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">æ­Œè¯ä¸»é¢˜<span class="shortcut-hint">T</span>:</span>
            <button class="theme-button active" data-theme="classic">ç»å…¸</button>
            <button class="theme-button" data-theme="gold">é»„é‡‘</button>
            <button class="theme-button" data-theme="blue">è“è‰²</button>
            <button class="theme-button" data-theme="rainbow">å½©è™¹</button>
        </div>
        
        <div class="play-mode-controls" style="margin-bottom: 15px;">
            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">æ’­æ”¾æ¨¡å¼<span class="shortcut-hint">M</span>:</span>
            <button class="play-mode-button active" data-mode="list" title="åˆ—è¡¨æ’­æ”¾">ğŸ“‹</button>
            <button class="play-mode-button" data-mode="loop" title="åˆ—è¡¨å¾ªç¯">ğŸ”</button>
            <button class="play-mode-button" data-mode="single" title="å•æ›²å¾ªç¯">ğŸ”‚</button>
            <button class="play-mode-button" data-mode="random" title="éšæœºæ’­æ”¾">ğŸ”€</button>
        </div>
        
        <div class="sync-controls" style="margin-bottom: 15px; display: none;" id="syncControls">
            <div style="color: rgba(255,255,255,0.6); font-size: 10px; margin-bottom: 5px;">åŒæ­¥æ ¡å‡†<span class="shortcut-hint">[ ]</span> (ç§’):</div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <button class="sync-button" data-offset="-1">-1s</button>
                <button class="sync-button" data-offset="-0.1">-0.1s</button>
                <span id="offsetDisplay" style="color: #fff; font-size: 11px; min-width: 40px; text-align: center;">0.0s</span>
                <button class="sync-button" data-offset="0.1">+0.1s</button>
                <button class="sync-button" data-offset="1">+1s</button>
                <button class="sync-button" id="resetOffset">é‡ç½®</button>
            </div>
        </div>
        
        <div class="search-controls" style="margin-bottom: 15px;">
            <div style="color: rgba(255,255,255,0.6); font-size: 10px; margin-bottom: 5px;">æœç´¢æ­Œè¯<span class="shortcut-hint">F</span>:</div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="text" id="lyricsSearch" placeholder="æœç´¢å½“å‰æ­Œæ›²æ­Œè¯..." class="search-input" />
                <button class="search-button" id="searchButton">ğŸ”</button>
                <button class="search-button" id="clearSearch">Ã—</button>
            </div>
            <div class="search-results" id="searchResults" style="display: none;"></div>
        </div>


        <div class="playlist-section">
            <div class="playlist-header">
                <span>æ’­æ”¾åˆ—è¡¨<span class="shortcut-hint">â†‘â†“ åˆ‡æ¢ | 1-9 å¿«é€‰</span></span>
                <span class="playlist-count" id="playlistCount">0 é¦–æ­Œæ›²</span>
            </div>
            <div class="playlist-actions" style="margin-bottom: 10px; display: flex; gap: 5px;">
                <button class="playlist-action-btn" id="exportPlaylist" title="å¯¼å‡ºæ’­æ”¾åˆ—è¡¨">ğŸ’¾</button>
                <button class="playlist-action-btn" id="importPlaylist" title="å¯¼å…¥æ’­æ”¾åˆ—è¡¨">ğŸ“‚</button>
                <button class="playlist-action-btn" id="clearPlaylist" title="æ¸…ç©ºæ’­æ”¾åˆ—è¡¨">ğŸ—‘ï¸</button>
                <input type="file" id="playlistFile" accept=".json" style="display: none;" />
            </div>
            <div class="playlist" id="playlist">
                <div class="empty-playlist">è¿˜æ²¡æœ‰æ­Œæ›²ï¼Œè¯·ä¸Šä¼ LRCæ–‡ä»¶</div>
            </div>
        </div>
    </div>

    <script>
        let player; // å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿è°ƒè¯•

        class LEDLyricsPlayer {
            constructor() {
                this.playButton = document.getElementById('playButton');
                this.progressBar = document.getElementById('progressBar');
                this.progressContainer = document.getElementById('progressContainer');
                this.currentTimeSpan = document.getElementById('currentTime');
                this.totalTimeSpan = document.getElementById('totalTime');
                this.currentLyricEl = document.getElementById('currentLyric');
                this.nextLyricEl = document.getElementById('nextLyric');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.backgroundContainer = document.getElementById('backgroundContainer');
                this.playlist = document.getElementById('playlist');
                this.playlistCount = document.getElementById('playlistCount');
                this.songInfo = document.getElementById('songInfo');
                this.displaySongTitle = document.getElementById('displaySongTitle');
                this.displaySongIndex = document.getElementById('displaySongIndex');
                this.currentSongInfo = document.getElementById('currentSongInfo');
                this.currentSongName = document.getElementById('currentSongName');
                this.currentSongStatus = document.getElementById('currentSongStatus');
                
                this.songs = []; // æ­Œæ›²åˆ—è¡¨
                this.currentSongIndex = -1; // å½“å‰æ’­æ”¾æ­Œæ›²ç´¢å¼•
                this.currentLyricIndex = -1; // å½“å‰æ­Œè¯ç´¢å¼•
                this.isPlaying = false;
                this.currentTime = 0;
                this.playbackSpeed = 1;
                this.animationId = null;
                this.startTime = null;
                this.pausedTime = 0;
                this.lastProgressUpdate = 0;
                this.lastLyricsUpdate = 0;
                this.lyricsCache = new Map();
                
                // éŸ³é¢‘æ’­æ”¾æ”¯æŒ
                this.audioElement = null;
                this.audioMode = false; // false: çº¯æ­Œè¯æ¨¡å¼, true: éŸ³é¢‘åŒæ­¥æ¨¡å¼
                this.audioOffset = 0; // éŸ³é¢‘ä¸æ­Œè¯çš„æ—¶é—´åç§»
                this.fontScale = 1.3; // å­—ä½“ç¼©æ”¾æ¯”ä¾‹
                this.currentTheme = 'classic'; // å½“å‰ä¸»é¢˜
                this.searchResults = []; // æœç´¢ç»“æœ
                this.objectUrls = new Set(); // è·Ÿè¸ªåˆ›å»ºçš„URLå¯¹è±¡
                this.eventListeners = new Map(); // è·Ÿè¸ªäº‹ä»¶ç›‘å¬å™¨
                this.timers = new Set(); // è·Ÿè¸ªå®šæ—¶å™¨
                
                // æ’­æ”¾æ¨¡å¼
                this.playMode = 'list'; // 'list': åˆ—è¡¨æ’­æ”¾, 'loop': åˆ—è¡¨å¾ªç¯, 'single': å•æ›²å¾ªç¯, 'random': éšæœºæ’­æ”¾
                this.playHistory = []; // éšæœºæ’­æ”¾å†å²è®°å½•
                
                
                // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
                
                this.initEventListeners();
                this.initCursorHiding();
                this.initDragAndDrop();
            }

            initCursorHiding() {
                let cursorTimeout;
                
                const showCursor = () => {
                    document.body.classList.remove('auto-hide-cursor');
                    clearTimeout(cursorTimeout);
                    cursorTimeout = setTimeout(() => {
                        document.body.classList.add('auto-hide-cursor');
                    }, 3000);
                };

                document.addEventListener('mousemove', showCursor);
                document.addEventListener('mousedown', showCursor);
                
                // åˆå§‹æ˜¾ç¤ºå…‰æ ‡
                showCursor();
            }


            initDragAndDrop() {
                const dragOverlay = document.getElementById('dragOverlay');
                let dragCounter = 0;
                
                // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                // æ‹–æ‹½è¿›å…¥
                document.addEventListener('dragenter', (e) => {
                    dragCounter++;
                    if (e.dataTransfer.types.includes('Files')) {
                        dragOverlay.classList.add('active');
                    }
                });
                
                // æ‹–æ‹½ç¦»å¼€
                document.addEventListener('dragleave', (e) => {
                    dragCounter--;
                    if (dragCounter <= 0) {
                        dragCounter = 0;
                        dragOverlay.classList.remove('active');
                    }
                });
                
                // æ”¾å¼€æ–‡ä»¶
                document.addEventListener('drop', (e) => {
                    dragCounter = 0;
                    dragOverlay.classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        this.handleDroppedFiles(files);
                    }
                });
            }
            
            handleDroppedFiles(files) {
                const lrcFiles = [];
                const audioFiles = [];
                const imageFiles = [];
                
                files.forEach(file => {
                    const ext = file.name.toLowerCase().split('.').pop();
                    if (ext === 'lrc' || ext === 'txt') {
                        lrcFiles.push(file);
                    } else if (ext === 'mp3' || ext === 'wav' || ext === 'ogg' || ext === 'm4a' || ext === 'mp4') {
                        audioFiles.push(file);
                    } else if (ext === 'jpg' || ext === 'jpeg' || ext === 'png' || ext === 'gif' || ext === 'webp') {
                        imageFiles.push(file);
                    }
                });
                
                // å¤„ç†æ­Œè¯æ–‡ä»¶
                if (lrcFiles.length > 0) {
                    console.log('æ‹–æ‹½ä¸Šä¼ æ­Œè¯æ–‡ä»¶:', lrcFiles.length, 'ä¸ª');
                    this.loadLrcFiles(lrcFiles);
                }
                
                // å¤„ç†éŸ³é¢‘æ–‡ä»¶
                if (audioFiles.length > 0) {
                    console.log('æ‹–æ‹½ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶:', audioFiles.length, 'ä¸ª');
                    this.loadAudioFiles(audioFiles);
                }
                
                // å¤„ç†èƒŒæ™¯å›¾ç‰‡
                if (imageFiles.length > 0) {
                    console.log('æ‹–æ‹½ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡:', imageFiles[0].name);
                    this.loadBackgroundImage(imageFiles[0]);
                }
            }

            initEventListeners() {
                // æ–‡ä»¶ä¸Šä¼ 
                document.getElementById('lrcFile').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    console.log('é€‰æ‹©äº†', files.length, 'ä¸ªæ–‡ä»¶');
                    this.loadLrcFiles(files);
                });

                document.getElementById('audioFile').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    console.log('é€‰æ‹©äº†', files.length, 'ä¸ªéŸ³é¢‘æ–‡ä»¶');
                    this.loadAudioFiles(files);
                });
                
                document.getElementById('backgroundFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        console.log('å¼€å§‹åŠ è½½èƒŒæ™¯å›¾ç‰‡:', file.name);
                        this.loadBackgroundImage(file);
                    }
                });

                // æ’­æ”¾æ§åˆ¶
                this.playButton.addEventListener('click', () => {
                    this.togglePlay();
                });

                // è¿›åº¦æ¡æ§åˆ¶
                this.progressContainer.addEventListener('click', (e) => {
                    this.seekTo(e);
                });

                // é€Ÿåº¦æ§åˆ¶
                document.querySelectorAll('.speed-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setPlaybackSpeed(parseFloat(e.target.dataset.speed));
                    });
                });
                
                // å­—ä½“å¤§å°æ§åˆ¶
                document.querySelectorAll('.font-size-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setFontScale(parseFloat(e.target.dataset.fontSize));
                    });
                });
                
                // ä¸»é¢˜æ§åˆ¶
                document.querySelectorAll('.theme-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setTheme(e.target.dataset.theme);
                    });
                });
                
                // æ’­æ”¾æ¨¡å¼æ§åˆ¶
                document.querySelectorAll('.play-mode-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setPlayMode(e.target.dataset.mode);
                    });
                });
                
                
                // æœç´¢åŠŸèƒ½
                const searchInput = document.getElementById('lyricsSearch');
                const searchButton = document.getElementById('searchButton');
                const clearSearch = document.getElementById('clearSearch');
                
                searchInput.addEventListener('input', (e) => {
                    this.searchLyrics(e.target.value);
                });
                
                searchButton.addEventListener('click', () => {
                    this.searchLyrics(searchInput.value);
                });
                
                clearSearch.addEventListener('click', () => {
                    searchInput.value = '';
                    this.clearSearch();
                });
                
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.searchLyrics(searchInput.value);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        searchInput.value = '';
                        this.clearSearch();
                    }
                });
                
                // æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
                document.getElementById('exportPlaylist').addEventListener('click', () => {
                    this.exportPlaylist();
                });
                
                document.getElementById('importPlaylist').addEventListener('click', () => {
                    document.getElementById('playlistFile').click();
                });
                
                document.getElementById('clearPlaylist').addEventListener('click', () => {
                    this.clearPlaylist();
                });
                
                document.getElementById('playlistFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.importPlaylist(file);
                        e.target.value = ''; // é‡ç½®æ–‡ä»¶é€‰æ‹©
                    }
                });
                
                // åŒæ­¥æ ¡å‡†åŠŸèƒ½
                document.querySelectorAll('.sync-button').forEach(button => {
                    if (button.id === 'resetOffset') {
                        button.addEventListener('click', () => {
                            this.resetOffset();
                        });
                    } else {
                        button.addEventListener('click', (e) => {
                            const offset = parseFloat(e.target.dataset.offset);
                            this.adjustOffset(offset);
                        });
                    }
                });

                // é”®ç›˜æ§åˆ¶
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.togglePlay();
                    } else if (e.code === 'ArrowLeft') {
                        e.preventDefault();
                        this.seek(-5);
                    } else if (e.code === 'ArrowRight') {
                        e.preventDefault();
                        this.seek(5);
                    } else if (e.code === 'ArrowUp') {
                        e.preventDefault();
                        this.switchToPreviousSong();
                    } else if (e.code === 'ArrowDown') {
                        e.preventDefault();
                        this.switchToNextSong();
                    } else if (e.code === 'Escape') {
                        this.toggleFullscreen();
                    } else if (e.key === '=' || e.key === '+') {
                        e.preventDefault();
                        this.adjustFontSize(0.1);
                    } else if (e.key === '-' || e.key === '_') {
                        e.preventDefault();
                        this.adjustFontSize(-0.1);
                    } else if (e.key === 't' || e.key === 'T') {
                        e.preventDefault();
                        this.switchTheme();
                    } else if (e.key === 'm' || e.key === 'M') {
                        e.preventDefault();
                        this.switchPlayMode();
                    } else if (e.key === 'f' || e.key === 'F') {
                        e.preventDefault();
                        document.getElementById('lyricsSearch').focus();
                    } else if (e.key === '[') {
                        e.preventDefault();
                        this.adjustOffset(-0.1);
                    } else if (e.key === ']') {
                        e.preventDefault();
                        this.adjustOffset(0.1);
                    } else if (e.code.startsWith('Digit')) {
                        const num = parseInt(e.code.replace('Digit', ''));
                        if (num >= 1 && num <= 9) {
                            e.preventDefault();
                            this.switchToSong(num - 1);
                            // æ•°å­—é”®å¿«é€Ÿé€‰æ­Œåè‡ªåŠ¨æ’­æ”¾
                            const timerId = setTimeout(() => {
                                this.play();
                            }, 100);
                            this.addTimer(timerId);
                        }
                    }
                });
            }

            loadLrcFiles(files) {
                let loadedCount = 0;
                const totalFiles = files.length;

                files.forEach(file => {
                    if (file.name.toLowerCase().endsWith('.lrc') || file.name.toLowerCase().endsWith('.txt')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const lyrics = this.parseLrc(e.target.result);
                                const song = {
                                    name: file.name.replace(/\.[^/.]+$/, ""),
                                    lyrics: lyrics,
                                    duration: lyrics.length > 0 ? lyrics[lyrics.length - 1].time + 5 : 300, // é»˜è®¤5åˆ†é’Ÿ
                                    mode: 'lyrics' // çº¯æ­Œè¯æ¨¡å¼
                                };
                                this.addSong(song);
                                
                                loadedCount++;
                                console.log(`æ­Œæ›² ${loadedCount}/${totalFiles} åŠ è½½å®Œæˆ:`, song.name);
                                if (this.showNotification) {
                                    this.showNotification(`åŠ è½½æ­Œæ›²: ${song.name}`, 'success');
                                }
                            } catch (error) {
                                console.error('æ­Œè¯è§£æé”™è¯¯:', file.name, error);
                                if (this.showNotification) {
                                    this.showNotification(`æ­Œè¯è§£æå¤±è´¥: ${file.name} - ${error.message}`, 'error');
                                }
                                loadedCount++;
                            }
                        };
                        reader.onerror = (error) => {
                            console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', file.name, error);
                            if (this.showNotification) {
                                this.showNotification(`æ–‡ä»¶è¯»å–å¤±è´¥: ${file.name}`, 'error');
                            }
                            loadedCount++;
                        };
                        reader.readAsText(file, 'UTF-8');
                    } else {
                        console.warn('è·³è¿‡éLRCæ–‡ä»¶:', file.name);
                        loadedCount++;
                    }
                });
            }

            loadAudioFiles(files) {
                let loadedCount = 0;
                const totalFiles = files.length;

                files.forEach((file, index) => {
                    if (file.name.toLowerCase().match(/\.(mp3|wav|ogg|m4a|aac|flac|mp4)$/)) {
                        // é”™å¼€åŠ è½½æ—¶é—´ï¼Œé¿å…åŒæ—¶åˆ›å»ºå¤ªå¤šéŸ³é¢‘å…ƒç´ 
                        setTimeout(() => {
                            this.loadAudioFile(file, true); // skipCleanup = true
                        }, index * 50); // 50msé—´éš”
                        
                        loadedCount++;
                    } else {
                        console.warn('è·³è¿‡ééŸ³é¢‘æ–‡ä»¶:', file.name);
                    }
                });

                if (loadedCount > 0) {
                    this.showNotification(`å¼€å§‹åŠ è½½ ${loadedCount} ä¸ªéŸ³é¢‘æ–‡ä»¶`, 'info');
                } else {
                    this.showNotification('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶', 'warning');
                }
            }

            loadAudioFile(file, skipCleanup = false) {
                // å¦‚æœä¸æ˜¯æ‰¹é‡æ¨¡å¼ï¼Œåˆ™é‡Šæ”¾ä¹‹å‰çš„éŸ³é¢‘èµ„æº
                if (!skipCleanup) {
                    this.cleanupAudio();
                }
                
                // åˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ 
                this.audioElement = new Audio();
                const url = URL.createObjectURL(file);
                this.objectUrls.add(url); // è®°å½•URLä»¥ä¾¿æ¸…ç†
                this.audioElement.src = url;
                
                // éŸ³é¢‘äº‹ä»¶ç›‘å¬
                this.audioElement.addEventListener('loadedmetadata', () => {
                    console.log('éŸ³é¢‘æ–‡ä»¶åŠ è½½æˆåŠŸ, æ—¶é•¿:', this.formatTime(this.audioElement.duration));
                    
                    // åˆ›å»ºéŸ³é¢‘æ­Œæ›²å¯¹è±¡
                    const audioSong = {
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        audioFile: file,
                        duration: this.audioElement.duration,
                        mode: 'audio', // çº¯éŸ³é¢‘æ¨¡å¼
                        audioElement: this.audioElement
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰åŒåæ­Œè¯æ–‡ä»¶
                    const matchedSong = this.findMatchingSong(audioSong.name);
                    if (matchedSong) {
                        // å‡çº§ä¸ºåŒæ­¥æ¨¡å¼
                        matchedSong.audioFile = file;
                        matchedSong.audioElement = this.audioElement;
                        matchedSong.mode = 'sync';
                        matchedSong.duration = Math.max(matchedSong.duration, this.audioElement.duration);
                        this.audioMode = true;
                        this.currentAudioSong = matchedSong;
                        if (this.showNotification) {
                            const isExactMatch = matchedSong.name === audioSong.name;
                            const message = isExactMatch 
                                ? `æ£€æµ‹åˆ°åŒåæ–‡ä»¶ï¼Œå·²åˆ‡æ¢åˆ°åŒæ­¥æ¨¡å¼: ${audioSong.name}`
                                : `æ™ºèƒ½åŒ¹é…åˆ°æ­Œè¯æ–‡ä»¶ "${matchedSong.name}"ï¼Œå·²åˆ‡æ¢åˆ°åŒæ­¥æ¨¡å¼`;
                            this.showNotification(message, 'success');
                        }
                    } else {
                        // çº¯éŸ³é¢‘æ¨¡å¼
                        this.addSong(audioSong);
                        this.audioMode = false;
                        this.currentAudioSong = audioSong;
                        if (this.showNotification) {
                            this.showNotification(`éŸ³é¢‘åŠ è½½æˆåŠŸ: ${file.name}`, 'success');
                        }
                    }
                    
                    this.updatePlaylist();
                    
                    // æ›´æ–°å½“å‰æ­Œæ›²çš„è¿›åº¦æ˜¾ç¤º
                    if (this.currentSongIndex >= 0 && this.songs[this.currentSongIndex] === audioSong) {
                        this.updateProgress();
                    }
                });
                
                this.audioElement.addEventListener('error', (e) => {
                    console.error('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥:', e);
                    this.audioMode = false;
                    this.updateAudioMode();
                    if (this.showNotification) {
                        this.showNotification(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${file.name}`, 'error');
                    }
                });
                
                this.audioElement.addEventListener('timeupdate', () => {
                    if (this.audioMode && this.isPlaying) {
                        this.syncWithAudio();
                    }
                });
                
                this.audioElement.addEventListener('ended', () => {
                    this.onSongEnded();
                });
            }
            
            updateAudioMode() {
                const syncControls = document.getElementById('syncControls');
                
                if (this.currentSongIndex >= 0 && this.currentSongIndex < this.songs.length) {
                    const currentSong = this.songs[this.currentSongIndex];
                    const songMode = this.getSongMode(currentSong);
                    
                    switch(songMode) {
                        case 'sync':
                            this.currentSongStatus.textContent = 'åŒæ­¥æ¨¡å¼ (éŸ³é¢‘+æ­Œè¯)';
                            syncControls.style.display = 'block';
                            this.updateOffsetDisplay();
                            break;
                        case 'audio':
                            this.currentSongStatus.textContent = 'çº¯éŸ³é¢‘æ¨¡å¼';
                            syncControls.style.display = 'none';
                            break;
                        case 'lyrics':
                            this.currentSongStatus.textContent = 'çº¯æ­Œè¯æ¨¡å¼ (æ‰‹åŠ¨æ§åˆ¶)';
                            syncControls.style.display = 'none';
                            break;
                        default:
                            this.currentSongStatus.textContent = this.isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ';
                            syncControls.style.display = 'none';
                    }
                } else {
                    this.currentSongStatus.textContent = 'å‡†å¤‡æ’­æ”¾';
                    syncControls.style.display = 'none';
                }
            }
            
            syncWithAudio() {
                if (this.audioElement && this.audioMode) {
                    this.currentTime = this.audioElement.currentTime + this.audioOffset;
                    // å¼ºåˆ¶æ›´æ–°è¿›åº¦æ¡å’Œæ­Œè¯
                    requestAnimationFrame(() => {
                        this.updateProgress();
                        this.updateLyricsDisplay();
                    });
                }
            }

            loadBackgroundImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // é‡Šæ”¾ä¹‹å‰çš„èƒŒæ™¯å›¾ç‰‡URL
                        const currentBg = this.backgroundContainer.style.backgroundImage;
                        if (currentBg && currentBg.includes('blob:')) {
                            const match = currentBg.match(/url\("?([^"\)]+)"?\)/);
                            if (match && match[1]) {
                                this.revokeObjectUrl(match[1]);
                            }
                        }
                        
                        this.backgroundContainer.style.backgroundImage = `url(${e.target.result})`;
                        console.log('èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ');
                        if (this.showNotification) {
                            this.showNotification(`èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ: ${file.name}`, 'success');
                        }
                    } catch (error) {
                        console.error('èƒŒæ™¯å›¾ç‰‡å¤„ç†é”™è¯¯:', error);
                        if (this.showNotification) {
                            this.showNotification('èƒŒæ™¯å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
                        }
                    }
                };
                reader.onerror = (error) => {
                    console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                    if (this.showNotification) {
                        this.showNotification(`èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.name}`, 'error');
                    }
                };
                reader.readAsDataURL(file);
            }

            parseLrc(lrcContent) {
                const lyrics = [];
                const lines = lrcContent.split('\n');
                
                if (!lrcContent || typeof lrcContent !== 'string') {
                    throw new Error('æ— æ•ˆçš„æ­Œè¯æ–‡ä»¶å†…å®¹');
                }
                
                lines.forEach((line, index) => {
                    try {
                        const match = line.match(/\[(\d+):(\d+)(?:\.(\d+))?\](.*)/);
                        if (match) {
                            const minutes = parseInt(match[1]);
                            const seconds = parseInt(match[2]);
                            const centiseconds = match[3] ? parseInt(match[3].padEnd(2, '0').slice(0, 2)) : 0;
                            const text = match[4].trim();
                            
                            if (isNaN(minutes) || isNaN(seconds) || minutes < 0 || seconds < 0 || seconds >= 60) {
                                throw new Error(`ç¬¬${index + 1}è¡Œæ—¶é—´æ ¼å¼é”™è¯¯: ${line}`);
                            }
                            
                            const time = minutes * 60 + seconds + centiseconds / 100;
                            lyrics.push({ time, text: text || 'â™ª' });
                        }
                    } catch (error) {
                        console.warn(`è§£ææ­Œè¯ç¬¬${index + 1}è¡Œå¤±è´¥:`, line, error.message);
                    }
                });

                return lyrics.sort((a, b) => a.time - b.time);
            }

            addSong(song) {
                this.songs.push(song);
                console.log('æ­Œæ›²æ·»åŠ åˆ°åˆ—è¡¨:', song.name, 'æ€»æ—¶é•¿:', this.formatTime(song.duration));
                this.updatePlaylist();
                this.updateStatusIndicator();
                
                // å¦‚æœè¿™æ˜¯ç¬¬ä¸€é¦–æ­Œï¼Œè‡ªåŠ¨é€‰ä¸­
                if (this.songs.length === 1) {
                    this.switchToSong(0);
                }
            }

            updatePlaylist() {
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–DOMæ“ä½œ
                requestAnimationFrame(() => {
                    const modeIcons = {
                        'list': 'ğŸ“‹',
                        'loop': 'ğŸ”', 
                        'single': 'ğŸ”‚',
                        'random': 'ğŸ”€'
                    };
                    this.playlistCount.textContent = `${this.songs.length} é¦–æ­Œæ›² ${modeIcons[this.playMode]}`;
                    
                    if (this.songs.length === 0) {
                        this.playlist.innerHTML = '<div class="empty-playlist">è¿˜æ²¡æœ‰æ­Œæ›²ï¼Œè¯·ä¸Šä¼ LRCæ–‡ä»¶</div>';
                        return;
                    }

                    // ä½¿ç”¨DocumentFragmentå‡å°‘é‡æ’
                    const fragment = document.createDocumentFragment();
                    
                    this.songs.forEach((song, index) => {
                        const songItem = document.createElement('div');
                        songItem.className = `song-item ${index === this.currentSongIndex ? 'current' : ''}`;
                        songItem.dataset.index = index;
                        
                        // è·å–æ­Œæ›²æ¨¡å¼å¹¶æ˜¾ç¤ºç›¸åº”å›¾æ ‡
                        const songMode = this.getSongMode(song);
                        let modeIcon = '';
                        let modeTitle = '';
                        switch(songMode) {
                            case 'sync':
                                modeIcon = 'ğŸµ';
                                modeTitle = 'åŒæ­¥æ¨¡å¼ (éŸ³é¢‘+æ­Œè¯)';
                                break;
                            case 'audio':
                                modeIcon = 'ğŸ¶';
                                modeTitle = 'çº¯éŸ³é¢‘æ¨¡å¼';
                                break;
                            case 'lyrics':
                                modeIcon = 'ğŸ“';
                                modeTitle = 'çº¯æ­Œè¯æ¨¡å¼';
                                break;
                        }
                        
                        songItem.innerHTML = `
                            <div class="drag-handle" title="æ‹–æ‹½æ’åº">â ¿</div>
                            <div class="song-index-num">${index + 1}</div>
                            <div class="song-mode-icon" title="${modeTitle}" style="font-size: 10px; margin-right: 4px;">${modeIcon}</div>
                            <div class="song-name" title="${song.name}">${song.name}</div>
                            <div class="song-duration">${this.formatTime(song.duration)}</div>
                            <div class="song-controls">
                                <button class="song-control-btn delete-btn" data-action="delete" data-index="${index}" title="åˆ é™¤">Ã—</button>
                            </div>
                        `;
                        
                        // è®¾ç½®æ‹–æ‹½å±æ€§
                        songItem.draggable = true;
                        
                        fragment.appendChild(songItem);
                    });

                    this.playlist.innerHTML = '';
                    this.playlist.appendChild(fragment);

                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    this.playlist.querySelectorAll('.song-item').forEach(item => {
                        // ç‚¹å‡»äº‹ä»¶
                        item.addEventListener('click', (e) => {
                            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ­Œæ›²
                            if (e.target.dataset.action === 'delete') {
                                e.stopPropagation();
                                const index = parseInt(e.target.dataset.index);
                                this.removeSong(index);
                                return;
                            }
                            
                            // å¦‚æœç‚¹å‡»çš„æ˜¯æ‹–æ‹½æ‰‹æŸ„ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ­Œæ›²
                            if (e.target.classList.contains('drag-handle')) {
                                e.stopPropagation();
                                return;
                            }
                            
                            const index = parseInt(item.dataset.index);
                            this.switchToSong(index);
                        });
                        
                        // æ‹–æ‹½äº‹ä»¶
                        this.initSongItemDragEvents(item);
                    });

                    console.log('æ’­æ”¾åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œå…±', this.songs.length, 'é¦–æ­Œæ›²');
                });
            }

            initSongItemDragEvents(item) {
                let draggedElement = null;
                
                item.addEventListener('dragstart', (e) => {
                    draggedElement = item;
                    item.classList.add('dragging');
                    
                    // è®¾ç½®æ‹–æ‹½æ•°æ®
                    const dragIndex = parseInt(item.dataset.index);
                    e.dataTransfer.setData('text/plain', dragIndex.toString());
                    e.dataTransfer.effectAllowed = 'move';
                    
                    // å»¶è¿Ÿéšè—åŸå§‹å…ƒç´ ï¼Œé¿å…æ‹–æ‹½å›¾åƒé—®é¢˜
                    setTimeout(() => {
                        if (draggedElement) {
                            draggedElement.style.display = 'none';
                        }
                    }, 0);
                });
                
                item.addEventListener('dragend', (e) => {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement.style.display = '';
                        draggedElement = null;
                    }
                    
                    // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
                    this.playlist.querySelectorAll('.song-item').forEach(songItem => {
                        songItem.classList.remove('drag-over');
                    });
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                item.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (item !== draggedElement) {
                        item.classList.add('drag-over');
                    }
                });
                
                item.addEventListener('dragleave', (e) => {
                    // åªæœ‰å½“ç¦»å¼€çš„æ˜¯æ•´ä¸ªå…ƒç´ æ—¶æ‰ç§»é™¤æ ·å¼
                    if (!item.contains(e.relatedTarget)) {
                        item.classList.remove('drag-over');
                    }
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    if (item === draggedElement) return;
                    
                    const dragIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const dropIndex = parseInt(item.dataset.index);
                    
                    if (dragIndex !== dropIndex) {
                        this.reorderSongs(dragIndex, dropIndex);
                    }
                });
            }

            reorderSongs(fromIndex, toIndex) {
                if (fromIndex === toIndex) return;
                
                // ç§»åŠ¨æ­Œæ›²
                const movedSong = this.songs.splice(fromIndex, 1)[0];
                this.songs.splice(toIndex, 0, movedSong);
                
                // æ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•
                if (this.currentSongIndex === fromIndex) {
                    // å½“å‰æ’­æ”¾çš„æ­Œæ›²è¢«ç§»åŠ¨äº†
                    this.currentSongIndex = toIndex;
                } else if (this.currentSongIndex > fromIndex && this.currentSongIndex <= toIndex) {
                    // å½“å‰æ’­æ”¾çš„æ­Œæ›²ç´¢å¼•éœ€è¦å‡1
                    this.currentSongIndex--;
                } else if (this.currentSongIndex < fromIndex && this.currentSongIndex >= toIndex) {
                    // å½“å‰æ’­æ”¾çš„æ­Œæ›²ç´¢å¼•éœ€è¦åŠ 1
                    this.currentSongIndex++;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                this.updatePlaylist();
                this.updateSongDisplay();
                
                console.log(`æ­Œæ›²ä»ä½ç½® ${fromIndex + 1} ç§»åŠ¨åˆ°ä½ç½® ${toIndex + 1}`);
                this.showNotification(`æ­Œæ›²å·²ç§»åŠ¨åˆ°ç¬¬ ${toIndex + 1} ä½`, 'success');
            }

            switchToSong(index) {
                if (index < 0 || index >= this.songs.length) return;
                
                // åœæ­¢å½“å‰æ’­æ”¾
                this.pause();
                
                // åˆ‡æ¢æ­Œæ›²
                this.currentSongIndex = index;
                this.currentLyricIndex = -1;
                this.currentTime = 0;
                this.pausedTime = 0;
                // æ¸…ç©ºæ­Œè¯ç¼“å­˜
                this.lyricsCache.clear();
                
                // å¦‚æœæ˜¯éšæœºæ’­æ”¾æ¨¡å¼ä¸”ä¸æ˜¯é€šè¿‡getRandomSongIndexé€‰æ‹©çš„ï¼Œéœ€è¦è®°å½•åˆ°å†å²ä¸­
                if (this.playMode === 'random' && !this.playHistory.includes(index)) {
                    this.playHistory.push(index);
                }
                
                // åˆ‡æ¢æ­Œæ›²æ—¶æ¸…ç©ºæœç´¢ç»“æœ
                this.clearSearch();

                const currentSong = this.songs[this.currentSongIndex];
                const songMode = this.getSongMode(currentSong);
                
                // æ ¹æ®æ¨¡å¼è®¾ç½®éŸ³é¢‘å…ƒç´ 
                if (songMode === 'sync' || songMode === 'audio') {
                    this.audioElement = currentSong.audioElement;
                    this.audioMode = (songMode === 'sync');
                } else {
                    this.audioMode = false;
                }
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                this.updateSongDisplay();
                this.updatePlaylist();
                this.updateLyricsDisplay();
                // ç¡®ä¿è¿›åº¦æ¡é‡ç½®åˆ°0
                this.progressBar.style.width = '0%';
                this.updateProgress();
                this.updateAudioMode();
                
                // æ ¹æ®æ¨¡å¼é‡ç½®æ˜¾ç¤ºå†…å®¹
                if (songMode === 'audio') {
                    this.showLyrics('â™ª éŸ³é¢‘å‡†å¤‡æ’­æ”¾ â™ª', '');
                } else if (currentSong.lyrics && currentSong.lyrics.length > 0) {
                    this.showLyrics(currentSong.lyrics[0].text, 
                                  currentSong.lyrics.length > 1 ? currentSong.lyrics[1].text : '');
                } else {
                    this.showLyrics('â™ª', '');
                }
                
                this.playButton.disabled = false;
                this.totalTimeSpan.textContent = this.formatTime(currentSong.duration);
                
                console.log('åˆ‡æ¢åˆ°æ­Œæ›²:', currentSong.name, `(${songMode}æ¨¡å¼)`);
            }

            switchToNextSong() {
                if (this.currentSongIndex < this.songs.length - 1) {
                    this.switchToSong(this.currentSongIndex + 1);
                    // åˆ‡æ¢æ­Œæ›²åè‡ªåŠ¨æ’­æ”¾
                    const timerId = setTimeout(() => {
                        this.play();
                    }, 100);
                    this.addTimer(timerId);
                }
            }

            onSongEnded() {
                this.pause();
                console.log('æ­Œæ›²æ’­æ”¾å®Œæˆ:', this.songs[this.currentSongIndex].name);
                
                // æ ¹æ®æ’­æ”¾æ¨¡å¼å†³å®šä¸‹ä¸€æ­¥åŠ¨ä½œ
                const nextIndex = this.getNextSongIndex();
                
                if (nextIndex >= 0) {
                    console.log(`æ’­æ”¾æ¨¡å¼: ${this.playMode}, å‡†å¤‡æ’­æ”¾ä¸‹ä¸€é¦–`);
                    const timerId = setTimeout(() => {
                        if (nextIndex === this.currentSongIndex && this.playMode === 'single') {
                            // å•æ›²å¾ªç¯ï¼šé‡ç½®åˆ°å¼€å¤´ç»§ç»­æ’­æ”¾
                            this.setCurrentTime(0);
                            this.play();
                        } else {
                            // åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–æ­Œæ›²
                            this.switchToSong(nextIndex);
                            const playTimerId = setTimeout(() => {
                                this.play();
                            }, 100);
                            this.addTimer(playTimerId);
                        }
                    }, 500); // å»¶è¿Ÿ500msï¼Œè®©ç”¨æˆ·çœ‹åˆ°å½“å‰æ­Œæ›²å·²å®Œæˆ
                    this.addTimer(timerId);
                } else {
                    console.log('æ’­æ”¾åˆ—è¡¨å·²ç»“æŸ');
                    this.showNotification('æ’­æ”¾åˆ—è¡¨å·²ç»“æŸ', 'info');
                }
            }

            switchToPreviousSong() {
                if (this.currentSongIndex > 0) {
                    this.switchToSong(this.currentSongIndex - 1);
                    // åˆ‡æ¢æ­Œæ›²åè‡ªåŠ¨æ’­æ”¾
                    const timerId = setTimeout(() => {
                        this.play();
                    }, 100);
                    this.addTimer(timerId);
                }
            }

            removeSong(index) {
                if (index < 0 || index >= this.songs.length) return;
                
                console.log('åˆ é™¤æ­Œæ›²:', this.songs[index].name);
                
                // æ¸…ç†æ­Œè¯ç¼“å­˜
                this.lyricsCache.clear();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²
                if (index === this.currentSongIndex) {
                    this.pause();
                    this.currentSongIndex = -1;
                    this.showLyrics('â™ª', '');
                    this.updateSongDisplay();
                    this.playButton.disabled = true;
                } else if (index < this.currentSongIndex) {
                    // å¦‚æœåˆ é™¤çš„æ­Œæ›²åœ¨å½“å‰æ­Œæ›²ä¹‹å‰ï¼Œè°ƒæ•´ç´¢å¼•
                    this.currentSongIndex--;
                }
                
                // åˆ é™¤æ­Œæ›²
                this.songs.splice(index, 1);
                
                // æ›´æ–°æ’­æ”¾åˆ—è¡¨
                this.updatePlaylist();
                this.updateStatusIndicator();
                
                // å¦‚æœæ²¡æœ‰æ­Œæ›²äº†
                if (this.songs.length === 0) {
                    this.currentSongIndex = -1;
                    this.showLyrics('è¯·ä¸Šä¼ LRCæ­Œè¯æ–‡ä»¶', 'å¼€å§‹ä½ çš„æ¼”å‡º');
                    this.songInfo.style.display = 'none';
                    this.currentSongInfo.style.display = 'none';
                    this.playButton.disabled = true;
                }
            }

            updateSongDisplay() {
                if (this.currentSongIndex >= 0 && this.currentSongIndex < this.songs.length) {
                    const currentSong = this.songs[this.currentSongIndex];
                    
                    // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤º
                    this.displaySongTitle.textContent = currentSong.name;
                    this.displaySongIndex.textContent = `${this.currentSongIndex + 1} / ${this.songs.length}`;
                    this.songInfo.style.display = 'block';
                    
                    // æ›´æ–°æ§åˆ¶é¢æ¿æ˜¾ç¤º
                    this.currentSongName.textContent = currentSong.name;
                    this.currentSongStatus.textContent = this.isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ';
                    this.currentSongInfo.style.display = 'block';
                } else {
                    this.songInfo.style.display = 'none';
                    this.currentSongInfo.style.display = 'none';
                }
            }

            updateStatusIndicator() {
                if (this.songs.length === 0) {
                    this.statusIndicator.className = 'status-indicator';
                } else if (this.isPlaying) {
                    this.statusIndicator.className = 'status-indicator playing';
                } else {
                    this.statusIndicator.className = 'status-indicator ready';
                }
            }

            showLyrics(current, next = '') {
                // é¿å…ä¸å¿…è¦çš„DOMæ›´æ–°
                if (this.currentLyricEl.textContent !== current) {
                    // ä½¿ç”¨documentFragmentå‡å°‘é‡æ’
                    const fragment = document.createDocumentFragment();
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = current;
                    fragment.appendChild(tempDiv);
                    
                    // æ‰¹é‡æ›´æ–°DOM
                    requestAnimationFrame(() => {
                        this.currentLyricEl.textContent = current;
                        this.nextLyricEl.textContent = next;
                        
                        // æ·»åŠ å…¥åœºåŠ¨ç”»
                        this.currentLyricEl.classList.remove('entering');
                        // ä½¿ç”¨requestAnimationFrameç¡®ä¿åŠ¨ç”»æ­£å¸¸æ‰§è¡Œ
                        requestAnimationFrame(() => {
                            this.currentLyricEl.classList.add('entering');
                        });
                    });
                }
            }

            togglePlay() {
                if (this.currentSongIndex < 0 || this.currentSongIndex >= this.songs.length) {
                    console.log('æ²¡æœ‰é€‰æ‹©æœ‰æ•ˆæ­Œæ›²');
                    return;
                }
                
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            play() {
                if (this.currentSongIndex < 0 || this.currentSongIndex >= this.songs.length) {
                    this.showNotification('è¯·å…ˆé€‰æ‹©ä¸€é¦–æ­Œæ›²', 'warning');
                    return;
                }
                
                const currentSong = this.songs[this.currentSongIndex];
                const songMode = this.getSongMode(currentSong);
                
                // å¦‚æœæ’­æ”¾å®Œæˆï¼Œé‡ç½®åˆ°å¼€å¤´
                const maxDuration = songMode === 'sync' && this.audioElement ? this.audioElement.duration : currentSong.duration;
                if (this.currentTime >= maxDuration) {
                    this.currentTime = 0;
                    this.pausedTime = 0;
                }
                
                this.isPlaying = true;
                this.playButton.textContent = 'â¸';
                
                if (songMode === 'sync' && this.audioElement) {
                    // åŒæ­¥æ¨¡å¼ï¼šéŸ³é¢‘+æ­Œè¯åŒæ­¥æ’­æ”¾
                    this.audioMode = true;
                    this.audioElement.currentTime = Math.max(0, this.currentTime - this.audioOffset);
                    this.audioElement.play().catch(e => {
                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                        this.showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œåˆ‡æ¢åˆ°çº¯æ­Œè¯æ¨¡å¼', 'error');
                        this.audioMode = false;
                        this.updateAudioMode();
                        // åˆ‡æ¢åˆ°çº¯æ­Œè¯è‡ªåŠ¨æ’­æ”¾
                        this.startTime = performance.now() - (this.pausedTime * 1000);
                        this.animate();
                    });
                } else if (songMode === 'audio' && this.audioElement) {
                    // çº¯éŸ³é¢‘æ¨¡å¼ï¼šåªæ’­æ”¾éŸ³é¢‘ï¼Œä¸æ˜¾ç¤ºæ­Œè¯
                    this.audioMode = true;
                    this.audioElement.currentTime = Math.max(0, this.currentTime);
                    this.audioElement.play().catch(e => {
                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                        this.showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥', 'error');
                        this.audioMode = false;
                        this.pause();
                        return;
                    });
                    // çº¯éŸ³é¢‘æ¨¡å¼ä¸‹éšè—æ­Œè¯æˆ–æ˜¾ç¤ºéŸ³ä¹ç¬¦å·
                    this.showLyrics('â™ª éŸ³ä¹æ’­æ”¾ä¸­ â™ª', '');
                } else {
                    // çº¯æ­Œè¯æ¨¡å¼ï¼šæ”¯æŒæ‰‹åŠ¨æ—¶é—´çº¿æ§åˆ¶æˆ–è‡ªåŠ¨æ’­æ”¾
                    this.audioMode = false;
                    if (songMode === 'lyrics') {
                        // ä¸ºä¹é˜Ÿç°åœºæ¼”å‡ºæä¾›æ‰‹åŠ¨æ§åˆ¶é€‰é¡¹
                        this.startTime = performance.now() - (this.pausedTime * 1000);
                        this.animate();
                        this.showNotification('çº¯æ­Œè¯æ¨¡å¼ï¼šä½¿ç”¨è¿›åº¦æ¡æ‰‹åŠ¨æ§åˆ¶æ—¶é—´çº¿', 'info');
                    }
                }
                
                this.updateStatusIndicator();
                this.updateSongDisplay();
                this.updateAudioMode();
                
                console.log('å¼€å§‹æ’­æ”¾:', currentSong.name, `(${songMode}æ¨¡å¼)`);
            }

            pause() {
                this.isPlaying = false;
                this.playButton.textContent = 'â–¶';
                this.pausedTime = this.currentTime;
                
                if (this.audioMode && this.audioElement) {
                    this.audioElement.pause();
                }
                
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                
                this.updateStatusIndicator();
                this.updateSongDisplay();
                
                console.log('æš‚åœæ’­æ”¾');
            }

            animate() {
                if (!this.isPlaying || this.audioMode) return; // éŸ³é¢‘æ¨¡å¼ä¸‹ä¸ä½¿ç”¨è¿™ä¸ªåŠ¨ç”»å¾ªç¯

                const now = performance.now();
                this.currentTime = ((now - this.startTime) / 1000) * this.playbackSpeed;

                const currentSong = this.songs[this.currentSongIndex];
                if (this.currentTime >= currentSong.duration) {
                    this.currentTime = currentSong.duration;
                    this.onSongEnded();
                    return;
                }

                // èŠ‚æµè¿›åº¦æ›´æ–° - æ¯100msæ›´æ–°ä¸€æ¬¡
                if (now - this.lastProgressUpdate > 100) {
                    this.updateProgress();
                    this.lastProgressUpdate = now;
                }
                
                // èŠ‚æµæ­Œè¯æ›´æ–° - æ¯50msæ£€æŸ¥ä¸€æ¬¡
                if (now - this.lastLyricsUpdate > 50) {
                    this.updateLyricsDisplay();
                    this.lastLyricsUpdate = now;
                }

                this.animationId = requestAnimationFrame(() => this.animate());
            }

            setCurrentTime(time) {
                if (this.currentSongIndex < 0) return;
                
                const currentSong = this.songs[this.currentSongIndex];
                const maxDuration = this.audioMode && this.audioElement ? this.audioElement.duration : currentSong.duration;
                this.currentTime = Math.max(0, Math.min(time, maxDuration));
                this.pausedTime = this.currentTime;
                
                if (this.audioMode && this.audioElement) {
                    this.audioElement.currentTime = Math.max(0, this.currentTime - this.audioOffset);
                } else if (this.isPlaying) {
                    this.startTime = performance.now() - (this.currentTime * 1000 / this.playbackSpeed);
                }
                
                // å¼ºåˆ¶æ›´æ–°è¿›åº¦æ¡å’Œæ­Œè¯æ˜¾ç¤º
                requestAnimationFrame(() => {
                    this.updateProgress();
                    this.updateLyricsDisplay();
                });
            }

            seek(seconds) {
                this.setCurrentTime(this.currentTime + seconds);
            }

            seekTo(e) {
                if (this.currentSongIndex < 0) return;
                
                const rect = this.progressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                const currentSong = this.songs[this.currentSongIndex];
                const newTime = (clickX / width) * currentSong.duration;
                this.setCurrentTime(newTime);
            }

            setPlaybackSpeed(speed) {
                document.querySelectorAll('.speed-button').forEach(btn => {
                    btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
                });

                if (this.isPlaying) {
                    const elapsed = this.currentTime;
                    this.playbackSpeed = speed;
                    this.startTime = performance.now() - (elapsed * 1000 / speed);
                } else {
                    this.playbackSpeed = speed;
                }
                
                console.log('æ’­æ”¾é€Ÿåº¦è®¾ç½®ä¸º:', speed + 'x');
            }
            
            setFontScale(scale) {
                this.fontScale = Math.max(0.5, Math.min(3, scale));
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.font-size-button').forEach(btn => {
                    btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.fontSize) - this.fontScale) < 0.01);
                });
                
                this.updateLyricsFontSize();
                console.log('å­—ä½“å¤§å°è®¾ç½®ä¸º:', this.fontScale + 'x');
            }
            
            adjustFontSize(delta) {
                this.setFontScale(this.fontScale + delta);
            }
            
            updateLyricsFontSize() {
                // ä½¿ç”¨CSSå˜é‡æ¥åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                document.documentElement.style.setProperty('--font-scale', this.fontScale);
            }
            
            setTheme(theme) {
                this.currentTheme = theme;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.theme-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
                
                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                document.body.classList.remove('theme-classic', 'theme-gold', 'theme-blue', 'theme-rainbow');
                // æ·»åŠ æ–°ä¸»é¢˜ç±»
                document.body.classList.add(`theme-${theme}`);
                
                console.log('ä¸»é¢˜è®¾ç½®ä¸º:', theme);
            }
            
            switchTheme() {
                const themes = ['classic', 'gold', 'blue', 'rainbow'];
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextIndex = (currentIndex + 1) % themes.length;
                this.setTheme(themes[nextIndex]);
            }
            
            setPlayMode(mode) {
                this.playMode = mode;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.play-mode-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // æ¸…ç©ºéšæœºæ’­æ”¾å†å²
                if (mode === 'random') {
                    this.playHistory = [];
                }
                
                let modeNames = {
                    'list': 'åˆ—è¡¨æ’­æ”¾',
                    'loop': 'åˆ—è¡¨å¾ªç¯',
                    'single': 'å•æ›²å¾ªç¯',
                    'random': 'éšæœºæ’­æ”¾'
                };
                
                console.log('æ’­æ”¾æ¨¡å¼è®¾ç½®ä¸º:', modeNames[mode]);
                this.showNotification(`æ’­æ”¾æ¨¡å¼: ${modeNames[mode]}`, 'info');
            }
            
            switchPlayMode() {
                const modes = ['list', 'loop', 'single', 'random'];
                const currentIndex = modes.indexOf(this.playMode);
                const nextIndex = (currentIndex + 1) % modes.length;
                this.setPlayMode(modes[nextIndex]);
            }
            
            
            getNextSongIndex() {
                if (this.songs.length === 0) return -1;
                
                switch (this.playMode) {
                    case 'single':
                        // å•æ›²å¾ªç¯ï¼šè¿”å›å½“å‰æ­Œæ›²ç´¢å¼•
                        return this.currentSongIndex;
                    
                    case 'loop':
                        // åˆ—è¡¨å¾ªç¯ï¼šåˆ°æœ€åä¸€é¦–åå›åˆ°ç¬¬ä¸€é¦–
                        return this.currentSongIndex >= this.songs.length - 1 ? 0 : this.currentSongIndex + 1;
                    
                    case 'random':
                        // éšæœºæ’­æ”¾ï¼šéšæœºé€‰æ‹©ä¸€é¦–æœªæ’­æ”¾çš„æ­Œæ›²
                        return this.getRandomSongIndex();
                    
                    case 'list':
                    default:
                        // åˆ—è¡¨æ’­æ”¾ï¼šé¡ºåºæ’­æ”¾ï¼Œæœ€åä¸€é¦–ç»“æŸ
                        return this.currentSongIndex >= this.songs.length - 1 ? -1 : this.currentSongIndex + 1;
                }
            }
            
            getRandomSongIndex() {
                if (this.songs.length === 0) return -1;
                if (this.songs.length === 1) return 0;
                
                // å¦‚æœæ‰€æœ‰æ­Œæ›²éƒ½æ’­æ”¾è¿‡äº†ï¼Œæ¸…ç©ºå†å²è®°å½•é‡æ–°å¼€å§‹
                if (this.playHistory.length >= this.songs.length) {
                    this.playHistory = [];
                }
                
                // è·å–æœªæ’­æ”¾è¿‡çš„æ­Œæ›²ç´¢å¼•
                const unplayedIndexes = [];
                for (let i = 0; i < this.songs.length; i++) {
                    if (!this.playHistory.includes(i)) {
                        unplayedIndexes.push(i);
                    }
                }
                
                if (unplayedIndexes.length === 0) {
                    // æ‰€æœ‰æ­Œæ›²éƒ½æ’­æ”¾è¿‡ï¼Œé‡æ–°å¼€å§‹
                    this.playHistory = [];
                    return Math.floor(Math.random() * this.songs.length);
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªæœªæ’­æ”¾çš„æ­Œæ›²
                const randomIndex = Math.floor(Math.random() * unplayedIndexes.length);
                const selectedIndex = unplayedIndexes[randomIndex];
                
                // è®°å½•åˆ°æ’­æ”¾å†å²
                this.playHistory.push(selectedIndex);
                
                return selectedIndex;
            }
            
            searchLyrics(query) {
                const searchResults = document.getElementById('searchResults');
                
                if (!query.trim()) {
                    this.clearSearch();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰é€‰ä¸­çš„æ­Œæ›²
                if (this.currentSongIndex < 0 || this.currentSongIndex >= this.songs.length) {
                    searchResults.innerHTML = '<div class="search-result-item">è¯·å…ˆé€‰æ‹©ä¸€é¦–æ­Œæ›²</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                this.searchResults = [];
                const currentSong = this.songs[this.currentSongIndex];
                
                // åªåœ¨å½“å‰æ­Œæ›²ä¸­æœç´¢
                if (currentSong.lyrics && currentSong.lyrics.length > 0) {
                    currentSong.lyrics.forEach((lyric, lyricIndex) => {
                        if (lyric.text.toLowerCase().includes(query.toLowerCase())) {
                            this.searchResults.push({
                                songIndex: this.currentSongIndex,
                                lyricIndex,
                                songName: currentSong.name,
                                time: lyric.time,
                                text: lyric.text
                            });
                        }
                    });
                }
                
                this.displaySearchResults(query);
            }
            
            displaySearchResults(query) {
                const searchResults = document.getElementById('searchResults');
                
                if (this.searchResults.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">åœ¨å½“å‰æ­Œæ›²ä¸­æœªæ‰¾åˆ°ç›¸å…³æ­Œè¯</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                const resultsHtml = this.searchResults.map(result => {
                    // é«˜äº®æœç´¢å…³é”®è¯
                    const highlightedText = result.text.replace(
                        new RegExp(query, 'gi'),
                        match => `<span class="search-highlight">${match}</span>`
                    );
                    
                    return `
                        <div class="search-result-item" 
                             data-song-index="${result.songIndex}" 
                             data-lyric-index="${result.lyricIndex}"
                             data-time="${result.time}">
                            <span class="search-result-time">${this.formatTime(result.time)}</span>
                            <span class="search-result-text">${highlightedText}</span>
                        </div>
                    `;
                }).join('');
                
                searchResults.innerHTML = resultsHtml;
                searchResults.style.display = 'block';
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const time = parseFloat(item.dataset.time);
                        
                        // è·³è½¬åˆ°æŒ‡å®šæ—¶é—´å¹¶å¼€å§‹æ’­æ”¾
                        this.setCurrentTime(time);
                        
                        // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œåˆ™å¼€å§‹æ’­æ”¾
                        if (!this.isPlaying) {
                            const timerId = setTimeout(() => {
                                this.play();
                            }, 100);
                            this.addTimer(timerId);
                        }
                        
                        this.clearSearch();
                        this.showNotification(`è·³è½¬åˆ°: ${this.formatTime(time)}`, 'success');
                    });
                });
                
                console.log(`åœ¨å½“å‰æ­Œæ›²ä¸­æœç´¢åˆ° ${this.searchResults.length} æ¡ç»“æœ`);
            }
            
            clearSearch() {
                const searchResults = document.getElementById('searchResults');
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
                this.searchResults = [];
            }
            
            // å†…å­˜ç®¡ç†æ–¹æ³•
            cleanupAudio() {
                if (this.audioElement) {
                    this.audioElement.pause();
                    this.audioElement.removeEventListener('loadedmetadata', () => {});
                    this.audioElement.removeEventListener('error', () => {});
                    this.audioElement.removeEventListener('timeupdate', () => {});
                    this.audioElement.removeEventListener('ended', () => {});
                    
                    // é‡Šæ”¾URLå¯¹è±¡
                    if (this.audioElement.src && this.audioElement.src.startsWith('blob:')) {
                        this.revokeObjectUrl(this.audioElement.src);
                    }
                    
                    this.audioElement.src = '';
                    this.audioElement.load();
                    this.audioElement = null;
                }
            }
            
            revokeObjectUrl(url) {
                if (this.objectUrls.has(url)) {
                    URL.revokeObjectURL(url);
                    this.objectUrls.delete(url);
                    console.log('é‡Šæ”¾å¯¹è±¡URL:', url);
                }
            }
            
            addTimer(timerId) {
                this.timers.add(timerId);
            }
            
            clearTimer(timerId) {
                if (this.timers.has(timerId)) {
                    clearTimeout(timerId);
                    this.timers.delete(timerId);
                }
            }
            
            cleanup() {
                console.log('æ¸…ç†èµ„æº...');
                
                // æ¸…ç†åŠ¨ç”»å¸§
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                // æ¸…ç†éŸ³é¢‘èµ„æº
                this.cleanupAudio();
                
                // æ¸…ç†æ‰€æœ‰URLå¯¹è±¡
                this.objectUrls.forEach(url => {
                    URL.revokeObjectURL(url);
                });
                this.objectUrls.clear();
                
                // æ¸…ç†å®šæ—¶å™¨
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                });
                this.timers.clear();
                
                // æ¸…ç†ç¼“å­˜
                this.lyricsCache.clear();
                this.searchResults = [];
                
                console.log('èµ„æºæ¸…ç†å®Œæˆ');
            }
            
            // é€šçŸ¥ç³»ç»Ÿ
            showNotification(message, type = 'info', duration = 3000) {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                // è‡ªåŠ¨ç§»é™¤
                const timerId = setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, duration);
                this.addTimer(timerId);
                
                // ç‚¹å‡»å…³é—­
                notification.addEventListener('click', () => {
                    this.clearTimer(timerId);
                    if (notification.parentNode) {
                        notification.style.animation = 'fadeOut 0.2s ease forwards';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 200);
                    }
                });
            }

            updateProgress() {
                if (this.currentSongIndex < 0) return;
                
                const currentSong = this.songs[this.currentSongIndex];
                const maxDuration = this.audioMode && this.audioElement ? this.audioElement.duration : currentSong.duration;
                
                // å¤„ç†æ— æ•ˆæ—¶é•¿çš„æƒ…å†µ
                if (!maxDuration || maxDuration <= 0 || isNaN(maxDuration)) {
                    this.progressBar.style.width = '0%';
                    this.currentTimeSpan.textContent = this.formatTime(this.currentTime);
                    this.totalTimeSpan.textContent = '0:00';
                    return;
                }
                
                const progress = (this.currentTime / maxDuration) * 100;
                const progressPercent = Math.max(0, Math.min(progress, 100));
                
                // ç›´æ¥è®¾ç½®widthè€Œä¸æ˜¯ä½¿ç”¨transform
                this.progressBar.style.width = `${progressPercent}%`;
                this.currentTimeSpan.textContent = this.formatTime(this.currentTime);
                this.totalTimeSpan.textContent = this.formatTime(maxDuration);
            }

            updateLyricsDisplay() {
                if (this.currentSongIndex < 0) return;
                
                const currentSong = this.songs[this.currentSongIndex];
                const lyrics = currentSong.lyrics;
                
                if (lyrics.length === 0) {
                    this.showLyrics('æ— æ­Œè¯', '');
                    return;
                }

                // ä½¿ç”¨ç¼“å­˜çš„æ­Œè¯ç´¢å¼•è®¡ç®—
                const cacheKey = `${this.currentSongIndex}-${Math.floor(this.currentTime * 10)}`;
                let activeIndex;
                
                if (this.lyricsCache.has(cacheKey)) {
                    activeIndex = this.lyricsCache.get(cacheKey);
                } else {
                    activeIndex = -1;
                    for (let i = 0; i < lyrics.length; i++) {
                        if (this.currentTime >= lyrics[i].time) {
                            activeIndex = i;
                        } else {
                            break;
                        }
                    }
                    // ç¼“å­˜ç»“æœï¼Œé™åˆ¶ç¼“å­˜å¤§å°
                    if (this.lyricsCache.size > 1000) {
                        const firstKey = this.lyricsCache.keys().next().value;
                        this.lyricsCache.delete(firstKey);
                    }
                    this.lyricsCache.set(cacheKey, activeIndex);
                }

                if (activeIndex !== this.currentLyricIndex) {
                    this.currentLyricIndex = activeIndex;
                    
                    const currentLyric = activeIndex >= 0 ? lyrics[activeIndex].text : 'å‡†å¤‡å¼€å§‹...';
                    const nextLyric = activeIndex >= 0 && activeIndex < lyrics.length - 1 
                        ? lyrics[activeIndex + 1].text 
                        : '';
                    
                    this.showLyrics(currentLyric, nextLyric);
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                    });
                } else {
                    document.exitFullscreen().catch(err => {
                        console.log('æ— æ³•é€€å‡ºå…¨å±æ¨¡å¼:', err);
                    });
                }
            }

            formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            // æ’­æ”¾åˆ—è¡¨ç®¡ç†
            exportPlaylist() {
                if (this.songs.length === 0) {
                    this.showNotification('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'warning');
                    return;
                }
                
                const playlistData = {
                    version: '1.0',
                    exportTime: new Date().toISOString(),
                    songs: this.songs.map(song => ({
                        name: song.name,
                        lyrics: song.lyrics,
                        duration: song.duration
                    }))
                };
                
                const dataStr = JSON.stringify(playlistData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                this.objectUrls.add(url);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `æ­Œè¯æ’­æ”¾åˆ—è¡¨_${new Date().toLocaleDateString()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification(`å·²å¯¼å‡º ${this.songs.length} é¦–æ­Œæ›²çš„æ’­æ”¾åˆ—è¡¨`, 'success');
            }
            
            importPlaylist(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const playlistData = JSON.parse(e.target.result);
                        
                        if (!playlistData.songs || !Array.isArray(playlistData.songs)) {
                            throw new Error('æ— æ•ˆçš„æ’­æ”¾åˆ—è¡¨æ ¼å¼');
                        }
                        
                        // éªŒè¯æ­Œæ›²æ•°æ®
                        const validSongs = playlistData.songs.filter(song => {
                            return song.name && song.lyrics && Array.isArray(song.lyrics);
                        });
                        
                        if (validSongs.length === 0) {
                            throw new Error('æ’­æ”¾åˆ—è¡¨ä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ­Œæ›²æ•°æ®');
                        }
                        
                        // æ¸…ç©ºå½“å‰æ’­æ”¾åˆ—è¡¨
                        this.songs = [];
                        this.currentSongIndex = -1;
                        this.pause();
                        
                        // æ·»åŠ å¯¼å…¥çš„æ­Œæ›²
                        validSongs.forEach(songData => {
                            this.addSong({
                                name: songData.name,
                                lyrics: songData.lyrics,
                                duration: songData.duration || 0
                            });
                        });
                        
                        this.showNotification(`æˆåŠŸå¯¼å…¥ ${validSongs.length} é¦–æ­Œæ›²`, 'success');
                        
                    } catch (error) {
                        console.error('å¯¼å…¥æ’­æ”¾åˆ—è¡¨å¤±è´¥:', error);
                        this.showNotification(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = () => {
                    this.showNotification('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                };
                
                reader.readAsText(file, 'UTF-8');
            }
            
            clearPlaylist() {
                if (this.songs.length === 0) {
                    this.showNotification('æ’­æ”¾åˆ—è¡¨å·²ç»ä¸ºç©º', 'info');
                    return;
                }
                
                if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${this.songs.length} é¦–æ­Œæ›²å—ï¼Ÿ`)) {
                    this.pause();
                    this.songs = [];
                    this.currentSongIndex = -1;
                    this.updatePlaylist();
                    this.updateStatusIndicator();
                    this.showLyrics('è¯·ä¸Šä¼ LRCæ­Œè¯æ–‡ä»¶', 'å¼€å§‹ä½ çš„æ¼”å‡º');
                    this.songInfo.style.display = 'none';
                    this.currentSongInfo.style.display = 'none';
                    this.playButton.disabled = true;
                    this.showNotification('æ’­æ”¾åˆ—è¡¨å·²æ¸…ç©º', 'success');
                }
            }
            
            // åŒæ­¥æ ¡å‡†åŠŸèƒ½
            adjustOffset(delta) {
                if (!this.audioMode) {
                    this.showNotification('ä»…åœ¨éŸ³é¢‘åŒæ­¥æ¨¡å¼ä¸‹å¯ç”¨', 'warning');
                    return;
                }
                
                this.audioOffset += delta;
                this.audioOffset = Math.round(this.audioOffset * 10) / 10; // ä¿ç•™ä¸€ä½å°æ•°
                this.updateOffsetDisplay();
                
                console.log('éŸ³é¢‘åç§»è°ƒæ•´ä¸º:', this.audioOffset, 'ç§’');
            }
            
            resetOffset() {
                if (!this.audioMode) {
                    this.showNotification('ä»…åœ¨éŸ³é¢‘åŒæ­¥æ¨¡å¼ä¸‹å¯ç”¨', 'warning');
                    return;
                }
                
                this.audioOffset = 0;
                this.updateOffsetDisplay();
                this.showNotification('åŒæ­¥åç§»å·²é‡ç½®', 'success');
            }
            
            updateOffsetDisplay() {
                const offsetDisplay = document.getElementById('offsetDisplay');
                if (offsetDisplay) {
                    const sign = this.audioOffset >= 0 ? '+' : '';
                    offsetDisplay.textContent = `${sign}${this.audioOffset.toFixed(1)}s`;
                }
            }
            
            // æ–‡ä»¶åŒ¹é…å’Œæ’­æ”¾æ¨¡å¼ç®¡ç†
            findMatchingSong(fileName) {
                // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
                let matchedSong = this.songs.find(song => song.name === fileName);
                if (matchedSong) return matchedSong;
                
                // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                return this.songs.find(song => this.fuzzyMatch(song.name, fileName));
            }
            
            fuzzyMatch(songName, targetName) {
                // æ ‡å‡†åŒ–æ–‡ä»¶åï¼šå»é™¤æ–‡ä»¶æ‰©å±•åã€æ•°å­—å‰ç¼€ã€ç‰¹æ®Šå­—ç¬¦
                const normalize = (name) => {
                    return name
                        .replace(/\.[^.]*$/, '') // å»é™¤æ‰©å±•å
                        .replace(/^\d+[-_\s]*/, '') // å»é™¤æ•°å­—å‰ç¼€ (å¦‚ "01_", "1-", "001 ")
                        .replace(/[-_\s]+/g, '') // å»é™¤è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ã€ç©ºæ ¼
                        .toLowerCase() // è½¬å°å†™
                        .trim();
                };
                
                const normalizedSong = normalize(songName);
                const normalizedTarget = normalize(targetName);
                
                // å®Œå…¨åŒ¹é…
                if (normalizedSong === normalizedTarget) return true;
                
                // åŒ…å«åŒ¹é…ï¼ˆæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼‰
                if (normalizedSong.includes(normalizedTarget) || normalizedTarget.includes(normalizedSong)) {
                    return true;
                }
                
                // ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆä½¿ç”¨ç®€å•çš„ç¼–è¾‘è·ç¦»ç®—æ³•ï¼‰
                const similarity = this.calculateSimilarity(normalizedSong, normalizedTarget);
                return similarity > 0.8; // 80%ä»¥ä¸Šç›¸ä¼¼åº¦è®¤ä¸ºåŒ¹é…
            }
            
            calculateSimilarity(str1, str2) {
                if (str1 === str2) return 1;
                if (str1.length === 0 || str2.length === 0) return 0;
                
                const maxLength = Math.max(str1.length, str2.length);
                const editDistance = this.levenshteinDistance(str1, str2);
                return (maxLength - editDistance) / maxLength;
            }
            
            levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // substitution
                                matrix[i][j - 1] + 1,     // insertion
                                matrix[i - 1][j] + 1      // deletion
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }
            
            getSongMode(song) {
                if (song.mode) return song.mode;
                if (song.audioFile && song.lyrics && song.lyrics.length > 0) return 'sync';
                if (song.audioFile) return 'audio';
                return 'lyrics';
            }
            
            updateSongMode(song) {
                song.mode = this.getSongMode(song);
                return song.mode;
            }
        }

        // åˆå§‹åŒ–æ’­æ”¾å™¨
        document.addEventListener('DOMContentLoaded', () => {
            player = new LEDLyricsPlayer();
            console.log('LEDæ­Œè¯æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>